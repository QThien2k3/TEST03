<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Door Security Dashboard v4.2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --background: #0a0e27;
            --surface: #151c3d;
            --surface-light: #1e2951;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --border: #2a3660;
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background Particles */
        .bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        /* Alert Container */
        #alertContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            width: 400px;
            max-width: calc(100vw - 40px);
            pointer-events: none;
        }

        #alertContainer .alert {
            pointer-events: all;
            margin-bottom: 10px;
            transform: translateX(100%);
            animation: slideInRight 0.3s ease forwards;
            padding: 16px 20px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--surface);
            border: 1px solid;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        @keyframes slideInRight {
            to { transform: translateX(0); }
        }

        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: currentColor;
        }

        .alert-success { border-color: var(--success-color); color: var(--success-color); }
        .alert-warning { border-color: var(--warning-color); color: var(--warning-color); }
        .alert-danger { border-color: var(--danger-color); color: var(--danger-color); }
        .alert-info { border-color: var(--primary-color); color: var(--primary-color); }

        .alert-close {
            margin-left: auto;
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 20px;
            opacity: 0.7;
            padding: 4px;
            border-radius: 4px;
        }

        .alert-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            background: var(--surface);
            border: 1px solid var(--border);
            z-index: 1000;
        }

        .connection-status.connected {
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .connection-status.disconnected {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        /* Security Status */
        .security-status {
            position: fixed;
            top: 70px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            background: var(--surface);
            border: 1px solid var(--border);
            z-index: 1000;
        }

        .security-status.armed {
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .security-status.alert {
            color: var(--danger-color);
            border-color: var(--danger-color);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .dashboard-container {
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .dashboard-header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 12px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .dashboard-header p {
            font-size: 1.25rem;
            color: var(--text-secondary);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 28px;
            margin-bottom: 32px;
        }

        .card {
            background: var(--surface);
            border-radius: 24px;
            padding: 28px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.03) 0%, transparent 70%);
            transform: rotate(45deg);
            transition: all 0.4s ease;
            opacity: 0;
        }

        .card:hover {
            transform: translateY(-4px);
            border-color: var(--primary-color);
        }

        .card:hover::after {
            opacity: 1;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .card-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-right: 16px;
            position: relative;
        }

        .card-icon::after {
            content: '';
            position: absolute;
            inset: -2px;
            background: inherit;
            border-radius: 18px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover .card-icon::after {
            opacity: 0.3;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.1); opacity: 0.6; }
        }

        .card-icon i {
            color: white;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Door Control */
        .door-control .card-icon {
            background: var(--gradient-success);
        }

        .door-visualization {
            width: 280px;
            height: 180px;
            margin: 24px auto;
            position: relative;
            perspective: 1200px;
        }

        .door-frame {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 12px;
            position: relative;
            border: 4px solid #2a3660;
            overflow: hidden;
        }

        .door-panel {
            width: 85%;
            height: 90%;
            background: var(--gradient-primary);
            position: absolute;
            top: 5%;
            left: 7.5%;
            border-radius: 8px;
            transition: transform 1.5s ease;
            transform-origin: left center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .door-panel::before {
            content: '';
            position: absolute;
            top: 20%;
            right: 10%;
            width: 30%;
            height: 60%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            border-radius: 8px;
        }

        .door-panel.open {
            transform: perspective(1200px) rotateY(-85deg) translateZ(30px);
            box-shadow: 8px 0 16px rgba(0, 0, 0, 0.4);
        }

        .door-handle {
            width: 14px;
            height: 40px;
            background: var(--gradient-warning);
            border-radius: 14px;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 
                0 4px 12px rgba(245, 158, 11, 0.4), 
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }

        .door-status {
            margin: 20px 0;
            font-size: 1.35rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 32px;
            border-radius: 20px;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .door-status::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.8s;
        }

        .door-status:hover::before {
            left: 100%;
        }

        .status-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-closed { 
            background: var(--gradient-danger);
            color: white;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }
        .status-closed .status-indicator { background: white; }

        .status-open { 
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        .status-open .status-indicator { background: white; }

        .status-opening, .status-closing { 
            background: var(--gradient-warning);
            color: white;
            animation: pulse-status 2s infinite;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }
        .status-opening .status-indicator, .status-closing .status-indicator { 
            background: white;
            animation: pulse 0.5s infinite; 
        }

        @keyframes pulse-status {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }

        .control-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
            position: relative;
            overflow: hidden;
            user-select: none;
            z-index: 10;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.6s;
        }

        .btn:not(:disabled):hover::before {
            left: 100%;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: var(--gradient-warning);
            color: white;
            box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
        }

        .btn:active:not(:disabled) {
            transform: translateY(-1px) scale(0.98);
        }

        /* Tries Remaining Indicator */
        .tries-remaining {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 16px 0;
            padding: 12px 20px;
            border-radius: 12px;
            background: var(--surface-light);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .tries-remaining.warning {
            border-color: var(--warning-color);
            background: rgba(245, 158, 11, 0.1);
        }

        .tries-remaining.danger {
            border-color: var(--danger-color);
            background: rgba(239, 68, 68, 0.1);
            animation: pulse 1s infinite;
        }

        .tries-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .tries-count.warning {
            color: var(--warning-color);
        }

        .tries-count.danger {
            color: var(--danger-color);
        }

        /* Access Management */
        .access-management .card-icon {
            background: var(--gradient-primary);
        }

        .access-tabs {
            display: flex;
            margin-bottom: 24px;
            background: var(--background);
            border-radius: 14px;
            padding: 4px;
        }

        .tab-button {
            flex: 1;
            padding: 14px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            user-select: none;
            z-index: 10;
        }

        .tab-button.active {
            background: var(--gradient-primary);
            color: white;
            transform: scale(1.02);
        }

        .tab-button:not(.active):hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .tab-content {
            display: none;
            animation: fadeInUp 0.5s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section {
            background: var(--background);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            position: relative;
            z-index: 100;
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
        }

        .section-header strong {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .input-group {
            margin-bottom: 20px;
            position: relative;
            z-index: 1000;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .input-field {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
            pointer-events: auto !important;
            z-index: 1000;
            position: relative;
            cursor: text;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .input-field::placeholder {
            color: var(--text-secondary);
        }

        .scan-section, .detect-section {
            border: 2px dashed var(--border);
            background: rgba(30, 41, 81, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .scan-section.scanning, .detect-section.detecting {
            border-color: var(--primary-color);
            animation: scanPulse 1.5s infinite;
        }

        .scan-section.locked, .detect-section.locked {
            border-color: var(--danger-color);
            background: rgba(239, 68, 68, 0.1);
        }

        @keyframes scanPulse {
            0%, 100% { 
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            50% { 
                border-color: #60a5fa;
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
        }

        .scan-status, .rfid-status {
            margin: 12px 0;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            background: var(--surface-light);
            font-weight: 500;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .fingerprint-list, .rfid-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--surface);
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .list-item {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .list-item:hover {
            background: var(--surface-light);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .list-item-info i {
            color: var(--primary-color);
            font-size: 18px;
        }

        .delete-btn {
            padding: 6px 14px;
            background: var(--gradient-danger);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .delete-btn:hover {
            transform: scale(1.05);
        }

        /* Camera Section */
        .camera-section .card-icon {
            background: var(--gradient-danger);
        }

        .camera-container {
            position: relative;
            margin-bottom: 20px;
        }

        .camera-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: var(--surface-light);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .camera-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .camera-status-indicator.online {
            color: var(--success-color);
        }

        .camera-status-indicator.offline {
            color: var(--danger-color);
        }

        .camera-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .camera-status-dot.online {
            background: var(--success-color);
        }

        .camera-status-dot.offline {
            background: var(--danger-color);
        }

        .camera-ip-display {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 4px 8px;
            background: var(--background);
            border-radius: 6px;
        }

        .security-radar {
            width: 100%;
            height: 240px;
            position: relative;
            background: radial-gradient(circle at center, rgba(30, 41, 81, 0.9) 0%, rgba(10, 14, 39, 1) 100%);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .security-radar:hover {
            transform: scale(1.02);
            border: 2px solid rgba(59, 130, 246, 0.5);
        }

        .security-radar::after {
            content: 'Click to test motion detection';
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .security-radar:hover::after {
            opacity: 1;
        }

        .radar-container {
            width: 200px;
            height: 200px;
            position: relative;
        }

        .radar-circle {
            position: absolute;
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .radar-circle:nth-child(1) { width: 200px; height: 200px; }
        .radar-circle:nth-child(2) { width: 150px; height: 150px; }
        .radar-circle:nth-child(3) { width: 100px; height: 100px; }
        .radar-circle:nth-child(4) { width: 50px; height: 50px; }

        .radar-sweep {
            position: absolute;
            width: 100%;
            height: 100%;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                rgba(59, 130, 246, 0.8) 10deg,
                rgba(59, 130, 246, 0.4) 30deg,
                transparent 60deg
            );
            animation: radarSweep 4s linear infinite;
            border-radius: 50%;
        }

        .radar-sweep.scanning {
            animation-duration: 1s;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                rgba(245, 158, 11, 0.8) 10deg,
                rgba(245, 158, 11, 0.4) 30deg,
                transparent 60deg
            );
        }

        @keyframes radarSweep {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .radar-center {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 30px var(--primary-color);
            animation: center-pulse 3s ease-in-out infinite;
        }

        @keyframes center-pulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 30px var(--primary-color);
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.3);
                box-shadow: 0 0 50px var(--primary-color);
            }
        }

        .motion-targets {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .motion-targets.motion-active {
            opacity: 1;
        }

        .motion-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, var(--danger-color) 0%, #dc2626 100%);
            border-radius: 50%;
            box-shadow: 
                0 0 25px var(--danger-color),
                inset 0 0 10px rgba(255, 255, 255, 0.3);
            animation: target-ping 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        .motion-dot:nth-child(1) { top: 25%; right: 30%; }
        .motion-dot:nth-child(2) { top: 40%; left: 20%; animation-delay: 0.4s; }
        .motion-dot:nth-child(3) { bottom: 35%; right: 25%; animation-delay: 0.8s; }

        @keyframes target-ping {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(2);
                opacity: 0.5;
            }
            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .motion-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            border-radius: 24px;
            font-weight: 600;
            margin: 16px auto;
            width: fit-content;
            transition: all 0.3s ease;
        }

        .motion-indicator-container {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .motion-detected {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
            border: 2px solid var(--danger-color);
            animation: alertPulse 1s ease-out infinite;
        }

        @keyframes alertPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .motion-clear {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }

        .camera-feed {
            width: 100%;
            height: 240px;
            background: var(--surface);
            border-radius: 16px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border);
            overflow: hidden;
            position: relative;
        }

        .camera-feed.loading {
            border-color: var(--primary-color);
            animation: scanPulse 1.5s infinite;
        }

        .camera-placeholder {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
        }

        .camera-placeholder i {
            font-size: 56px;
            margin-bottom: 16px;
            color: var(--primary-color);
            opacity: 0.6;
        }

        .camera-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 14px;
        }

        .camera-stream {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 14px;
        }

        /* History Section */
        .history-section {
            grid-column: 1 / -1;
        }

        .history-section .card-icon {
            background: var(--gradient-warning);
        }

        .history-filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .filter-select, .filter-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--background);
            color: var(--text-primary);
            font-size: 14px;
        }

        .history-table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--background);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            background: var(--surface-light);
            padding: 16px;
            text-align: left;
            font-weight: 700;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
        }

        .history-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .history-table tr:hover td {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .method-badge, .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .method-fingerprint {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .method-rfid {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .method-motion {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning-color);
        }

        .status-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
        }

        .status-failed {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
        }

        .action-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning-color);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* System locked state */
        .system-locked {
            opacity: 0.6;
            pointer-events: none;
        }

        .lockout-message {
            text-align: center;
            padding: 20px;
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--danger-color);
            border-radius: 12px;
            color: var(--danger-color);
            font-weight: 600;
            margin: 16px 0;
            animation: pulse 1s infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 16px;
            }

            .dashboard-header h1 {
                font-size: 2rem;
                flex-direction: column;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .control-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            #alertContainer {
                width: calc(100vw - 40px);
            }

            .security-radar {
                height: 180px;
            }

            .radar-container {
                width: 150px;
                height: 150px;
            }

            .camera-status-bar {
                flex-direction: column;
                gap: 8px;
            }
        }

        /* Enhanced styling for user interaction elements */
        .enroll-section,
        .scan-controls,
        .user-list-section {
            position: relative;
            z-index: 100;
        }

        /* Ensure form elements are always interactive */
        .form-group {
            position: relative;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Background Particles -->
    <div class="bg-particles" id="particles"></div>

    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <!-- Connection Status -->
    <div class="connection-status disconnected" id="connectionStatus">
        <i class="fas fa-circle"></i>
        <span>Test Mode</span>
    </div>

    <!-- Security Status -->
    <div class="security-status armed" id="securityStatus">
        <i class="fas fa-shield-alt"></i>
        <span>System Armed</span>
    </div>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1><i class="fas fa-door-open"></i> Smart Door Security v4.2</h1>
            <p>Hệ thống cửa thông minh với AI & IoT - Full Integration</p>
        </div>

        <div class="dashboard-grid">
            <!-- Door Control -->
            <div class="card door-control">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-door-open"></i></div>
                    <div class="card-title">Điều Khiển Cửa</div>
                </div>
                
                <div class="door-visualization">
                    <div class="door-frame">
                        <div class="door-panel" id="doorPanel">
                            <div class="door-handle"></div>
                        </div>
                    </div>
                </div>
                
                <div class="door-status status-closed" id="doorStatus">
                    <span class="status-indicator"></span>
                    <span id="doorStatusText">Đóng</span>
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-success" id="btn-open">
                        <i class="fas fa-unlock"></i>
                        <span>Mở Cửa</span>
                    </button>
                    <button class="btn btn-danger" id="btn-close">
                        <i class="fas fa-lock"></i>
                        <span>Đóng Cửa</span>
                    </button>
                </div>
            </div>

            <!-- Access Management -->
            <div class="card access-management">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-user-shield"></i></div>
                    <div class="card-title">Quản Lý Truy Cập</div>
                </div>

                <!-- Tries Remaining Display -->
                <div class="tries-remaining" id="triesRemaining">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Còn lại <span class="tries-count" id="triesCount">3</span> lần thử</span>
                </div>

                <div class="access-tabs">
                    <button class="tab-button active" data-tab="fingerprint">
                        <i class="fas fa-fingerprint"></i>
                        <span>Vân Tay</span>
                    </button>
                    <button class="tab-button" data-tab="rfid">
                        <i class="fas fa-id-card"></i>
                        <span>Thẻ RFID</span>
                    </button>
                </div>

                <!-- Fingerprint Tab -->
                <div class="tab-content active" id="fingerprintTab">
                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-plus-circle"></i>
                            <strong>Thêm vân tay mới</strong>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">
                            <div class="input-group">
                                <label>ID Vân Tay:</label>
                                <input type="number" class="input-field" id="finger-id" placeholder="Nhập ID" min="1" max="127">
                            </div>
                            <div class="input-group">
                                <label>Tên người dùng:</label>
                                <input type="text" class="input-field" id="finger-name" placeholder="Nhập tên">
                            </div>
                        </div>
                        
                        <button class="btn btn-success" id="btn-finger-add" style="width: 100%;">
                            <i class="fas fa-plus"></i>
                            <span>Thêm Vân Tay</span>
                        </button>
                    </div>

                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-fingerprint"></i>
                            <strong>Test quét vân tay</strong>
                        </div>
                        
                        <div class="scan-section" id="fingerprintScanSection">
                            <div class="scan-status" id="fingerprintScanStatus">
                                Nhấn nút bên dưới để test quét vân tay
                            </div>
                            
                            <button class="btn btn-primary" id="btn-finger-scan" style="width: 100%; margin-top: 12px;">
                                <i class="fas fa-fingerprint"></i>
                                <span>Bắt Đầu Test</span>
                            </button>
                            <button class="btn btn-danger" id="btn-finger-stop" style="display: none; width: 100%; margin-top: 12px;">
                                <i class="fas fa-stop"></i>
                                <span>Dừng Test</span>
                            </button>
                        </div>

                        <div id="finger-result" class="result-display" style="margin-top: 16px;"></div>
                    </div>
                    
                    <!-- Fingerprint List -->
                    <div style="margin-top: 20px;">
                        <div style="margin-bottom: 12px; font-weight: 600; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-list"></i> Danh sách vân tay đã lưu:</span>
                            <button class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;" id="btn-finger-clear">
                                <i class="fas fa-trash"></i> Xóa tất cả
                            </button>
                        </div>
                        
                        <div class="fingerprint-list" id="finger-table">
                            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                <i class="fas fa-fingerprint" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                                <p>Chưa có vân tay nào được lưu</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RFID Tab -->
                <div class="tab-content" id="rfidTab">
                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-plus-circle"></i>
                            <strong>Thêm thẻ RFID mới</strong>
                        </div>
                        
                        <div class="input-group">
                            <label>UID Thẻ RFID:</label>
                            <input type="text" class="input-field" id="rfid-uid" placeholder="Nhập UID thẻ">
                        </div>
                        <div class="input-group">
                            <label>Tên chủ thẻ:</label>
                            <input type="text" class="input-field" id="rfid-name" placeholder="Nhập tên">
                        </div>
                        
                        <button class="btn btn-success" id="btn-rfid-add" style="width: 100%;">
                            <i class="fas fa-plus"></i>
                            <span>Thêm Thẻ</span>
                        </button>
                    </div>

                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-wifi"></i>
                            <strong>Test quét thẻ RFID</strong>
                        </div>
                        
                        <div class="detect-section" id="rfidDetectSection">
                            <div class="rfid-status" id="rfidDetectionStatus">
                                Nhấn nút để test quét thẻ RFID
                            </div>
                            
                            <button class="btn btn-primary" id="btn-rfid-scan" style="width: 100%; margin-top: 12px;">
                                <i class="fas fa-id-card"></i>
                                <span>Test Quét Thẻ</span>
                            </button>
                            <button class="btn btn-danger" id="btn-rfid-stop" style="display: none; width: 100%; margin-top: 12px;">
                                <i class="fas fa-stop"></i>
                                <span>Dừng Test</span>
                            </button>
                        </div>

                        <div id="rfid-result" class="result-display" style="margin-top: 16px;"></div>
                    </div>
                    
                    <!-- RFID List -->
                    <div style="margin-top: 20px;">
                        <div style="margin-bottom: 12px; font-weight: 600; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-list"></i> Danh sách thẻ RFID đã lưu:</span>
                            <button class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;" id="btn-rfid-clear">
                                <i class="fas fa-trash"></i> Xóa tất cả
                            </button>
                        </div>
                        
                        <div class="rfid-list" id="rfid-table">
                            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                <i class="fas fa-id-card" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                                <p>Chưa có thẻ RFID nào được lưu</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lockout Message (hidden by default) -->
                <div class="lockout-message" id="lockoutMessage" style="display: none;">
                    <i class="fas fa-lock"></i>
                    <strong>Hệ thống đã bị khóa!</strong><br>
                    Quá số lần thử cho phép. Vui lòng đợi hoặc liên hệ quản trị viên.
                </div>
            </div>

            <!-- Camera Section -->
            <div class="card camera-section">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-video"></i></div>
                    <div class="card-title">Camera An Ninh</div>
                </div>

                <!-- Camera Status Bar -->
                <div class="camera-status-bar">
                    <div class="camera-status-indicator offline" id="cameraStatusIndicator">
                        <div class="camera-status-dot offline"></div>
                        <span id="cameraStatusText">Camera Offline</span>
                    </div>
                    <div class="camera-ip-display" id="cameraIpDisplay">
                        Stream: Chờ kết nối...
                    </div>
                </div>

                <div class="security-radar" id="security-radar">
                    <div class="radar-container">
                        <div class="radar-circle"></div>
                        <div class="radar-circle"></div>
                        <div class="radar-circle"></div>
                        <div class="radar-circle"></div>
                        <div class="radar-sweep" id="radar-sweep"></div>
                        <div class="radar-center"></div>
                        <div class="motion-targets">
                            <div class="motion-dot"></div>
                            <div class="motion-dot"></div>
                            <div class="motion-dot"></div>
                        </div>
                    </div>
                </div>

                <div class="motion-indicator-container">
                    <div class="motion-indicator motion-clear" id="motionIndicator">
                        <i class="fas fa-shield-alt"></i>
                        <span id="motionText">Không có chuyển động</span>
                    </div>
                </div>

                <div class="camera-feed" id="cameraFeed">
                    <div class="camera-placeholder">
                        <i class="fas fa-camera"></i>
                        <div>Camera sẽ tự động chụp khi có chuyển động</div>
                        <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">
                            Ảnh sẽ được gửi về email ngay lập tức
                        </div>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="btn btn-primary" id="btn-capture">
                        <i class="fas fa-camera"></i>
                        <span>Chụp Thủ Công</span>
                    </button>
                    <button class="btn btn-warning" id="btn-stream-toggle">
                        <i class="fas fa-video"></i>
                        <span>Bật Stream</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="card history-section">
            <div class="card-header">
                <div class="card-icon"><i class="fas fa-history"></i></div>
                <div class="card-title">Lịch Sử Truy Cập</div>
            </div>

            <div class="history-filters">
                <div class="filter-group">
                    <label>Ngày:</label>
                    <input type="date" class="filter-input" id="filterDate">
                </div>
                <div class="filter-group">
                    <label>Phương thức:</label>
                    <select class="filter-select" id="filterMethod">
                        <option value="">Tất cả</option>
                        <option value="fingerprint">Vân tay</option>
                        <option value="rfid">Thẻ RFID</option>
                        <option value="motion">Cảm biến</option>
                        <option value="manual">Thủ công</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Kết quả:</label>
                    <select class="filter-select" id="filterResult">
                        <option value="">Tất cả</option>
                        <option value="success">Thành công</option>
                        <option value="failed">Thất bại</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" id="btn-filter">
                        <i class="fas fa-filter"></i>
                        <span>Lọc</span>
                    </button>
                </div>
            </div>

            <div class="history-table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Thời gian</th>
                            <th>Phương thức</th>
                            <th>ID/UID</th>
                            <th>Tên</th>
                            <th>Kết quả</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td>2025-06-16 14:30:25</td>
                            <td>
                                <span class="method-badge method-fingerprint">
                                    <i class="fas fa-fingerprint"></i>
                                    Vân tay
                                </span>
                            </td>
                            <td>1</td>
                            <td>Admin</td>
                            <td><span class="status-badge status-success"><i class="fas fa-check"></i> Thành công</span></td>
                            <td><span class="action-badge">Mở cửa</span></td>
                        </tr>
                        <tr>
                            <td>2025-06-16 14:25:12</td>
                            <td>
                                <span class="method-badge method-rfid">
                                    <i class="fas fa-id-card"></i>
                                    RFID
                                </span>
                            </td>
                            <td>A1B2C3D4</td>
                            <td>John Doe</td>
                            <td><span class="status-badge status-success"><i class="fas fa-check"></i> Thành công</span></td>
                            <td><span class="action-badge">Mở cửa</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- E-Ra Widget Script -->
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
    
    <script>
        // Create background particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Initialize particles
        createParticles();

        // Initialize EraWidget
        const eraWidget = new EraWidget();
        
        // Configuration variables - COMPLETE MAPPING
        let config = {
            doorStatus: null,        // V0
            motionStatus: null,      // V2
            fingerResult: null,      // V5
            rfidResult: null,        // V6
            fingerList: null,        // V7
            rfidList: null,          // V8
            triesRemaining: null,    // V9 - ADDED
            camStatus: null          // V10
        };
        
        let actions = {
            closeDoor: null,         // V1=0
            openDoor: null,          // V1=1
            fingerScan: null,        // V3=1
            fingerStop: null,        // V3=2
            fingerEnroll: null,      // V3=3
            fingerDelete: null,      // V3=4
            rfidScan: null,          // V4=1
            rfidStop: null,          // V4=2
            rfidAdd: null,           // V4=3
            rfidRemove: null,        // V4=4
            cameraCapture: null,     // V11=1
            // V12 and V13 are handled via direct send
        };

        // System State
        let systemState = {
            doorStatus: 'closed',
            motionDetected: false,
            fingerprintList: [],
            rfidList: [],
            accessHistory: [],
            isConnected: false,
            triesRemaining: 3,
            isSystemLocked: false,
            cameraOnline: false,
            cameraStreamUrl: '',
            isStreaming: false,
            operationTimeouts: new Map() // Track operation timeouts
        };

        // DOM Elements
        const elements = {
            doorPanel: document.getElementById('doorPanel'),
            doorStatus: document.getElementById('doorStatus'),
            doorStatusText: document.getElementById('doorStatusText'),
            btnOpen: document.getElementById('btn-open'),
            btnClose: document.getElementById('btn-close'),
            motionIndicator: document.getElementById('motionIndicator'),
            motionText: document.getElementById('motionText'),
            radarSweep: document.getElementById('radar-sweep'),
            securityRadar: document.getElementById('security-radar'),
            securityStatus: document.getElementById('securityStatus'),
            cameraFeed: document.getElementById('cameraFeed'),
            cameraStatusIndicator: document.getElementById('cameraStatusIndicator'),
            cameraStatusText: document.getElementById('cameraStatusText'),
            cameraIpDisplay: document.getElementById('cameraIpDisplay'),
            btnCapture: document.getElementById('btn-capture'),
            btnStreamToggle: document.getElementById('btn-stream-toggle'),
            fingerprintScanStatus: document.getElementById('fingerprintScanStatus'),
            rfidDetectionStatus: document.getElementById('rfidDetectionStatus'),
            fingerTable: document.getElementById('finger-table'),
            rfidTable: document.getElementById('rfid-table'),
            btnFingerScan: document.getElementById('btn-finger-scan'),
            btnFingerStop: document.getElementById('btn-finger-stop'),
            btnFingerAdd: document.getElementById('btn-finger-add'),
            btnRfidScan: document.getElementById('btn-rfid-scan'),
            btnRfidStop: document.getElementById('btn-rfid-stop'),
            btnRfidAdd: document.getElementById('btn-rfid-add'),
            fingerIdInput: document.getElementById('finger-id'),
            fingerNameInput: document.getElementById('finger-name'),
            rfidUidInput: document.getElementById('rfid-uid'),
            rfidNameInput: document.getElementById('rfid-name'),
            fingerResult: document.getElementById('finger-result'),
            rfidResult: document.getElementById('rfid-result'),
            historyTableBody: document.getElementById('historyTableBody'),
            triesRemaining: document.getElementById('triesRemaining'),
            triesCount: document.getElementById('triesCount'),
            lockoutMessage: document.getElementById('lockoutMessage'),
            connectionStatus: document.getElementById('connectionStatus')
        };

        // Alert Manager
        const alertManager = {
            alerts: new Map(),
            
            show(id, message, type = 'success', timeout = 5000) {
                this.remove(id);
                
                const container = document.getElementById('alertContainer');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.id = `alert-${id}`;
                alert.innerHTML = `
                    <i class="fas fa-${this.getIcon(type)}"></i>
                    <span>${message}</span>
                    <button class="alert-close" onclick="alertManager.remove('${id}')">×</button>
                `;
                
                container.appendChild(alert);
                this.alerts.set(id, alert);
                
                if (timeout > 0) {
                    setTimeout(() => this.remove(id), timeout);
                }
            },
            
            getIcon(type) {
                const icons = {
                    success: 'check-circle',
                    warning: 'exclamation-triangle',
                    danger: 'exclamation-circle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            },
            
            remove(id) {
                const alert = this.alerts.get(id);
                if (alert && alert.parentElement) {
                    alert.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (alert.parentElement) alert.remove();
                        this.alerts.delete(id);
                    }, 300);
                }
            },
            
            clear() {
                this.alerts.forEach((alert, id) => this.remove(id));
            }
        };

        // Initialize EraWidget with COMPLETE CONFIG
        eraWidget.init({
            onConfiguration: (configuration) => {
                console.log('Configuration received:', configuration);
                
                // Map realtime configs - COMPLETE MAPPING
                config.doorStatus = configuration.realtime_configs[0];      // V0
                config.motionStatus = configuration.realtime_configs[1];    // V2  
                config.fingerResult = configuration.realtime_configs[2];    // V5
                config.rfidResult = configuration.realtime_configs[3];      // V6
                config.fingerList = configuration.realtime_configs[4];      // V7
                config.rfidList = configuration.realtime_configs[5];        // V8
                config.triesRemaining = configuration.realtime_configs[6];  // V9 - ADDED
                config.camStatus = configuration.realtime_configs[7];       // V10
                
                // Map actions - COMPLETE MAPPING
                actions.closeDoor = configuration.actions[0];        // V1=0
                actions.openDoor = configuration.actions[1];         // V1=1
                actions.fingerScan = configuration.actions[2];       // V3=1
                actions.fingerStop = configuration.actions[3];       // V3=2
                actions.fingerEnroll = configuration.actions[4];     // V3=3
                actions.fingerDelete = configuration.actions[5];     // V3=4
                actions.rfidScan = configuration.actions[6];         // V4=1
                actions.rfidStop = configuration.actions[7];         // V4=2
                actions.rfidAdd = configuration.actions[8];          // V4=3
                actions.rfidRemove = configuration.actions[9];       // V4=4
                actions.cameraCapture = configuration.actions[10];   // V11=1
                
                // Update connection status
                elements.connectionStatus.className = 'connection-status connected';
                elements.connectionStatus.innerHTML = '<i class="fas fa-circle"></i><span>E-Ra Connected</span>';
                systemState.isConnected = true;
                
                // Bind event listeners
                bindEventListeners();
                
                // Initialize UI
                initializeUI();
                
                alertManager.show('config-loaded', '🚀 E-Ra cấu hình đã tải thành công!', 'success');
            },
            
            onValues: (values) => {
                console.log('Values received:', values);
                updateUI(values);
            },
            
            onConnected: () => {
                elements.connectionStatus.className = 'connection-status connected';
                elements.connectionStatus.innerHTML = '<i class="fas fa-circle"></i><span>E-Ra Connected</span>';
                systemState.isConnected = true;
                alertManager.show('era-connected', '✅ Kết nối E-Ra thành công!', 'success');
            },
            
            onDisconnected: () => {
                elements.connectionStatus.className = 'connection-status disconnected';
                elements.connectionStatus.innerHTML = '<i class="fas fa-circle"></i><span>E-Ra Disconnected</span>';
                systemState.isConnected = false;
                alertManager.show('era-disconnected', '❌ Mất kết nối E-Ra!', 'danger');
            }
        });

        // Enhanced Operation Timeout Manager
        const operationManager = {
            timeouts: new Map(),
            
            startOperation(operationType, timeoutMs = 30000) {
                this.clearOperation(operationType);
                
                const timeoutId = setTimeout(() => {
                    this.handleTimeout(operationType);
                }, timeoutMs);
                
                this.timeouts.set(operationType, timeoutId);
            },
            
            clearOperation(operationType) {
                const timeoutId = this.timeouts.get(operationType);
                if (timeoutId) {
                    clearTimeout(timeoutId);
                    this.timeouts.delete(operationType);
                }
            },
            
            handleTimeout(operationType) {
                switch (operationType) {
                    case 'fingerScan':
                        alertManager.show('finger-timeout', '⏰ Quét vân tay timeout!', 'warning');
                        resetFingerScanButton();
                        break;
                    case 'rfidScan':
                        alertManager.show('rfid-timeout', '⏰ Quét RFID timeout!', 'warning');
                        resetRfidScanButton();
                        break;
                    case 'doorOperation':
                        alertManager.show('door-timeout', '⏰ Thao tác cửa timeout!', 'warning');
                        break;
                    case 'cameraCapture':
                        alertManager.show('camera-timeout', '⏰ Chụp ảnh timeout!', 'warning');
                        resetCaptureButton();
                        break;
                }
                this.clearOperation(operationType);
            }
        };

        // Bind event listeners with COMPLETE INTEGRATION
        function bindEventListeners() {
            // Door controls with timeout management
            elements.btnOpen.onclick = (e) => {
                e.preventDefault();
                if (systemState.isSystemLocked) return;
                
                operationManager.startOperation('doorOperation', 15000);
                
                if (actions.openDoor) {
                    eraWidget.triggerAction(actions.openDoor.action, 1);
                } else {
                    // Test mode - simulate door opening
                    updateDoorStatus(2); // Opening
                    setTimeout(() => {
                        updateDoorStatus(1); // Open
                        operationManager.clearOperation('doorOperation');
                    }, 2000);
                }
                alertManager.show('door-opening', '🔓 Đang mở cửa...', 'info');
            };
            
            elements.btnClose.onclick = (e) => {
                e.preventDefault();
                if (systemState.isSystemLocked) return;
                
                operationManager.startOperation('doorOperation', 15000);
                
                if (actions.closeDoor) {
                    eraWidget.triggerAction(actions.closeDoor.action, 0);
                } else {
                    // Test mode - simulate door closing
                    updateDoorStatus(3); // Closing
                    setTimeout(() => {
                        updateDoorStatus(0); // Closed
                        operationManager.clearOperation('doorOperation');
                    }, 2000);
                }
                alertManager.show('door-closing', '🔒 Đang đóng cửa...', 'info');
            };
            
            // Fingerprint controls with PAYLOAD INTEGRATION
            elements.btnFingerScan.onclick = (e) => {
                e.preventDefault();
                if (systemState.isSystemLocked) return;
                
                operationManager.startOperation('fingerScan', 30000);
                
                if (actions.fingerScan) {
                    eraWidget.triggerAction(actions.fingerScan.action, 1);
                } else {
                    // Test mode with realistic simulation
                    elements.fingerprintScanStatus.textContent = 'Test mode - đang quét vân tay...';
                    elements.fingerprintScanStatus.style.background = 'var(--primary-color)';
                    elements.fingerprintScanStatus.style.color = 'white';
                    
                    setTimeout(() => {
                        const testResults = [
                            'ID:1,Name:Admin',
                            'ID:2,Name:User1', 
                            'Unknown ID:99',
                            'ID:1,Name:Admin'
                        ];
                        const result = testResults[Math.floor(Math.random() * testResults.length)];
                        updateFingerResult(result);
                        operationManager.clearOperation('fingerScan');
                    }, 3000);
                }
                
                alertManager.show('finger-scan-start', '👆 Bắt đầu quét vân tay!', 'success');
                elements.btnFingerScan.innerHTML = '<div class="loading"></div> Đang quét...';
                elements.btnFingerScan.disabled = true;
                elements.btnFingerStop.style.display = 'inline-flex';
                document.getElementById('fingerprintScanSection').classList.add('scanning');
            };
            
            elements.btnFingerStop.onclick = (e) => {
                e.preventDefault();
                operationManager.clearOperation('fingerScan');
                
                if (actions.fingerStop) {
                    eraWidget.triggerAction(actions.fingerStop.action, 2);
                } else {
                    updateFingerResult('Stopped');
                }
                alertManager.show('finger-scan-stop', '⏹️ Dừng quét vân tay', 'warning');
                resetFingerScanButton();
            };
            
            elements.btnFingerAdd.onclick = (e) => {
                e.preventDefault();
                if (systemState.isSystemLocked) return;
                
                const id = elements.fingerIdInput.value.trim();
                const name = elements.fingerNameInput.value.trim();
                
                if (!id || !name) {
                    alertManager.show('finger-input-error', '❌ Vui lòng nhập đầy đủ thông tin', 'danger');
                    return;
                }
                
                if (systemState.fingerprintList.find(u => u.id === parseInt(id))) {
                    alertManager.show('finger-exists', '❌ ID vân tay đã tồn tại!', 'danger');
                    return;
                }
                
                if (actions.fingerEnroll) {
                    // PAYLOAD INTEGRATION - Send data before enrolling
                    eraWidget.send(12, id);     // V12 - payloadID
                    eraWidget.send(13, name);   // V13 - payloadName
                    
                    setTimeout(() => {
                        eraWidget.triggerAction(actions.fingerEnroll.action, 3);
                    }, 100); // Small delay to ensure payload is sent
                } else {
                    // Test mode - add to table
                    const newUser = { id: parseInt(id), name: name };
                    systemState.fingerprintList.push(newUser);
                    updateFingerList();
                }
                
                alertManager.show('finger-added', `🔐 Đã thêm vân tay: ${name}`, 'success');
                
                // Clear inputs
                elements.fingerIdInput.value = '';
                elements.fingerNameInput.value = '';
            };
            
            // RFID controls with PAYLOAD INTEGRATION
            elements.btnRfidScan.onclick = (e) => {
                e.preventDefault();
                if (systemState.isSystemLocked) return;
                
                operationManager.startOperation('rfidScan', 30000);
                
                if (actions.rfidScan) {
                    eraWidget.triggerAction(actions.rfidScan.action, 1);
                } else {
                    // Test mode with realistic simulation
                    elements.rfidDetectionStatus.textContent = 'Test mode - đang quét thẻ RFID...';
                    elements.rfidDetectionStatus.style.background = 'var(--primary-color)';
                    elements.rfidDetectionStatus.style.color = 'white';
                    
                    setTimeout(() => {
                        const testResults = [
                            'UID:A1B2C3D4,Name:John Doe',
                            'UID:E5F6G7H8,Name:Jane Smith',
                            'Unknown UID:12345678',
                            'UID:A1B2C3D4,Name:John Doe'
                        ];
                        const result = testResults[Math.floor(Math.random() * testResults.length)];
                        updateRfidResult(result);
                        operationManager.clearOperation('rfidScan');
                    }, 3000);
                }
                
                alertManager.show('rfid-scan-start', '🎫 Bắt đầu quét RFID!', 'success');
                elements.btnRfidScan.innerHTML = '<div class="loading"></div> Đang quét...';
                elements.btnRfidScan.disabled = true;
                elements.btnRfidStop.style.display = 'inline-flex';
                document.getElementById('rfidDetectSection').classList.add('detecting');
            };
            
            elements.btnRfidStop.onclick = (e) => {
                e.preventDefault();
                operationManager.clearOperation('rfidScan');
                
                if (actions.rfidStop) {
                    eraWidget.triggerAction(actions.rfidStop.action, 2);
                } else {
                    updateRfidResult('Stopped');
                }
                alertManager.show('rfid-scan-stop', '⏹️ Dừng quét RFID', 'warning');
                resetRfidScanButton();
            };
            
            elements.btnRfidAdd.onclick = (e) => {
                e.preventDefault();
                if (systemState.isSystemLocked) return;
                
                const uid = elements.rfidUidInput.value.trim().toUpperCase();
                const name = elements.rfidNameInput.value.trim();
                
                if (!uid || !name) {
                    alertManager.show('rfid-input-error', '❌ Vui lòng nhập đầy đủ thông tin', 'danger');
                    return;
                }
                
                if (systemState.rfidList.find(c => c.uid === uid)) {
                    alertManager.show('rfid-exists', '❌ UID thẻ đã tồn tại!', 'danger');
                    return;
                }
                
                if (actions.rfidAdd) {
                    // PAYLOAD INTEGRATION - Send data before adding
                    eraWidget.send(12, uid);    // V12 - payloadID (UID for RFID)
                    eraWidget.send(13, name);   // V13 - payloadName
                    
                    setTimeout(() => {
                        eraWidget.triggerAction(actions.rfidAdd.action, 3);
                    }, 100); // Small delay to ensure payload is sent
                } else {
                    // Test mode - add to table
                    const newCard = { uid: uid, name: name };
                    systemState.rfidList.push(newCard);
                    updateRfidList();
                }
                
                alertManager.show('rfid-added', `🎫 Đã thêm thẻ RFID: ${name}`, 'success');
                
                // Clear inputs
                elements.rfidUidInput.value = '';
                elements.rfidNameInput.value = '';
            };
            
            // Camera controls with ENHANCED INTEGRATION
            elements.btnCapture.onclick = (e) => {
                e.preventDefault();
                operationManager.startOperation('cameraCapture', 10000);
                
                if (actions.cameraCapture) {
                    eraWidget.triggerAction(actions.cameraCapture.action, 1);
                } else {
                    // Test mode - simulate capture
                    setTimeout(() => {
                        alertManager.show('camera-test', '📸 Test mode - đã chụp ảnh và gửi email!', 'success');
                        operationManager.clearOperation('cameraCapture');
                        resetCaptureButton();
                    }, 3000);
                }
                
                alertManager.show('camera-capture', '📸 Đang chụp ảnh và gửi email...', 'info');
                elements.btnCapture.innerHTML = '<div class="loading"></div> Đang chụp...';
                elements.btnCapture.disabled = true;
            };
            
            // Camera stream toggle
            elements.btnStreamToggle.onclick = (e) => {
                e.preventDefault();
                toggleCameraStream();
            };
            
            // Motion detection test (click on radar)
            elements.securityRadar.onclick = () => {
                const motionTargets = document.querySelector('.motion-targets');
                const isCurrentlyDetected = motionTargets.classList.contains('motion-active');
                updateMotionStatus(!isCurrentlyDetected);
                
                if (!isCurrentlyDetected) {
                    // Auto reset after 5 seconds
                    setTimeout(() => updateMotionStatus(false), 5000);
                }
            };
            
            // Tab switching
            initializeTabs();
            
            // Clear buttons with confirmation
            document.getElementById('btn-finger-clear').onclick = () => {
                if (systemState.isSystemLocked) return;
                if (confirm('Xác nhận xóa tất cả vân tay? Hành động này không thể hoàn tác!')) {
                    systemState.fingerprintList = [];
                    updateFingerList();
                    alertManager.show('finger-cleared', '🗑️ Đã xóa tất cả vân tay', 'warning');
                    
                    // Send clear signal to Arduino if connected
                    if (systemState.isConnected) {
                        // Could implement a clear all function in Arduino
                    }
                }
            };
            
            document.getElementById('btn-rfid-clear').onclick = () => {
                if (systemState.isSystemLocked) return;
                if (confirm('Xác nhận xóa tất cả thẻ RFID? Hành động này không thể hoàn tác!')) {
                    systemState.rfidList = [];
                    updateRfidList();
                    alertManager.show('rfid-cleared', '🗑️ Đã xóa tất cả thẻ RFID', 'warning');
                    
                    // Send clear signal to Arduino if connected
                    if (systemState.isConnected) {
                        // Could implement a clear all function in Arduino
                    }
                }
            };
            
            // Filter button
            document.getElementById('btn-filter').onclick = () => {
                const date = document.getElementById('filterDate').value;
                const method = document.getElementById('filterMethod').value;
                const result = document.getElementById('filterResult').value;
                applyHistoryFilter(date, method, result);
                alertManager.show('filter-applied', '🔍 Đã áp dụng bộ lọc', 'info');
            };
        }

        // Camera stream management  
        function toggleCameraStream() {
            // In test mode, allow streaming regardless of camera status
            if (!systemState.isConnected) {
                // Test mode - always allow
                if (systemState.isStreaming) {
                    stopCameraStream();
                } else {
                    startCameraStream();
                }
                return;
            }
            
            // When connected to E-Ra, check camera status
            if (!systemState.cameraOnline) {
                alertManager.show('camera-offline', '❌ Camera không trực tuyến! Kiểm tra kết nối ESP32-CAM', 'danger');
                return;
            }
            
            if (systemState.isStreaming) {
                stopCameraStream();
            } else {
                startCameraStream();
            }
        }
        
        function startCameraStream() {
            // Use configured stream URL or fallback to default
            const streamUrl = systemState.cameraStreamUrl || 'http://192.168.1.91/stream';
            
            // Show what URL we're trying to connect to
            alertManager.show('stream-connecting', `🔗 Đang kết nối: ${streamUrl}`, 'info');
            
            elements.cameraFeed.innerHTML = `
                <img class="camera-stream" src="${streamUrl}" 
                     alt="Camera Stream" 
                     onerror="handleStreamError(this)"
                     onload="handleStreamSuccess(this)">
            `;
            
            elements.cameraFeed.classList.add('loading');
            elements.btnStreamToggle.innerHTML = '<div class="loading"></div> Đang kết nối...';
            elements.btnStreamToggle.disabled = true;
            
            // Timeout fallback
            setTimeout(() => {
                if (elements.btnStreamToggle.innerHTML.includes('Đang kết nối')) {
                    // Still connecting after 5 seconds - trigger error handler
                    window.handleStreamError();
                }
            }, 5000);
        }
        
        function stopCameraStream() {
            systemState.isStreaming = false;
            elements.cameraFeed.classList.remove('loading');
            elements.cameraFeed.innerHTML = `
                <div class="camera-placeholder">
                    <i class="fas fa-video-slash"></i>
                    <div>Camera stream đã tắt</div>
                    <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">
                        Nhấn "Bật Stream" để xem lại
                    </div>
                </div>
            `;
            
            elements.btnStreamToggle.innerHTML = '<i class="fas fa-video"></i><span>Bật Stream</span>';
            elements.btnStreamToggle.className = 'btn btn-warning';
            alertManager.show('stream-stopped', '📺 Đã tắt camera stream', 'info');
        }
        
        // Global functions for stream handling
        window.handleStreamError = function(img) {
            console.error('Stream error');
            systemState.isStreaming = false;
            elements.cameraFeed.classList.remove('loading');
            elements.cameraFeed.innerHTML = `
                <div class="camera-placeholder">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>Không thể kết nối camera stream</div>
                    <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">
                        Kiểm tra kết nối ESP32-CAM tại địa chỉ: ${systemState.cameraStreamUrl || 'http://192.168.1.91/stream'}
                    </div>
                </div>
            `;
            
            elements.btnStreamToggle.innerHTML = '<i class="fas fa-video"></i><span>Bật Stream</span>';
            elements.btnStreamToggle.disabled = false;
            elements.btnStreamToggle.className = 'btn btn-warning';
            
            alertManager.show('stream-error', '❌ Lỗi kết nối camera stream! Kiểm tra ESP32-CAM', 'danger');
        };
        
        window.handleStreamSuccess = function(img) {
            console.log('Stream connected successfully');
            systemState.isStreaming = true;
            elements.cameraFeed.classList.remove('loading');
            elements.btnStreamToggle.innerHTML = '<i class="fas fa-stop"></i><span>Tắt Stream</span>';
            elements.btnStreamToggle.disabled = false;
            elements.btnStreamToggle.className = 'btn btn-danger';
            alertManager.show('stream-started', '📺 Camera stream đã kết nối thành công!', 'success');
        };

        // Initialize UI with COMPLETE SETUP
        function initializeUI() {
            // Initialize motion detector
            updateMotionStatus(false);
            
            // Initialize door status
            updateDoorStatus(0); // Closed by default
            
            // Initialize tries remaining
            updateTriesRemaining(3);
            
            // Initialize camera status - SET TO ONLINE IMMEDIATELY IN TEST MODE
            updateCameraStatus(true, '192.168.1.91');
            
            // Enable all controls for testing
            document.querySelectorAll('.btn').forEach(btn => {
                btn.disabled = false;
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });
            
            document.querySelectorAll('.input-field').forEach(input => {
                input.disabled = false;
                input.removeAttribute('disabled');
                input.style.pointerEvents = 'auto';
                input.style.opacity = '1';
                input.style.cursor = 'text';
                input.readOnly = false;
                input.tabIndex = 0;
            });
            
            // Initialize lists with demo data
            systemState.fingerprintList = [
                { id: 1, name: 'Admin' },
                { id: 2, name: 'User1' }
            ];
            
            systemState.rfidList = [
                { uid: 'A1B2C3D4', name: 'John Doe' },
                { uid: 'E5F6G7H8', name: 'Jane Smith' }
            ];
            
            updateFingerList();
            updateRfidList();
            
            // Set today's date
            document.getElementById('filterDate').value = new Date().toISOString().split('T')[0];
            
            alertManager.show('dashboard-ready', '🎉 Dashboard sẵn sàng! Camera stream có thể test với IP: 192.168.1.91', 'success');
        }

        // Update UI based on received values with COMPLETE HANDLING
        function updateUI(values) {
            // Update door status
            if (config.doorStatus && values[config.doorStatus.id]) {
                const doorValue = values[config.doorStatus.id].value;
                updateDoorStatus(doorValue);
                operationManager.clearOperation('doorOperation');
            }
            
            // Update motion status
            if (config.motionStatus && values[config.motionStatus.id]) {
                const motionValue = values[config.motionStatus.id].value;
                updateMotionStatus(motionValue === 1);
            }
            
            // Update fingerprint result
            if (config.fingerResult && values[config.fingerResult.id]) {
                const fingerResult = values[config.fingerResult.id].value;
                updateFingerResult(fingerResult);
                operationManager.clearOperation('fingerScan');
            }
            
            // Update RFID result
            if (config.rfidResult && values[config.rfidResult.id]) {
                const rfidResult = values[config.rfidResult.id].value;
                updateRfidResult(rfidResult);
                operationManager.clearOperation('rfidScan');
            }
            
            // Update fingerprint list
            if (config.fingerList && values[config.fingerList.id]) {
                const fingerList = values[config.fingerList.id].value;
                parseFingerList(fingerList);
            }
            
            // Update RFID list
            if (config.rfidList && values[config.rfidList.id]) {
                const rfidList = values[config.rfidList.id].value;
                parseRfidList(rfidList);
            }
            
            // Update tries remaining - NEW INTEGRATION
            if (config.triesRemaining && values[config.triesRemaining.id]) {
                const triesValue = values[config.triesRemaining.id].value;
                updateTriesRemaining(triesValue);
            }
            
            // Update camera status - NEW INTEGRATION
            if (config.camStatus && values[config.camStatus.id]) {
                const camValue = values[config.camStatus.id].value;
                updateCameraStatus(camValue === 1);
                operationManager.clearOperation('cameraCapture');
            }
        }

        // Update tries remaining with LOCKOUT LOGIC
        function updateTriesRemaining(tries) {
            systemState.triesRemaining = tries;
            elements.triesCount.textContent = tries;
            
            // Update visual state based on tries remaining
            elements.triesRemaining.className = 'tries-remaining';
            elements.triesCount.className = 'tries-count';
            
            if (tries <= 0) {
                // System lockout
                systemState.isSystemLocked = true;
                elements.triesRemaining.classList.add('danger');
                elements.triesCount.classList.add('danger');
                elements.lockoutMessage.style.display = 'block';
                
                // Lock scan sections
                document.getElementById('fingerprintScanSection').classList.add('locked');
                document.getElementById('rfidDetectSection').classList.add('locked');
                
                // Disable scan buttons
                elements.btnFingerScan.disabled = true;
                elements.btnRfidScan.disabled = true;
                
                // Update security status
                elements.securityStatus.className = 'security-status alert';
                elements.securityStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>System Locked</span>';
                
                alertManager.show('system-locked', '🔒 Hệ thống đã bị khóa do quá số lần thử!', 'danger', 0);
            } else if (tries <= 1) {
                elements.triesRemaining.classList.add('danger');
                elements.triesCount.classList.add('danger');
                alertManager.show('tries-low', `⚠️ Chỉ còn ${tries} lần thử!`, 'warning');
            } else if (tries <= 2) {
                elements.triesRemaining.classList.add('warning');
                elements.triesCount.classList.add('warning');
            } else {
                // Normal state
                systemState.isSystemLocked = false;
                elements.lockoutMessage.style.display = 'none';
                
                // Unlock scan sections
                document.getElementById('fingerprintScanSection').classList.remove('locked');
                document.getElementById('rfidDetectSection').classList.remove('locked');
                
                // Enable scan buttons
                elements.btnFingerScan.disabled = false;
                elements.btnRfidScan.disabled = false;
                
                // Update security status
                elements.securityStatus.className = 'security-status armed';
                elements.securityStatus.innerHTML = '<i class="fas fa-shield-alt"></i><span>System Armed</span>';
            }
        }

        // Update camera status with COMPLETE INTEGRATION
        function updateCameraStatus(online, ipAddress = null) {
            systemState.cameraOnline = online;
            
            if (online) {
                elements.cameraStatusIndicator.className = 'camera-status-indicator online';
                elements.cameraStatusText.textContent = 'Camera Online';
                document.querySelector('.camera-status-dot').className = 'camera-status-dot online';
                
                if (ipAddress) {
                    elements.cameraIpDisplay.textContent = `Stream: http://${ipAddress}/stream`;
                    systemState.cameraStreamUrl = `http://${ipAddress}/stream`;
                } else {
                    elements.cameraIpDisplay.textContent = `Stream: ${systemState.cameraStreamUrl || 'http://192.168.1.91/stream'}`;
                }
                
                elements.btnStreamToggle.disabled = false;
                alertManager.show('camera-online', '📹 Camera đã sẵn sàng streaming!', 'success', 3000);
            } else {
                elements.cameraStatusIndicator.className = 'camera-status-indicator offline';
                elements.cameraStatusText.textContent = 'Camera Offline';
                document.querySelector('.camera-status-dot').className = 'camera-status-dot offline';
                elements.cameraIpDisplay.textContent = 'Stream: Chờ kết nối...';
                
                // In test mode, still allow streaming
                elements.btnStreamToggle.disabled = systemState.isConnected;
                
                // Stop streaming if currently active
                if (systemState.isStreaming) {
                    stopCameraStream();
                }
            }
        }

        // Reset capture button
        function resetCaptureButton() {
            elements.btnCapture.innerHTML = '<i class="fas fa-camera"></i><span>Chụp Thủ Công</span>';
            elements.btnCapture.disabled = false;
        }

        // Update door status and visual with ENHANCED FEEDBACK
        function updateDoorStatus(status) {
            const statusMap = {
                0: { text: 'Đóng', class: 'status-closed' },
                1: { text: 'Mở', class: 'status-open' },
                2: { text: 'Đang Mở', class: 'status-opening' },
                3: { text: 'Đang Đóng', class: 'status-closing' }
            };
            
            const statusInfo = statusMap[status] || statusMap[0];
            
            elements.doorStatusText.textContent = statusInfo.text;
            elements.doorStatus.className = `door-status ${statusInfo.class}`;
            
            // Update visual
            elements.doorPanel.classList.remove('open');
            if (status === 1) {
                elements.doorPanel.classList.add('open');
            } else if (status === 2) {
                setTimeout(() => elements.doorPanel.classList.add('open'), 500);
            }
            
            // Update button states
            elements.btnOpen.disabled = (status === 1 || status === 2);
            elements.btnClose.disabled = (status === 0 || status === 3);
            
            systemState.doorStatus = status;
            
            // Add to history for door state changes
            if (status === 1 || status === 0) {
                const action = status === 1 ? 'Mở cửa' : 'Đóng cửa';
                addToHistory('🚪 Thủ công', 'MANUAL', 'System', '✅ Thành công', action);
            }
        }

        // Update motion detection with ENHANCED VISUALIZATION
        function updateMotionStatus(detected) {
            const motionTargets = document.querySelector('.motion-targets');
            
            if (detected) {
                elements.motionIndicator.className = 'motion-indicator motion-detected';
                elements.motionText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Phát hiện chuyển động!';
                motionTargets.classList.add('motion-active');
                elements.radarSweep.classList.add('scanning');
                
                // Update security status
                elements.securityStatus.className = 'security-status alert';
                elements.securityStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Motion Alert</span>';
                
                alertManager.show('motion-detected', '⚠️ Phát hiện chuyển động tại cửa!', 'warning');
                
                // Auto capture if camera is online
                if (systemState.cameraOnline && actions.cameraCapture) {
                    setTimeout(() => {
                        eraWidget.triggerAction(actions.cameraCapture.action, 1);
                        alertManager.show('auto-capture', '📸 Tự động chụp ảnh do phát hiện chuyển động', 'info');
                    }, 1000);
                }
                
                // Add to history
                addToHistory('🎯 Cảm biến', 'PIR-001', 'Motion Sensor', '⚠️ Phát hiện', 'Cảnh báo gửi');
            } else {
                elements.motionIndicator.className = 'motion-indicator motion-clear';
                elements.motionText.innerHTML = '<i class="fas fa-shield-alt"></i> Không có chuyển động';
                motionTargets.classList.remove('motion-active');
                elements.radarSweep.classList.remove('scanning');
                
                // Reset security status if not locked
                if (!systemState.isSystemLocked) {
                    elements.securityStatus.className = 'security-status armed';
                    elements.securityStatus.innerHTML = '<i class="fas fa-shield-alt"></i><span>System Armed</span>';
                }
            }
            
            systemState.motionDetected = detected;
        }

        // Update fingerprint result with ENHANCED PROCESSING
        function updateFingerResult(result) {
            elements.fingerResult.innerHTML = `
                <div style="padding: 12px; border-radius: 10px; background: var(--surface-light);">
                    <strong>Kết quả vân tay:</strong> ${result}
                </div>
            `;
            
            // Reset scan button if scan completed
            if (result.includes('ID:') || result.includes('Unknown') || result.includes('Error') || result.includes('Stopped') || result.includes('Enrolled') || result.includes('Deleted')) {
                resetFingerScanButton();
                
                // Parse result and add to history
                if (result.includes('ID:') && !result.includes('Enrolled') && !result.includes('Deleted')) {
                    const parts = result.split(',');
                    const id = parts[0].replace('ID:', '');
                    const name = parts[1] ? parts[1].replace('Name:', '') : 'Unknown';
                    const success = !result.includes('Unknown');
                    
                    addToHistory('👆 Vân tay', id, name, 
                               success ? '✅ Thành công' : '❌ Thất bại',
                               success ? 'Mở cửa' : 'Từ chối');
                    
                    if (success) {
                        alertManager.show('access-success', `✅ Truy cập thành công: ${name}`, 'success');
                        // Auto open door on successful access
                        if (actions.openDoor) {
                            setTimeout(() => {
                                eraWidget.triggerAction(actions.openDoor.action, 1);
                            }, 500);
                        }
                        // Reset tries on success
                        updateTriesRemaining(3);
                    } else {
                        alertManager.show('access-failed', '❌ Vân tay không được nhận dạng', 'danger');
                        // Decrease tries on failure
                        updateTriesRemaining(Math.max(0, systemState.triesRemaining - 1));
                    }
                } else if (result.includes('Enrolled')) {
                    const name = result.replace('Enrolled: ', '');
                    alertManager.show('finger-enrolled', `✅ Đã lưu vân tay: ${name}`, 'success');
                } else if (result.includes('Deleted')) {
                    const name = result.replace('Deleted: ', '');
                    alertManager.show('finger-deleted', `🗑️ Đã xóa vân tay: ${name}`, 'success');
                }
            }
        }

        // Update RFID result with ENHANCED PROCESSING
        function updateRfidResult(result) {
            elements.rfidResult.innerHTML = `
                <div style="padding: 12px; border-radius: 10px; background: var(--surface-light);">
                    <strong>Kết quả RFID:</strong> ${result}
                </div>
            `;
            
            // Reset scan button if scan completed
            if (result.includes('UID:') || result.includes('Unknown') || result.includes('Error') || result.includes('Stopped') || result.includes('Added') || result.includes('Removed')) {
                resetRfidScanButton();
                
                // Parse result and add to history
                if (result.includes('UID:') && !result.includes('Added') && !result.includes('Removed')) {
                    const parts = result.split(',');
                    const uid = parts[0].replace('UID:', '');
                    const name = parts[1] ? parts[1].replace('Name:', '') : 'Unknown';
                    const success = !result.includes('Unknown');
                    
                    addToHistory('🎫 RFID', uid, name,
                               success ? '✅ Thành công' : '❌ Thất bại',
                               success ? 'Mở cửa' : 'Từ chối');
                    
                    if (success) {
                        alertManager.show('access-success', `✅ Truy cập thành công: ${name}`, 'success');
                        // Auto open door on successful access
                        if (actions.openDoor) {
                            setTimeout(() => {
                                eraWidget.triggerAction(actions.openDoor.action, 1);
                            }, 500);
                        }
                        // Reset tries on success
                        updateTriesRemaining(3);
                    } else {
                        alertManager.show('access-failed', '❌ Thẻ RFID không được nhận dạng', 'danger');
                        // Decrease tries on failure
                        updateTriesRemaining(Math.max(0, systemState.triesRemaining - 1));
                    }
                } else if (result.includes('Added')) {
                    const name = result.replace('Added: ', '');
                    alertManager.show('rfid-added', `✅ Đã thêm thẻ RFID: ${name}`, 'success');
                } else if (result.includes('Removed')) {
                    const name = result.replace('Removed: ', '');
                    alertManager.show('rfid-removed', `🗑️ Đã xóa thẻ RFID: ${name}`, 'success');
                }
            }
        }

        // Parse and update fingerprint list with ERROR HANDLING
        function parseFingerList(jsonString) {
            try {
                const parsedList = JSON.parse(jsonString);
                if (Array.isArray(parsedList)) {
                    systemState.fingerprintList = parsedList.map(item => ({
                        id: parseInt(item.id),
                        name: item.name
                    }));
                    updateFingerList();
                }
            } catch (error) {
                console.error('Error parsing fingerprint list:', error);
                alertManager.show('parse-error', '❌ Lỗi xử lý danh sách vân tay', 'danger');
            }
        }

        // Parse and update RFID list with ERROR HANDLING
        function parseRfidList(jsonString) {
            try {
                const parsedList = JSON.parse(jsonString);
                if (Array.isArray(parsedList)) {
                    systemState.rfidList = parsedList.map(item => ({
                        uid: item.uid,
                        name: item.name
                    }));
                    updateRfidList();
                }
            } catch (error) {
                console.error('Error parsing RFID list:', error);
                alertManager.show('parse-error', '❌ Lỗi xử lý danh sách RFID', 'danger');
            }
        }

        // Update fingerprint list display with ENHANCED UI
        function updateFingerList() {
            if (systemState.fingerprintList.length === 0) {
                elements.fingerTable.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                        <i class="fas fa-fingerprint" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                        <p>Chưa có vân tay nào được lưu</p>
                    </div>
                `;
                return;
            }
            
            systemState.fingerprintList.sort((a, b) => a.id - b.id);
            
            elements.fingerTable.innerHTML = systemState.fingerprintList.map(user => `
                <div class="list-item">
                    <div class="list-item-info">
                        <i class="fas fa-fingerprint"></i>
                        <span><strong>ID #${user.id}</strong> - ${user.name}</span>
                    </div>
                    <button class="delete-btn" onclick="deleteFingerprint(${user.id})">
                        <i class="fas fa-trash"></i>
                        <span>Xóa</span>
                    </button>
                </div>
            `).join('');
        }

        // Update RFID list display with ENHANCED UI
        function updateRfidList() {
            if (systemState.rfidList.length === 0) {
                elements.rfidTable.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                        <i class="fas fa-id-card" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                        <p>Chưa có thẻ RFID nào được lưu</p>
                    </div>
                `;
                return;
            }
            
            elements.rfidTable.innerHTML = systemState.rfidList.map(card => `
                <div class="list-item">
                    <div class="list-item-info">
                        <i class="fas fa-id-card"></i>
                        <span><strong>${card.uid}</strong> - ${card.name}</span>
                    </div>
                    <button class="delete-btn" onclick="deleteRfidCard('${card.uid}')">
                        <i class="fas fa-trash"></i>
                        <span>Xóa</span>
                    </button>
                </div>
            `).join('');
        }

        // Delete fingerprint with PAYLOAD INTEGRATION
        function deleteFingerprint(id) {
            if (systemState.isSystemLocked) return;
            
            const user = systemState.fingerprintList.find(u => u.id === id);
            if (!user) return;
            
            if (!confirm(`Xác nhận xóa vân tay "${user.name}" (ID: ${id})?`)) return;
            
            if (actions.fingerDelete) {
                // Send payload before delete
                eraWidget.send(12, id.toString()); // V12 - payloadID
                
                setTimeout(() => {
                    eraWidget.triggerAction(actions.fingerDelete.action, 4);
                }, 100);
            } else {
                // Test mode - remove from list
                systemState.fingerprintList = systemState.fingerprintList.filter(u => u.id !== id);
                updateFingerList();
                alertManager.show('finger-deleted', `🗑️ Đã xóa vân tay: ${user.name}`, 'success');
            }
        }

        // Delete RFID card with PAYLOAD INTEGRATION
        function deleteRfidCard(uid) {
            if (systemState.isSystemLocked) return;
            
            const card = systemState.rfidList.find(c => c.uid === uid);
            if (!card) return;
            
            if (!confirm(`Xác nhận xóa thẻ RFID "${card.name}" (UID: ${uid})?`)) return;
            
            if (actions.rfidRemove) {
                // Send payload before remove
                eraWidget.send(12, uid); // V12 - payloadID (UID for RFID)
                
                setTimeout(() => {
                    eraWidget.triggerAction(actions.rfidRemove.action, 4);
                }, 100);
            } else {
                // Test mode - remove from list
                systemState.rfidList = systemState.rfidList.filter(c => c.uid !== uid);
                updateRfidList();
                alertManager.show('rfid-deleted', `🗑️ Đã xóa thẻ RFID: ${card.name}`, 'success');
            }
        }

        // Reset scan buttons with ENHANCED FEEDBACK
        function resetFingerScanButton() {
            elements.btnFingerScan.innerHTML = '<i class="fas fa-fingerprint"></i><span>Bắt Đầu Test</span>';
            elements.btnFingerScan.disabled = systemState.isSystemLocked;
            elements.btnFingerStop.style.display = 'none';
            document.getElementById('fingerprintScanSection').classList.remove('scanning');
            
            elements.fingerprintScanStatus.textContent = systemState.isSystemLocked ? 
                'Hệ thống đã bị khóa' : 'Nhấn nút bên dưới để test quét vân tay';
            elements.fingerprintScanStatus.style.background = systemState.isSystemLocked ? 
                'var(--danger-color)' : 'var(--surface-light)';
            elements.fingerprintScanStatus.style.color = systemState.isSystemLocked ? 
                'white' : 'var(--text-primary)';
        }

        function resetRfidScanButton() {
            elements.btnRfidScan.innerHTML = '<i class="fas fa-id-card"></i><span>Test Quét Thẻ</span>';
            elements.btnRfidScan.disabled = systemState.isSystemLocked;
            elements.btnRfidStop.style.display = 'none';
            document.getElementById('rfidDetectSection').classList.remove('detecting');
            
            elements.rfidDetectionStatus.textContent = systemState.isSystemLocked ? 
                'Hệ thống đã bị khóa' : 'Nhấn nút để test quét thẻ RFID';
            elements.rfidDetectionStatus.style.background = systemState.isSystemLocked ? 
                'var(--danger-color)' : 'var(--surface-light)';
            elements.rfidDetectionStatus.style.color = systemState.isSystemLocked ? 
                'white' : 'var(--text-primary)';
        }

        // Tab switching with ENHANCED ANIMATION
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabName) {
                    tab.classList.add('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                if (content.id === `${tabName}Tab`) {
                    content.classList.add('active');
                }
            });
        }

        // Initialize tab listeners with ENHANCED INTERACTION
        function initializeTabs() {
            document.querySelectorAll('.tab-button').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const tabName = this.getAttribute('data-tab');
                    if (tabName) {
                        switchTab(tabName);
                        alertManager.show('tab-switched', `Chuyển sang tab ${tabName === 'fingerprint' ? 'Vân tay' : 'RFID'}`, 'info', 2000);
                    }
                });
            });
        }

        // Add entry to history with ENHANCED FORMATTING
        function addToHistory(method, id, name, result, action) {
            const now = new Date();
            const timestamp = now.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const historyItem = {
                timestamp,
                method,
                id,
                name,
                result,
                action
            };
            
            systemState.accessHistory.unshift(historyItem);
            
            // Keep only last 100 entries
            if (systemState.accessHistory.length > 100) {
                systemState.accessHistory = systemState.accessHistory.slice(0, 100);
            }
            
            updateHistoryTable();
        }

        // Update history table with ENHANCED FILTERING
        function updateHistoryTable() {
            if (systemState.accessHistory.length === 0) return;
            
            const newRows = systemState.accessHistory.slice(0, 20).map(item => {
                const methodClass = item.method.includes('Vân tay') ? 'fingerprint' : 
                                   item.method.includes('RFID') ? 'rfid' : 
                                   item.method.includes('Cảm biến') ? 'motion' : 'rfid';
                const methodIcon = item.method.includes('Vân tay') ? 'fingerprint' : 
                                  item.method.includes('RFID') ? 'id-card' : 
                                  item.method.includes('Cảm biến') ? 'radar' :
                                  item.method.includes('Thủ công') ? 'hand-paper' : 'id-card';
                
                return `
                    <tr>
                        <td>${item.timestamp}</td>
                        <td>
                            <span class="method-badge method-${methodClass}">
                                <i class="fas fa-${methodIcon}"></i>
                                ${item.method}
                            </span>
                        </td>
                        <td><code>${item.id}</code></td>
                        <td>${item.name}</td>
                        <td>
                            <span class="status-badge status-${item.result.includes('Thành công') ? 'success' : 'failed'}">
                                <i class="fas fa-${item.result.includes('Thành công') ? 'check' : 'times'}"></i>
                                ${item.result}
                            </span>
                        </td>
                        <td><span class="action-badge">${item.action}</span></td>
                    </tr>
                `;
            }).join('');
            
            // Keep existing demo data and add new entries
            const existingRows = elements.historyTableBody.innerHTML;
            if (existingRows.includes('Admin')) {
                elements.historyTableBody.innerHTML = newRows + existingRows;
            } else {
                elements.historyTableBody.innerHTML = newRows;
            }
        }

        // Apply history filter with ENHANCED LOGIC
        function applyHistoryFilter(date, method, result) {
            let filteredHistory = [...systemState.accessHistory];
            
            if (date) {
                filteredHistory = filteredHistory.filter(item => 
                    item.timestamp.includes(date.split('-').reverse().join('/'))
                );
            }
            
            if (method) {
                filteredHistory = filteredHistory.filter(item => {
                    switch (method) {
                        case 'fingerprint':
                            return item.method.includes('Vân tay');
                        case 'rfid':
                            return item.method.includes('RFID');
                        case 'motion':
                            return item.method.includes('Cảm biến');
                        case 'manual':
                            return item.method.includes('Thủ công');
                        default:
                            return true;
                    }
                });
            }
            
            if (result) {
                filteredHistory = filteredHistory.filter(item => {
                    if (result === 'success') {
                        return item.result.includes('Thành công');
                    } else if (result === 'failed') {
                        return item.result.includes('Thất bại');
                    }
                    return true;
                });
            }
            
            // Update table with filtered results
            const filteredRows = filteredHistory.slice(0, 50).map(item => {
                const methodClass = item.method.includes('Vân tay') ? 'fingerprint' : 
                                   item.method.includes('RFID') ? 'rfid' : 
                                   item.method.includes('Cảm biến') ? 'motion' : 'rfid';
                const methodIcon = item.method.includes('Vân tay') ? 'fingerprint' : 
                                  item.method.includes('RFID') ? 'id-card' : 
                                  item.method.includes('Cảm biến') ? 'radar' :
                                  item.method.includes('Thủ công') ? 'hand-paper' : 'id-card';
                
                return `
                    <tr>
                        <td>${item.timestamp}</td>
                        <td>
                            <span class="method-badge method-${methodClass}">
                                <i class="fas fa-${methodIcon}"></i>
                                ${item.method}
                            </span>
                        </td>
                        <td><code>${item.id}</code></td>
                        <td>${item.name}</td>
                        <td>
                            <span class="status-badge status-${item.result.includes('Thành công') ? 'success' : 'failed'}">
                                <i class="fas fa-${item.result.includes('Thành công') ? 'check' : 'times'}"></i>
                                ${item.result}
                            </span>
                        </td>
                        <td><span class="action-badge">${item.action}</span></td>
                    </tr>
                `;
            }).join('');
            
            elements.historyTableBody.innerHTML = filteredRows || '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">Không có dữ liệu phù hợp với bộ lọc</td></tr>';
        }

        // Initialize dashboard with COMPLETE SETUP
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Smart Door Dashboard v4.2 - Full Integration initialized');
            
            // Initialize tabs immediately
            initializeTabs();
            
            // Initialize UI and enable controls
            initializeUI();
            
            // Bind event listeners for test mode
            bindEventListeners();
            
            // Test focus on first input
            setTimeout(() => {
                const firstInput = document.querySelector('.input-field');
                if (firstInput) {
                    firstInput.focus();
                    console.log('First input focused for testing');
                }
            }, 2000);
            
            // Periodic system health check
            setInterval(() => {
                if (systemState.isConnected) {
                    // Check camera status periodically
                    if (systemState.cameraOnline) {
                        // Ping camera (in real implementation)
                    }
                    
                    // Auto-reset tries after 5 minutes if locked
                    if (systemState.isSystemLocked) {
                        setTimeout(() => {
                            updateTriesRemaining(3);
                            alertManager.show('system-unlocked', '🔓 Hệ thống đã tự động mở khóa', 'success');
                        }, 300000); // 5 minutes
                    }
                }
            }, 30000); // Check every 30 seconds
        });

        // Global functions for delete buttons
        window.deleteFingerprint = deleteFingerprint;
        window.deleteRfidCard = deleteRfidCard;
        
        // Global access for debugging
        window.systemState = systemState;
        window.alertManager = alertManager;
        window.operationManager = operationManager;
        window.eraWidget = eraWidget;
        
        console.log('🚀 Smart Door Dashboard v4.2 - Full Integration Ready!');
    </script>
</body>
</html>
