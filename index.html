<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Door Elite Control System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            --dark-gradient: linear-gradient(135deg, #232526 0%, #414345 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-soft: 0 8px 32px rgba(31, 38, 135, 0.37);
            --shadow-hover: 0 15px 35px rgba(31, 38, 135, 0.5);
            --text-primary: #2d3748;
            --text-secondary: #718096;
            --border-radius: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
            position: relative;
            z-index: 2;
        }

        .header h1 {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #fff, #e0e7ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-soft);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        }

        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .status-card {
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .status-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .status-card:hover::after {
            left: 100%;
        }

        .status-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            display: block;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        .status-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: white;
        }

        .status-label {
            font-size: 0.9rem;
            opacity: 0.8;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .main-dashboard {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 0;
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }

        .door-control-section {
            background: var(--primary-gradient);
            padding: 40px;
            color: white;
            position: relative;
        }

        .door-control-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><radialGradient id="a"><stop offset="20%" stop-color="%23fff" stop-opacity="0.1"/><stop offset="100%" stop-color="%23fff" stop-opacity="0"/></radialGradient></defs><circle fill="url(%23a)" cx="10" cy="10" r="10"/><circle fill="url(%23a)" cx="50" cy="10" r="10"/><circle fill="url(%23a)" cx="90" cy="10" r="10"/></svg>') repeat;
            opacity: 0.1;
        }

        .door-status-display {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
            z-index: 2;
        }

        .door-icon {
            font-size: 8rem;
            margin-bottom: 20px;
            display: block;
            animation: pulse 2s infinite;
            filter: drop-shadow(0 8px 16px rgba(0,0,0,0.3));
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .door-status-text {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .door-timestamp {
            font-size: 1rem;
            opacity: 0.8;
        }

        .control-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
            position: relative;
            z-index: 2;
        }

        .control-btn {
            padding: 18px 35px;
            border: none;
            border-radius: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            min-width: 160px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
        }

        .control-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .control-btn:hover:before {
            left: 100%;
        }

        .control-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .control-btn:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-open {
            background: var(--success-gradient);
        }

        .btn-close {
            background: var(--secondary-gradient);
        }

        .btn-emergency {
            background: var(--warning-gradient);
            color: var(--text-primary);
        }

        .tabs-section {
            padding: 40px;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8fafc;
            border-radius: 15px;
            padding: 8px;
            position: relative;
        }

        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            position: relative;
            color: var(--text-secondary);
        }

        .tab-btn.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .sensor-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            transition: var(--transition);
        }

        .sensor-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .sensor-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sensor-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .activity-log {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .log-header {
            background: var(--primary-gradient);
            color: white;
            padding: 20px;
            font-weight: 600;
        }

        .log-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            transition: var(--transition);
        }

        .log-entry:hover {
            background: #f8fafc;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-icon {
            font-size: 1.2rem;
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        .log-success .log-icon {
            color: #10b981;
        }

        .log-error .log-icon {
            color: #ef4444;
        }

        .log-time {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .management-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .management-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-success {
            background: var(--success-gradient);
            color: white;
        }

        .btn-danger {
            background: var(--secondary-gradient);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .data-table th {
            background: var(--primary-gradient);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table tr:hover {
            background: #f8fafc;
        }

        .real-time-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            display: inline-block;
            margin-right: 8px;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .video-container {
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            height: 300px;
            position: relative;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .video-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: white;
            flex-direction: column;
            background: linear-gradient(45deg, #232526, #414345);
        }

        .floating-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .floating-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            color: white;
            border: none;
            cursor: pointer;
            margin-bottom: 15px;
            display: block;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-online {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-offline {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .error-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px;
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 10px;
            color: #dc2626;
            font-weight: 600;
            z-index: 9999;
            display: none;
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            left: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5rem;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .management-section {
                grid-template-columns: 1fr;
            }
            
            .control-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .door-icon {
                font-size: 6rem;
            }
        }

        .era-hidden {
            display: block;
        }

        /* E-Ra embedded styles */
        .era-embedded .header {
            margin-bottom: 20px;
        }

        .era-embedded .header h1 {
            font-size: 2.5rem;
        }

        .era-embedded .floating-controls {
            display: none;
        }

        .era-status {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            z-index: 10000;
            font-family: monospace;
        }

        .era-connected {
            background: rgba(16, 185, 129, 0.9) !important;
        }

        .era-disconnected {
            background: rgba(239, 68, 68, 0.9) !important;
        }
    </style>
</head>
<body>
    <!-- E-Ra Status Indicator -->
    <div id="eraStatus" class="era-status era-disconnected">E-Ra: Disconnected</div>

    <!-- Error Indicator -->
    <div id="errorIndicator" class="error-indicator">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="errorMessage">C√≥ l·ªói x·∫£y ra</span>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status status-offline">
        <i class="fas fa-wifi"></i> ƒêang k·∫øt n·ªëi...
    </div>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-door-open"></i> Smart Door Elite</h1>
            <p>H·ªá th·ªëng ki·ªÉm so√°t c·ª≠a th√¥ng minh t√≠ch h·ª£p E-Ra Platform</p>
        </div>

        <!-- Status Overview -->
        <div class="status-grid">
            <div class="glass-card status-card" style="background: var(--success-gradient);">
                <i class="fas fa-door-closed status-icon" id="doorStatusIcon"></i>
                <div class="status-value" id="doorStatus">ƒê√≥ng</div>
                <div class="status-label">Tr·∫°ng th√°i c·ª≠a</div>
                <div class="status-indicator status-online" id="doorIndicator">
                    <span class="real-time-indicator"></span>
                    Ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng
                </div>
            </div>
            
            <div class="glass-card status-card" style="background: var(--primary-gradient);">
                <i class="fas fa-fingerprint status-icon"></i>
                <div class="status-value"><span id="fingerprintCount">0</span> / <span id="rfidCount">0</span></div>
                <div class="status-label">V√¢n tay / Th·∫ª t·ª´</div>
                <div class="status-indicator status-online">
                    <span class="real-time-indicator"></span>
                    ƒê√£ ƒëƒÉng k√Ω
                </div>
            </div>
            
            <div class="glass-card status-card" style="background: var(--warning-gradient);">
                <i class="fas fa-exclamation-triangle status-icon"></i>
                <div class="status-value" id="alertCount">0</div>
                <div class="status-label">C·∫£nh b√°o b·∫£o m·∫≠t</div>
                <div class="status-indicator" id="securityIndicator">
                    <span class="real-time-indicator"></span>
                    An to√†n
                </div>
            </div>
            
            <div class="glass-card status-card" style="background: var(--dark-gradient);">
                <i class="fas fa-clock status-icon"></i>
                <div class="status-value" id="currentTime">--:--</div>
                <div class="status-label">Th·ªùi gian hi·ªán t·∫°i</div>
                <div class="status-indicator status-online">
                    <span class="real-time-indicator"></span>
                    ƒê·ªìng b·ªô
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="glass-card main-dashboard">
            <!-- Door Control Section -->
            <div class="door-control-section">
                <div class="door-status-display">
                    <i class="fas fa-door-closed door-icon" id="mainDoorIcon"></i>
                    <div class="door-status-text" id="mainDoorStatus">C·ª≠a ƒëang ƒë√≥ng</div>
                    <div class="door-timestamp" id="lastAccess">L·∫ßn cu·ªëi: --:--</div>
                </div>
                
                <div class="control-buttons">
                    <button class="control-btn btn-open" onclick="openDoor()" id="openBtn">
                        <i class="fas fa-door-open"></i> M·ªü c·ª≠a
                    </button>
                    <button class="control-btn btn-close" onclick="closeDoor()" id="closeBtn">
                        <i class="fas fa-door-closed"></i> ƒê√≥ng c·ª≠a
                    </button>
                    <button class="control-btn btn-emergency" onclick="emergencyStop()" id="emergencyBtn">
                        <i class="fas fa-hand-paper"></i> D·ª´ng kh·∫©n c·∫•p
                    </button>
                </div>
                
                <div id="doorControlStatus" style="text-align: center; margin-top: 20px; font-weight: 600;"></div>
            </div>

            <!-- Tabs Section -->
            <div class="tabs-section">
                <div class="tabs">
                    <button class="tab-btn active" onclick="showTab('overview')">
                        <i class="fas fa-tachometer-alt"></i> T·ªïng quan
                    </button>
                    <button class="tab-btn" onclick="showTab('sensors')">
                        <i class="fas fa-microchip"></i> C·∫£m bi·∫øn
                    </button>
                    <button class="tab-btn" onclick="showTab('management')">
                        <i class="fas fa-users-cog"></i> Qu·∫£n l√Ω
                    </button>
                    <button class="tab-btn" onclick="showTab('history')">
                        <i class="fas fa-history"></i> L·ªãch s·ª≠
                    </button>
                </div>

                <!-- Overview Tab -->
                <div id="overview" class="tab-content active">
                    <div class="video-container">
                        <div class="video-placeholder" id="videoPlaceholder">
                            <i class="fas fa-video" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <p style="font-size: 1.2rem; margin-bottom: 10px;">ESP32-CAM Live Stream</p>
                            <button class="btn btn-primary" onclick="startVideoStream()">
                                <i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu stream
                            </button>
                        </div>
                        <iframe id="videoStream" style="width: 100%; height: 100%; border: none; display: none;"></iframe>
                    </div>
                    
                    <div class="activity-log">
                        <div class="log-header">
                            <i class="fas fa-list-alt"></i> Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y
                        </div>
                        <div id="recentActivity">
                            <div class="log-entry log-success">
                                <div>
                                    <i class="fas fa-check-circle log-icon"></i>
                                    <span>H·ªá th·ªëng kh·ªüi ƒë·ªông th√†nh c√¥ng</span>
                                </div>
                                <span class="log-time" id="startupTime">--:--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sensors Tab -->
                <div id="sensors" class="tab-content">
                    <div class="sensor-grid">
                        <div class="sensor-card">
                            <div class="sensor-label">
                                <i class="fas fa-toggle-on"></i> C√¥ng t·∫Øc m·ªü
                            </div>
                            <div class="sensor-value" id="limitSwitchOpen">Ch∆∞a k√≠ch ho·∫°t</div>
                        </div>
                        <div class="sensor-card">
                            <div class="sensor-label">
                                <i class="fas fa-toggle-off"></i> C√¥ng t·∫Øc ƒë√≥ng
                            </div>
                            <div class="sensor-value" id="limitSwitchClose">K√≠ch ho·∫°t</div>
                        </div>
                        <div class="sensor-card">
                            <div class="sensor-label">
                                <i class="fas fa-running"></i> C·∫£m bi·∫øn chuy·ªÉn ƒë·ªông
                            </div>
                            <div class="sensor-value" id="motionStatus">Kh√¥ng ph√°t hi·ªán</div>
                        </div>
                        <div class="sensor-card">
                            <div class="sensor-label">
                                <i class="fas fa-stopwatch"></i> Auto-lock timer
                            </div>
                            <div class="sensor-value"><span id="autoLockTimer">--</span>s</div>
                        </div>
                    </div>
                    
                    <div class="sensor-card">
                        <h3 style="margin-bottom: 20px;"><i class="fas fa-cogs"></i> C√†i ƒë·∫∑t c·∫£m bi·∫øn</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <label style="display: flex; align-items: center; font-weight: 600;">
                                <input type="checkbox" id="autoLockEnabled" checked onchange="toggleAutoLock()" style="margin-right: 10px;">
                                T·ª± ƒë·ªông ƒë√≥ng c·ª≠a
                            </label>
                            <label style="display: flex; align-items: center; font-weight: 600;">
                                <input type="checkbox" id="motionDetectionEnabled" checked onchange="toggleMotionDetection()" style="margin-right: 10px;">
                                Ph√°t hi·ªán chuy·ªÉn ƒë·ªông
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Management Tab -->
                <div id="management" class="tab-content">
                    <div class="management-section">
                        <div class="management-card">
                            <h3><i class="fas fa-fingerprint"></i> Qu·∫£n l√Ω v√¢n tay</h3>
                            <div class="form-group">
                                <label class="form-label">ID v√¢n tay (1-127):</label>
                                <input type="number" class="form-input" id="fingerprintId" min="1" max="127" placeholder="Nh·∫≠p ID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">T√™n ng∆∞·ªùi d√πng:</label>
                                <input type="text" class="form-input" id="fingerprintName" placeholder="T√™n ng∆∞·ªùi d√πng">
                            </div>
                            <button class="btn btn-primary" onclick="enrollFingerprint()">
                                <i class="fas fa-plus"></i> ƒêƒÉng k√Ω v√¢n tay
                            </button>
                            <button class="btn btn-success" onclick="testFingerprintScan()" style="margin-left: 10px;">
                                <i class="fas fa-search"></i> Test qu√©t
                            </button>
                            <div id="enrollStatus" style="margin-top: 15px; font-weight: 600;"></div>
                        </div>
                        
                        <div class="management-card">
                            <h3><i class="fas fa-id-card"></i> Qu·∫£n l√Ω RFID</h3>
                            <div class="form-group">
                                <label class="form-label">UID th·∫ª:</label>
                                <input type="text" class="form-input" id="rfidUid" placeholder="Qu√©t th·∫ª ho·∫∑c nh·∫≠p UID">
                            </div>
                            <div class="form-group">
                                <label class="form-label">T√™n ch·ªß th·∫ª:</label>
                                <input type="text" class="form-input" id="rfidName" placeholder="T√™n ch·ªß th·∫ª">
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-success" onclick="scanRfidCard()">
                                    <i class="fas fa-search"></i> Qu√©t th·∫ª
                                </button>
                                <button class="btn btn-primary" onclick="addRfidCard()">
                                    <i class="fas fa-plus"></i> Th√™m th·∫ª
                                </button>
                            </div>
                            <div id="rfidStatus" style="margin-top: 15px; font-weight: 600;"></div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                        <div class="management-card">
                            <h4><i class="fas fa-fingerprint"></i> Danh s√°ch v√¢n tay</h4>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>T√™n</th>
                                        <th>Ng√†y t·∫°o</th>
                                        <th>Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody id="fingerprintList">
                                    <tr>
                                        <td>1</td>
                                        <td>Admin</td>
                                        <td>01/01/2025</td>
                                        <td><button class="btn btn-danger" onclick="deleteFingerprint(1)"><i class="fas fa-trash"></i></button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="management-card">
                            <h4><i class="fas fa-id-card"></i> Danh s√°ch RFID</h4>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>UID</th>
                                        <th>T√™n</th>
                                        <th>Ng√†y t·∫°o</th>
                                        <th>Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody id="rfidList">
                                    <tr>
                                        <td>04:52:F2:AA</td>
                                        <td>User Demo</td>
                                        <td>01/01/2025</td>
                                        <td><button class="btn btn-danger" onclick="deleteRfidCard('04:52:F2:AA')"><i class="fas fa-trash"></i></button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="history" class="tab-content">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px; gap: 20px;">
                        <div style="flex: 1;">
                            <label class="form-label">L·ªçc theo ng√†y:</label>
                            <input type="date" class="form-input" id="filterDate" style="max-width: 200px;">
                        </div>
                        <div>
                            <button class="btn btn-primary" onclick="filterHistory()">
                                <i class="fas fa-filter"></i> L·ªçc
                            </button>
                            <button class="btn btn-success" onclick="exportHistory()">
                                <i class="fas fa-download"></i> Xu·∫•t Excel
                            </button>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Th·ªùi gian</th>
                                <th>Ph∆∞∆°ng th·ª©c</th>
                                <th>ID/UID</th>
                                <th>T√™n</th>
                                <th>K·∫øt qu·∫£</th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="historyList">
                            <tr>
                                <td>12/06/2025 10:30:15</td>
                                <td><i class="fas fa-fingerprint"></i> V√¢n tay</td>
                                <td>ID #1</td>
                                <td>Admin</td>
                                <td style="color: #10b981;"><i class="fas fa-check-circle"></i> Th√†nh c√¥ng</td>
                                <td>M·ªü c·ª≠a</td>
                            </tr>
                            <tr>
                                <td>12/06/2025 09:45:22</td>
                                <td><i class="fas fa-id-card"></i> RFID</td>
                                <td>04:XX:XX:XX</td>
                                <td>Kh√¥ng x√°c ƒë·ªãnh</td>
                                <td style="color: #ef4444;"><i class="fas fa-times-circle"></i> T·ª´ ch·ªëi</td>
                                <td>C·∫£nh b√°o</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Controls -->
    <div class="floating-controls era-hidden">
        <button class="floating-btn" onclick="refreshData()" title="L√†m m·ªõi d·ªØ li·ªáu">
            <i class="fas fa-sync-alt"></i>
        </button>
        <button class="floating-btn" onclick="toggleFullscreen()" title="To√†n m√†n h√¨nh">
            <i class="fas fa-expand"></i>
        </button>
    </div>

    <!-- Load E-Ra Widget Script FIRST - EXACT t·ª´ v√≠ d·ª• -->
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
    
    <script>
        // Global variables - THEO ƒê√öNG PATTERN E-RA V√ç D·ª§
        const eraWidget = new EraWidget();

        // L·∫•y c√°c ph·∫ßn t·ª≠ HTML d·ª±a tr√™n ID, li√™n k·∫øt v·ªõi giao di·ªán ng∆∞·ªùi d√πng
        const doorStatus = document.getElementById("doorStatus");
        const mainDoorStatus = document.getElementById("mainDoorStatus"); 
        const fingerprintCount = document.getElementById("fingerprintCount");
        const rfidCount = document.getElementById("rfidCount");
        const alertCount = document.getElementById("alertCount");
        const currentTime = document.getElementById("currentTime");

        // E-Ra Configuration Variables - THEO PATTERN V√ç D·ª§
        let configDoorStatus = null,
            configSystemStatus = null,
            configFailedAttempts = null,
            configSecurityAlert = null,
            configFingerprintStatus = null,
            configRFIDStatus = null,
            configAccessLog = null,
            configCameraStatus = null,
            configCameraSystemStatus = null,
            configLastCapture = null;

        // Actions cho door control - THEO PATTERN V√ç D·ª§  
        let actionOpenDoor = null,
            actionCloseDoor = null,
            actionEmergencyStop = null;

        // System state
        let systemState = {
            doorOpen: false,
            doorMoving: false,
            failedAttempts: 0,
            autoLockEnabled: true,
            motionDetectionEnabled: true,
            fingerprintCountValue: 1,
            rfidCountValue: 1,
            connected: false,
            cameraConnected: false,
            currentDoorStatus: 'closed'
        };

        // Initialize E-Ra Widget - ƒê√öNG THEO V√ç D·ª§
        eraWidget.init({
            onConfiguration: (configuration) => {
                console.log('üìã E-Ra Configuration received:', configuration);
                
                // L∆∞u c√°c c·∫•u h√¨nh khi nh·∫≠n ƒë∆∞·ª£c t·ª´ widget - THEO V√ç D·ª§
                try {
                    // Realtime configs mapping - theo th·ª© t·ª± trong E-Ra dashboard
                    if (configuration.realtime_configs && configuration.realtime_configs.length > 0) {
                        configDoorStatus = configuration.realtime_configs[0];           // V0: Door Status
                        configSystemStatus = configuration.realtime_configs[1];        // V2: System Status  
                        configFailedAttempts = configuration.realtime_configs[2];      // V3: Failed Attempts
                        configSecurityAlert = configuration.realtime_configs[3];       // V4: Security Alert
                        configFingerprintStatus = configuration.realtime_configs[4];   // V5: Fingerprint Status
                        configRFIDStatus = configuration.realtime_configs[5];          // V6: RFID Status
                        configAccessLog = configuration.realtime_configs[6];           // V7: Access Log
                        configCameraStatus = configuration.realtime_configs[7];        // V10: Camera Status
                        configCameraSystemStatus = configuration.realtime_configs[8]; // V13: Camera System Status
                        configLastCapture = configuration.realtime_configs[9];         // V14: Last Capture
                        
                        console.log('‚úÖ Realtime configs mapped successfully');
                    }
                    
                    // Actions mapping - theo th·ª© t·ª± trong E-Ra dashboard
                    if (configuration.actions && configuration.actions.length > 0) {
                        actionOpenDoor = configuration.actions[0];        // Action: Open Door
                        actionCloseDoor = configuration.actions[1];       // Action: Close Door  
                        actionEmergencyStop = configuration.actions[2];   // Action: Emergency Stop
                        
                        console.log('‚úÖ Actions mapped successfully');
                    }
                    
                    updateEraStatus('ƒê√£ c·∫•u h√¨nh', true);
                    
                } catch (error) {
                    console.error('‚ùå Error mapping E-Ra configuration:', error);
                    showError('L·ªói c·∫•u h√¨nh E-Ra: ' + error.message);
                    updateEraStatus('L·ªói c·∫•u h√¨nh', false);
                }
            },

            // H√†m l·∫•y gi√° tr·ªã t·ª´ c√°c ID v√† c·∫≠p nh·∫≠t giao di·ªán - ƒê√öNG THEO V√ç D·ª§
            onValues: (values) => {
                try {
                    console.log('üìä E-Ra Values received:', values);
                    
                    // Update door status - THEO PATTERN V√ç D·ª§
                    if (configDoorStatus && values[configDoorStatus.id]) {
                        const doorStatusValue = values[configDoorStatus.id].value;
                        console.log('üö™ Door status from E-Ra:', doorStatusValue);
                        
                        // Ki·ªÉm tra n·∫øu gi√° tr·ªã kh√°c v·ªõi tr·∫°ng th√°i hi·ªán t·∫°i th√¨ c·∫≠p nh·∫≠t
                        if (systemState.currentDoorStatus !== doorStatusValue) {
                            systemState.currentDoorStatus = doorStatusValue;
                            updateDoorStatusFromERA(doorStatusValue);
                        }
                    }

                    // Update failed attempts
                    if (configFailedAttempts && values[configFailedAttempts.id]) {
                        const failedAttemptsValue = values[configFailedAttempts.id].value;
                        systemState.failedAttempts = failedAttemptsValue;
                        alertCount.textContent = failedAttemptsValue;
                        updateSecurityIndicator(failedAttemptsValue);
                    }

                    // Update system status
                    if (configSystemStatus && values[configSystemStatus.id]) {
                        const systemStatusValue = values[configSystemStatus.id].value;
                        if (systemStatusValue && systemStatusValue.trim() !== '') {
                            updateSystemStatusFromERA(systemStatusValue);
                        }
                    }

                    // Update security alerts
                    if (configSecurityAlert && values[configSecurityAlert.id]) {
                        const alertValue = values[configSecurityAlert.id].value;
                        if (alertValue && alertValue.trim() !== '') {
                            showAlert(alertValue, 'danger');
                        }
                    }

                    // Update fingerprint status
                    if (configFingerprintStatus && values[configFingerprintStatus.id]) {
                        const fingerprintStatusValue = values[configFingerprintStatus.id].value;
                        if (fingerprintStatusValue && fingerprintStatusValue.trim() !== '') {
                            handleFingerprintStatusFromERA(fingerprintStatusValue);
                        }
                    }

                    // Update RFID status
                    if (configRFIDStatus && values[configRFIDStatus.id]) {
                        const rfidStatusValue = values[configRFIDStatus.id].value;
                        if (rfidStatusValue && rfidStatusValue.trim() !== '') {
                            handleRFIDStatusFromERA(rfidStatusValue);
                        }
                    }

                    // Update access log
                    if (configAccessLog && values[configAccessLog.id]) {
                        const accessLogValue = values[configAccessLog.id].value;
                        if (accessLogValue && accessLogValue.trim() !== '') {
                            updateAccessLogFromERA(accessLogValue);
                        }
                    }

                    // Update camera status
                    if (configCameraStatus && values[configCameraStatus.id]) {
                        const cameraStatusValue = values[configCameraStatus.id].value;
                        updateCameraStatusFromERA(cameraStatusValue);
                    }

                    // Update camera system status
                    if (configCameraSystemStatus && values[configCameraSystemStatus.id]) {
                        const cameraSystemValue = values[configCameraSystemStatus.id].value;
                        if (cameraSystemValue && cameraSystemValue.trim() !== '') {
                            updateCameraSystemStatusFromERA(cameraSystemValue);
                        }
                    }

                    // Update last capture
                    if (configLastCapture && values[configLastCapture.id]) {
                        const lastCaptureValue = values[configLastCapture.id].value;
                        if (lastCaptureValue && lastCaptureValue.trim() !== '') {
                            updateLastCaptureFromERA(lastCaptureValue);
                        }
                    }

                    // Update connection status
                    if (!systemState.connected) {
                        systemState.connected = true;
                        updateConnectionStatus(true);
                        updateEraStatus('ƒê√£ k·∫øt n·ªëi', true);
                    }

                } catch (error) {
                    console.error('‚ùå Error handling E-Ra values:', error);
                    showError('L·ªói x·ª≠ l√Ω d·ªØ li·ªáu t·ª´ E-Ra: ' + error.message);
                }
            },

            onError: (error) => {
                console.error('‚ùå E-Ra Widget Error:', error);
                showError('L·ªói E-Ra: ' + (error.message || error));
                updateEraStatus('L·ªói k·∫øt n·ªëi', false);
                systemState.connected = false;
                updateConnectionStatus(false);
            }
        });

        // Function: ƒêi·ªÅu khi·ªÉn c·ª≠a qua E-Ra Actions - THEO PATTERN V√ç D·ª§
        function triggerDoorAction(actionType) {
            try {
                let action = null;
                let actionName = '';

                switch(actionType) {
                    case 'open':
                        action = actionOpenDoor;
                        actionName = 'M·ªü c·ª≠a';
                        break;
                    case 'close':
                        action = actionCloseDoor;
                        actionName = 'ƒê√≥ng c·ª≠a';
                        break;
                    case 'emergency':
                        action = actionEmergencyStop;
                        actionName = 'D·ª´ng kh·∫©n c·∫•p';
                        break;
                }

                if (action && action.action) {
                    console.log(`üé¨ Triggering ${actionName} action:`, action.action);
                    eraWidget.triggerAction(action.action, null);
                    showAlert(`ƒê√£ g·ª≠i l·ªánh ${actionName}`, 'info');
                    return true;
                } else {
                    console.warn(`‚ö†Ô∏è No action configured for ${actionType}`);
                    showAlert(`Kh√¥ng t√¨m th·∫•y action cho ${actionName}`, 'warning');
                    return false;
                }
            } catch (error) {
                console.error(`‚ùå Error triggering ${actionType} action:`, error);
                showError(`L·ªói g·ª≠i l·ªánh ${actionType}: ` + error.message);
                return false;
            }
        }

        // Door control functions - S·ª¨ D·ª§NG E-RA ACTIONS
        async function openDoor() {
            if (systemState.doorMoving || systemState.doorOpen) {
                showAlert('C·ª≠a ƒë√£ m·ªü ho·∫∑c ƒëang di chuy·ªÉn!', 'warning');
                return;
            }
            
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën m·ªü c·ª≠a?')) {
                console.log('üö™ Sending open door action to E-Ra');
                
                if (triggerDoorAction('open')) {
                    // Simulate local update if needed
                    if (!systemState.connected) {
                        await openDoorAction();
                    }
                } else {
                    showAlert('Kh√¥ng th·ªÉ g·ª≠i l·ªánh m·ªü c·ª≠a', 'danger');
                }
            }
        }

        async function closeDoor() {
            if (systemState.doorMoving || !systemState.doorOpen) {
                showAlert('C·ª≠a ƒë√£ ƒë√≥ng ho·∫∑c ƒëang di chuy·ªÉn!', 'warning');
                return;
            }
            
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒë√≥ng c·ª≠a?')) {
                console.log('üö™ Sending close door action to E-Ra');
                
                if (triggerDoorAction('close')) {
                    // Simulate local update if needed
                    if (!systemState.connected) {
                        await closeDoorAction();
                    }
                } else {
                    showAlert('Kh√¥ng th·ªÉ g·ª≠i l·ªánh ƒë√≥ng c·ª≠a', 'danger');
                }
            }
        }

        async function emergencyStop() {
            if (confirm('‚ö†Ô∏è D·ª™NG KH·∫®N C·∫§P! B·∫°n c√≥ ch·∫Øc ch·∫Øn?')) {
                console.log('üõë Sending emergency stop action to E-Ra');
                
                if (triggerDoorAction('emergency')) {
                    // Simulate local update if needed
                    if (!systemState.connected) {
                        await emergencyStopAction();
                    }
                } else {
                    showAlert('Kh√¥ng th·ªÉ g·ª≠i l·ªánh d·ª´ng kh·∫©n c·∫•p', 'danger');
                }
            }
        }

        // Update functions for E-Ra data
        function updateDoorStatusFromERA(status) {
            console.log('üö™ Updating door status from E-Ra:', status);
            
            const doorIcon = document.getElementById('doorStatusIcon');
            const mainIcon = document.getElementById('mainDoorIcon');
            const doorIndicator = document.getElementById('doorIndicator');
            
            switch(status) {
                case 'open':
                    systemState.doorOpen = true;
                    systemState.doorMoving = false;
                    doorStatus.textContent = 'M·ªü';
                    mainDoorStatus.textContent = 'C·ª≠a ƒëang m·ªü';
                    doorIcon.className = 'fas fa-door-open status-icon';
                    mainIcon.className = 'fas fa-door-open door-icon';
                    doorIndicator.innerHTML = '<span class="real-time-indicator"></span>Ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng';
                    break;
                case 'closed':
                    systemState.doorOpen = false;
                    systemState.doorMoving = false;
                    doorStatus.textContent = 'ƒê√≥ng';
                    mainDoorStatus.textContent = 'C·ª≠a ƒëang ƒë√≥ng';
                    doorIcon.className = 'fas fa-door-closed status-icon';
                    mainIcon.className = 'fas fa-door-closed door-icon';
                    doorIndicator.innerHTML = '<span class="real-time-indicator"></span>Ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng';
                    break;
                case 'opening':
                case 'closing':
                case 'moving':
                    systemState.doorMoving = true;
                    doorStatus.textContent = 'ƒêang di chuy·ªÉn';
                    mainDoorStatus.textContent = 'C·ª≠a ƒëang di chuy·ªÉn';
                    doorIcon.className = 'fas fa-spinner fa-spin status-icon';
                    mainIcon.className = 'fas fa-spinner fa-spin door-icon';
                    doorIndicator.innerHTML = '<span class="real-time-indicator"></span>ƒêang x·ª≠ l√Ω';
                    break;
                case 'stopped':
                    systemState.doorMoving = false;
                    doorStatus.textContent = 'D·ª´ng kh·∫©n c·∫•p';
                    mainDoorStatus.textContent = 'H·ªá th·ªëng d·ª´ng kh·∫©n c·∫•p';
                    doorIcon.className = 'fas fa-hand-paper status-icon';
                    mainIcon.className = 'fas fa-hand-paper door-icon';
                    doorIndicator.innerHTML = '<span class="real-time-indicator"></span>D·ª´ng kh·∫©n c·∫•p';
                    showAlert('H·ªá th·ªëng ƒë√£ d·ª´ng kh·∫©n c·∫•p!', 'danger');
                    break;
                default:
                    console.warn('‚ö†Ô∏è Unknown door status:', status);
            }
            
            updateLastAccess();
        }

        function updateSecurityIndicator(failedAttempts) {
            const indicator = document.getElementById('securityIndicator');
            if (failedAttempts >= 5) {
                indicator.className = 'status-indicator status-offline';
                indicator.innerHTML = '<span class="real-time-indicator"></span>H·ªá th·ªëng kh√≥a';
            } else if (failedAttempts > 0) {
                indicator.className = 'status-indicator status-offline';
                indicator.innerHTML = '<span class="real-time-indicator"></span>C·∫£nh b√°o';
            } else {
                indicator.className = 'status-indicator status-online';
                indicator.innerHTML = '<span class="real-time-indicator"></span>An to√†n';
            }
        }

        function updateSystemStatusFromERA(statusJson) {
            try {
                console.log('üìä Updating system status from E-Ra:', statusJson);
                
                const status = JSON.parse(statusJson);
                
                // Update fingerprint and RFID counts
                if (status.fingerprint_count !== undefined) {
                    systemState.fingerprintCountValue = status.fingerprint_count;
                    fingerprintCount.textContent = status.fingerprint_count;
                }
                
                if (status.rfid_count !== undefined) {
                    systemState.rfidCountValue = status.rfid_count;
                    rfidCount.textContent = status.rfid_count;
                }
                
                // Update auto-lock settings
                if (status.auto_lock_enabled !== undefined) {
                    systemState.autoLockEnabled = status.auto_lock_enabled;
                    document.getElementById('autoLockEnabled').checked = status.auto_lock_enabled;
                }
                
                // Update motion detection settings
                if (status.motion_detection_enabled !== undefined) {
                    systemState.motionDetectionEnabled = status.motion_detection_enabled;
                    document.getElementById('motionDetectionEnabled').checked = status.motion_detection_enabled;
                }
                
            } catch (e) {
                console.error('‚ùå Error parsing system status from E-Ra:', e);
            }
        }

        function handleFingerprintStatusFromERA(status) {
            console.log('üëÜ Fingerprint status from E-Ra:', status);
            
            const enrollStatusEl = document.getElementById('enrollStatus');
            
            if (status.startsWith('STEP1:')) {
                enrollStatusEl.innerHTML = 'üëÜ ' + status.substring(6);
                enrollStatusEl.style.color = '#667eea';
            } else if (status.startsWith('STEP1_OK:')) {
                enrollStatusEl.innerHTML = '‚úÖ ' + status.substring(9);
                enrollStatusEl.style.color = '#10b981';
            } else if (status.startsWith('SUCCESS:')) {
                enrollStatusEl.innerHTML = 'üéâ ' + status.substring(8);
                enrollStatusEl.style.color = '#10b981';
                systemState.fingerprintCountValue++;
                fingerprintCount.textContent = systemState.fingerprintCountValue;
                
                // Clear form
                document.getElementById('fingerprintId').value = '';
                document.getElementById('fingerprintName').value = '';
                
                setTimeout(() => {
                    enrollStatusEl.innerHTML = '';
                }, 5000);
            } else if (status.startsWith('ERROR:')) {
                enrollStatusEl.innerHTML = '‚ùå ' + status.substring(6);
                enrollStatusEl.style.color = '#ef4444';
                
                setTimeout(() => {
                    enrollStatusEl.innerHTML = '';
                }, 5000);
            } else if (status.startsWith('DETECTED:')) {
                const detected = status.substring(9);
                showAlert('V√¢n tay ƒë∆∞·ª£c ph√°t hi·ªán: ' + detected, 'info');
            } else if (status === 'NO_FINGER:No finger detected') {
                showAlert('Kh√¥ng ph√°t hi·ªán v√¢n tay, vui l√≤ng ƒë·∫∑t ng√≥n tay l√™n c·∫£m bi·∫øn', 'warning');
            }
        }

        function handleRFIDStatusFromERA(status) {
            console.log('üè∑Ô∏è RFID status from E-Ra:', status);
            
            const rfidStatusEl = document.getElementById('rfidStatus');
            
            if (status.startsWith('SCANNED:')) {
                const uid = status.substring(8);
                document.getElementById('rfidUid').value = uid;
                rfidStatusEl.innerHTML = '‚úÖ ƒê√£ qu√©t th·∫ª: ' + uid;
                rfidStatusEl.style.color = '#10b981';
                
                setTimeout(() => {
                    rfidStatusEl.innerHTML = '';
                }, 3000);
            } else if (status === 'NO_CARD:No card detected') {
                rfidStatusEl.innerHTML = '‚ùå Kh√¥ng t√¨m th·∫•y th·∫ª, vui l√≤ng th·ª≠ l·∫°i';
                rfidStatusEl.style.color = '#ef4444';
                
                setTimeout(() => {
                    rfidStatusEl.innerHTML = '';
                }, 3000);
            } else if (status.startsWith('SUCCESS:')) {
                rfidStatusEl.innerHTML = '‚úÖ ' + status.substring(8);
                rfidStatusEl.style.color = '#10b981';
                systemState.rfidCountValue++;
                rfidCount.textContent = systemState.rfidCountValue;
                
                setTimeout(() => {
                    rfidStatusEl.innerHTML = '';
                }, 3000);
            } else if (status.startsWith('ERROR:')) {
                rfidStatusEl.innerHTML = '‚ùå ' + status.substring(6);
                rfidStatusEl.style.color = '#ef4444';
                
                setTimeout(() => {
                    rfidStatusEl.innerHTML = '';
                }, 3000);
            }
        }

        function updateAccessLogFromERA(logJson) {
            try {
                console.log('üìù Access log from E-Ra:', logJson);
                
                const log = JSON.parse(logJson);
                addRecentActivityFromERA(log);
            } catch (e) {
                console.error('‚ùå Error parsing access log from E-Ra:', e);
            }
        }

        function addRecentActivityFromERA(logData) {
            const container = document.getElementById('recentActivity');
            const entry = document.createElement('div');
            entry.className = `log-entry ${logData.success ? 'log-success' : 'log-error'}`;
            
            const icon = logData.success ? 'fas fa-check-circle' : 'fas fa-times-circle';
            const methodIcon = logData.method === 'fingerprint' ? 'fas fa-fingerprint' : 
                              logData.method === 'rfid' ? 'fas fa-id-card' : 'fas fa-cog';
            
            entry.innerHTML = `
                <div>
                    <i class="${icon} log-icon"></i>
                    <i class="${methodIcon}" style="margin-right: 8px;"></i>
                    <span>${logData.method === 'fingerprint' ? 'V√¢n tay' : 
                           logData.method === 'rfid' ? 'RFID' : 'H·ªá th·ªëng'} 
                           ${logData.id} - ${logData.name} - ${logData.action}</span>
                </div>
                <span class="log-time">${new Date(logData.timestamp).toLocaleTimeString('vi-VN')}</span>
            `;
            
            container.insertBefore(entry, container.firstChild);
            
            // Keep only last 10 entries
            const entries = container.querySelectorAll('.log-entry');
            if (entries.length > 10) {
                container.removeChild(entries[entries.length - 1]);
            }
        }

        function updateCameraStatusFromERA(status) {
            console.log('üìπ Camera status from E-Ra:', status);
            systemState.cameraConnected = (status !== 'offline');
        }

        function updateCameraSystemStatusFromERA(statusJson) {
            try {
                console.log('üìπ Camera system status from E-Ra:', statusJson);
                const status = JSON.parse(statusJson);
                
                if (status.stream_url) {
                    console.log('üì∫ Camera stream URL:', status.stream_url);
                }
                
            } catch (e) {
                console.error('‚ùå Error parsing camera system status from E-Ra:', e);
            }
        }

        function updateLastCaptureFromERA(filename) {
            console.log('üì∏ Last capture from E-Ra:', filename);
            showAlert('ƒê√£ ch·ª•p ·∫£nh: ' + filename, 'success');
        }

        // Management functions - G·ª¨I COMMANDS V·ªÄ E-RA
        async function enrollFingerprint() {
            const id = document.getElementById('fingerprintId').value;
            const name = document.getElementById('fingerprintName').value;
            
            if (!id || !name) {
                showAlert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'warning');
                return;
            }
            
            if (id < 1 || id > 127) {
                showAlert('ID v√¢n tay ph·∫£i t·ª´ 1 ƒë·∫øn 127!', 'warning');
                return;
            }
            
            console.log('üëÜ Sending fingerprint enrollment command to E-Ra');
            
            document.getElementById('enrollStatus').innerHTML = '‚è≥ B·∫Øt ƒë·∫ßu ƒëƒÉng k√Ω v√¢n tay...';
            document.getElementById('enrollStatus').style.color = '#667eea';
            
            const enrollCommand = `ENROLL:${id}:${name}`;
            
            // Send command through E-Ra - This would write to V5 (Fingerprint Status)
            // Implementation depends on how E-Ra Widget handles command sending
            // For now, show demo behavior
            if (systemState.connected) {
                showAlert('ƒê√£ g·ª≠i l·ªánh ƒëƒÉng k√Ω v√¢n tay', 'info');
                // In real implementation, this would trigger writing to Virtual Pin V5
            } else {
                // Fallback demo
                setTimeout(() => {
                    document.getElementById('enrollStatus').innerHTML = 'üëÜ Vui l√≤ng ƒë·∫∑t ng√≥n tay l√™n c·∫£m bi·∫øn l·∫ßn ƒë·∫ßu';
                    document.getElementById('enrollStatus').style.color = '#667eea';
                    
                    setTimeout(() => {
                        document.getElementById('enrollStatus').innerHTML = '‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng! (Demo)';
                        document.getElementById('enrollStatus').style.color = '#10b981';
                        systemState.fingerprintCountValue++;
                        fingerprintCount.textContent = systemState.fingerprintCountValue;
                        
                        document.getElementById('fingerprintId').value = '';
                        document.getElementById('fingerprintName').value = '';
                        
                        setTimeout(() => {
                            document.getElementById('enrollStatus').innerHTML = '';
                        }, 3000);
                    }, 3000);
                }, 1000);
            }
        }

        async function testFingerprintScan() {
            console.log('üëÜ Sending fingerprint scan test to E-Ra');
            
            if (systemState.connected) {
                showAlert('ƒê·∫∑t ng√≥n tay l√™n c·∫£m bi·∫øn ƒë·ªÉ test...', 'info');
                // Send SCAN command to V5
            } else {
                showAlert('Test ch·ªâ ho·∫°t ƒë·ªông khi k·∫øt n·ªëi E-Ra', 'warning');
            }
        }

        async function scanRfidCard() {
            console.log('üè∑Ô∏è Sending RFID scan command to E-Ra');
            
            document.getElementById('rfidStatus').innerHTML = 'üîç ƒêang qu√©t th·∫ª...';
            document.getElementById('rfidStatus').style.color = '#667eea';
            
            if (systemState.connected) {
                showAlert('ƒê·∫∑t th·∫ª g·∫ßn ƒë·∫ßu ƒë·ªçc ƒë·ªÉ qu√©t...', 'info');
                // Send SCAN command to V6
            } else {
                // Fallback demo
                setTimeout(() => {
                    const mockUID = generateMockUID();
                    document.getElementById('rfidUid').value = mockUID;
                    document.getElementById('rfidStatus').innerHTML = '‚úÖ ƒê√£ qu√©t th·∫ª th√†nh c√¥ng! (Demo)';
                    document.getElementById('rfidStatus').style.color = '#10b981';
                    
                    setTimeout(() => {
                        document.getElementById('rfidStatus').innerHTML = '';
                    }, 3000);
                }, 1500);
            }
        }

        async function addRfidCard() {
            const uid = document.getElementById('rfidUid').value;
            const name = document.getElementById('rfidName').value;
            
            if (!uid || !name) {
                showAlert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!', 'warning');
                return;
            }
            
            console.log('üè∑Ô∏è Sending RFID add command to E-Ra');
            
            const addCommand = `ADD:${uid}:${name}`;
            
            if (systemState.connected) {
                showAlert('ƒê√£ g·ª≠i l·ªánh th√™m th·∫ª RFID', 'info');
                // Send ADD command to V6
            } else {
                // Fallback demo
                systemState.rfidCountValue++;
                rfidCount.textContent = systemState.rfidCountValue;
                document.getElementById('rfidStatus').innerHTML = '‚úÖ Th√™m th·∫ª th√†nh c√¥ng! (Demo)';
                document.getElementById('rfidStatus').style.color = '#10b981';
                document.getElementById('rfidUid').value = '';
                document.getElementById('rfidName').value = '';
                
                setTimeout(() => {
                    document.getElementById('rfidStatus').innerHTML = '';
                }, 3000);
            }
        }

        // Camera controls
        function startVideoStream() {
            console.log('üìπ Sending start stream command to E-Ra');
            
            if (systemState.connected) {
                // Send start_stream command to V11
                const videoStream = document.getElementById('videoStream');
                const videoPlaceholder = document.getElementById('videoPlaceholder');
                
                // This would be replaced with actual stream URL from ESP32-CAM
                videoStream.src = 'about:blank';
                videoStream.style.display = 'block';
                videoPlaceholder.style.display = 'none';
                
                showAlert('Video stream ƒë√£ b·∫Øt ƒë·∫ßu!', 'success');
            } else {
                showAlert('Kh√¥ng th·ªÉ kh·ªüi ƒë·ªông video stream', 'warning');
            }
        }

        // Settings functions
        function toggleAutoLock() {
            systemState.autoLockEnabled = document.getElementById('autoLockEnabled').checked;
            
            console.log('‚öôÔ∏è Auto-lock setting changed:', systemState.autoLockEnabled);
            
            showAlert(systemState.autoLockEnabled ? 'ƒê√£ b·∫≠t t·ª± ƒë·ªông ƒë√≥ng c·ª≠a' : 'ƒê√£ t·∫Øt t·ª± ƒë·ªông ƒë√≥ng c·ª≠a', 'info');
        }

        function toggleMotionDetection() {
            systemState.motionDetectionEnabled = document.getElementById('motionDetectionEnabled').checked;
            
            console.log('‚öôÔ∏è Motion detection setting changed:', systemState.motionDetectionEnabled);
            
            // Send motion detection setting to camera via V12
            showAlert(systemState.motionDetectionEnabled ? 'ƒê√£ b·∫≠t ph√°t hi·ªán chuy·ªÉn ƒë·ªông' : 'ƒê√£ t·∫Øt ph√°t hi·ªán chuy·ªÉn ƒë·ªông', 'info');
        }

        // Utility functions
        function updateEraStatus(message, connected) {
            const statusEl = document.getElementById('eraStatus');
            statusEl.textContent = `E-Ra: ${message}`;
            statusEl.className = `era-status ${connected ? 'era-connected' : 'era-disconnected'}`;
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            systemState.connected = connected;
            
            if (connected) {
                status.className = 'connection-status status-online';
                status.innerHTML = '<i class="fas fa-wifi"></i> ƒê√£ k·∫øt n·ªëi E-Ra';
            } else {
                status.className = 'connection-status status-offline';
                status.innerHTML = '<i class="fas fa-wifi"></i> M·∫•t k·∫øt n·ªëi';
            }
        }

        function showError(message) {
            const errorIndicator = document.getElementById('errorIndicator');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorIndicator.style.display = 'block';
            
            setTimeout(() => {
                errorIndicator.style.display = 'none';
            }, 5000);
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 10px;
                color: white;
                z-index: 1000;
                max-width: 350px;
                font-weight: 600;
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                backdrop-filter: blur(10px);
                animation: slideIn 0.3s ease-out;
            `;
            
            switch(type) {
                case 'success':
                    alertDiv.style.background = 'var(--success-gradient)';
                    break;
                case 'danger':
                    alertDiv.style.background = 'var(--secondary-gradient)';
                    break;
                case 'warning':
                    alertDiv.style.background = 'var(--warning-gradient)';
                    alertDiv.style.color = 'var(--text-primary)';
                    break;
                default:
                    alertDiv.style.background = 'var(--primary-gradient)';
            }
            
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.transform = 'translateX(400px)';
                alertDiv.style.opacity = '0';
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        document.body.removeChild(alertDiv);
                    }
                }, 300);
            }, 4000);
        }

        function updateLastAccess() {
            const now = new Date();
            document.getElementById('lastAccess').textContent = `L·∫ßn cu·ªëi: ${now.toLocaleTimeString('vi-VN')}`;
        }

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN');
            currentTime.textContent = timeString;
        }

        function generateMockUID() {
            const hex = '0123456789ABCDEF';
            let uid = '';
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 2; j++) {
                    uid += hex[Math.floor(Math.random() * 16)];
                }
                if (i < 3) uid += ':';
            }
            return uid;
        }

        // Local action functions for demo/fallback
        async function openDoorAction() {
            systemState.doorMoving = true;
            updateDoorStatusFromERA('opening');
            
            document.getElementById('doorControlStatus').innerHTML = '‚è≥ ƒêang m·ªü c·ª≠a...';
            document.getElementById('openBtn').disabled = true;
            
            setTimeout(() => {
                systemState.doorMoving = false;
                systemState.doorOpen = true;
                updateDoorStatusFromERA('open');
                document.getElementById('doorControlStatus').innerHTML = '‚úÖ C·ª≠a ƒë√£ m·ªü th√†nh c√¥ng!';
                document.getElementById('openBtn').disabled = false;
                
                setTimeout(() => {
                    document.getElementById('doorControlStatus').innerHTML = '';
                }, 5000);
            }, 3000);
        }

        async function closeDoorAction() {
            systemState.doorMoving = true;
            updateDoorStatusFromERA('closing');
            
            document.getElementById('doorControlStatus').innerHTML = '‚è≥ ƒêang ƒë√≥ng c·ª≠a...';
            document.getElementById('closeBtn').disabled = true;
            
            setTimeout(() => {
                systemState.doorMoving = false;
                systemState.doorOpen = false;
                updateDoorStatusFromERA('closed');
                document.getElementById('doorControlStatus').innerHTML = '‚úÖ C·ª≠a ƒë√£ ƒë√≥ng th√†nh c√¥ng!';
                document.getElementById('closeBtn').disabled = false;
                
                setTimeout(() => {
                    document.getElementById('doorControlStatus').innerHTML = '';
                }, 5000);
            }, 3000);
        }

        async function emergencyStopAction() {
            systemState.doorMoving = false;
            updateDoorStatusFromERA('stopped');
            
            document.getElementById('doorControlStatus').innerHTML = '‚õî ƒê√É D·ª™NG KH·∫®N C·∫§P!';
            document.getElementById('doorControlStatus').style.color = 'red';
            document.getElementById('doorControlStatus').style.fontWeight = 'bold';
            
            setTimeout(() => {
                document.getElementById('doorControlStatus').style.color = '';
                document.getElementById('doorControlStatus').style.fontWeight = '';
                document.getElementById('doorControlStatus').innerHTML = '';
            }, 5000);
        }

        // Tab functions
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Other utility functions
        function refreshData() {
            console.log('üîÑ Refreshing data...');
            showAlert('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l√†m m·ªõi!', 'success');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => {
                    showAlert('Kh√¥ng th·ªÉ chuy·ªÉn sang ch·∫ø ƒë·ªô to√†n m√†n h√¨nh', 'warning');
                });
            } else {
                document.exitFullscreen();
            }
        }

        function filterHistory() {
            const date = document.getElementById('filterDate').value;
            if (date) {
                showAlert(`ƒê√£ l·ªçc l·ªãch s·ª≠ theo ng√†y: ${date}`, 'info');
            } else {
                showAlert('Vui l√≤ng ch·ªçn ng√†y ƒë·ªÉ l·ªçc', 'warning');
            }
        }

        function exportHistory() {
            showAlert('ƒêang xu·∫•t file Excel...', 'info');
            setTimeout(() => {
                showAlert('File Excel ƒë√£ ƒë∆∞·ª£c t·∫°o!', 'success');
            }, 2000);
        }

        function deleteFingerprint(id) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a v√¢n tay n√†y?')) {
                systemState.fingerprintCountValue = Math.max(0, systemState.fingerprintCountValue - 1);
                fingerprintCount.textContent = systemState.fingerprintCountValue;
                showAlert('ƒê√£ x√≥a v√¢n tay th√†nh c√¥ng!', 'success');
            }
        }

        function deleteRfidCard(uid) {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th·∫ª n√†y?')) {
                systemState.rfidCountValue = Math.max(0, systemState.rfidCountValue - 1);
                rfidCount.textContent = systemState.rfidCountValue;
                showAlert('ƒê√£ x√≥a th·∫ª th√†nh c√¥ng!', 'success');
            }
        }

        // Initialize Dashboard
        function initDashboard() {
            try {
                console.log('üöÄ Initializing Smart Door Elite Dashboard...');
                
                // Check if we're in E-Ra environment
                if (window.self !== window.top) {
                    document.body.classList.add('era-embedded');
                    console.log('üì± Running in E-Ra embedded mode');
                }
                
                // Set current date in filter
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('filterDate').value = today;
                
                // Set startup time
                const now = new Date();
                document.getElementById('startupTime').textContent = now.toLocaleTimeString('vi-VN');
                
                // Start time updates
                setInterval(updateTime, 1000);
                updateTime();
                
                // Initialize door display
                updateDoorStatusFromERA('closed');
                
                // Initialize demo data
                systemState.fingerprintCountValue = 1;
                systemState.rfidCountValue = 1;
                fingerprintCount.textContent = systemState.fingerprintCountValue;
                rfidCount.textContent = systemState.rfidCountValue;
                
                console.log('‚úÖ Smart Door Elite Dashboard initialized successfully');
                showAlert('H·ªá th·ªëng ƒë√£ kh·ªüi ƒë·ªông th√†nh c√¥ng!', 'success');
                
                // E-Ra Widget should auto-initialize when script loads
                setTimeout(() => {
                    if (!systemState.connected) {
                        updateEraStatus('ƒêang k·∫øt n·ªëi...', false);
                        console.log('‚è≥ Waiting for E-Ra Widget connection...');
                    }
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error initializing dashboard:', error);
                showError('L·ªói kh·ªüi t·∫°o h·ªá th·ªëng: ' + error.message);
            }
        }

        // Add CSS for slide animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
        
        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && systemState.connected) {
                refreshData();
            }
        });
        
        // Handle errors globally
        window.addEventListener('error', function(e) {
            console.error('‚ùå Global error:', e.error);
            showError('L·ªói h·ªá th·ªëng: ' + e.message);
        });
        
        // Periodic health check
        setInterval(() => {
            if (systemState.connected) {
                console.log('üíì Health check: E-Ra connected, system running normally');
            } else {
                console.log('üíî Health check: E-Ra disconnected');
            }
        }, 30000); // Every 30 seconds
    </script>
</body>
</html>
