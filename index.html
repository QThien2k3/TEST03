<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Ki·ªÉm So√°t C·ª≠a Th√¥ng Minh</title>
    
    <!-- E-Ra Widget Library -->
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #1e1b4b 50%, #312e81 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .dashboard {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .card {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        /* Door Control Card */
        .door-card {
            grid-column: 1;
            grid-row: 1;
        }

        .door-card .card-icon {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .door-visual {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 16px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .door-display {
            width: 150px;
            height: 100px;
            background: #374151;
            border-radius: 12px;
            position: relative;
            margin-bottom: 20px;
            border: 3px solid;
            transition: all 0.5s ease;
        }

        .door-display.closed {
            border-color: #ef4444;
            background: linear-gradient(135deg, #374151, #1f2937);
        }

        .door-display.open {
            border-color: #10b981;
            background: linear-gradient(135deg, #10b981, #059669);
            transform: perspective(200px) rotateY(-20deg);
        }

        .door-display.opening,
        .door-display.closing {
            border-color: #f59e0b;
            animation: doorAnimation 1s infinite;
        }

        @keyframes doorAnimation {
            0%, 100% { transform: perspective(200px) rotateY(0deg); }
            50% { transform: perspective(200px) rotateY(-10deg); }
        }

        .door-handle {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #fbbf24;
            border-radius: 50%;
        }

        .door-status {
            font-size: 24px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
        }

        .door-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .door-controls .btn {
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-open {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-close {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-stop {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            grid-column: 1 / 3;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Security Management Card */
        .security-card {
            grid-column: 2;
            grid-row: 1 / 3;
        }

        .security-card .card-icon {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .security-tabs {
            display: flex;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .tab-content {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .tab-content.active {
            display: flex;
        }

        .scan-area {
            background: rgba(30, 41, 59, 0.3);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .scan-area.scanning {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            animation: scanPulse 2s infinite;
        }

        @keyframes scanPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .scan-icon {
            font-size: 48px;
            color: #3b82f6;
            margin-bottom: 16px;
        }

        .scan-result {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 12px;
            min-height: 24px;
        }

        .scan-suggestion {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 20px;
        }

        .scan-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .btn-scan {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-secondary {
            background: rgba(100, 116, 139, 0.3);
            color: #e2e8f0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .enroll-form {
            background: rgba(30, 41, 59, 0.3);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .enroll-form.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #e2e8f0;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .btn-enroll {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .data-list {
            flex: 1;
            overflow-y: auto;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 12px;
            padding: 16px;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .list-title {
            font-weight: 600;
            color: #e2e8f0;
        }

        .btn-clear {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .item-info {
            flex: 1;
        }

        .item-id {
            font-weight: 600;
            color: #3b82f6;
        }

        .item-name {
            color: #94a3b8;
            font-size: 14px;
        }

        .btn-delete {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            color: #64748b;
            font-style: italic;
            padding: 40px 20px;
        }

        /* Camera Card */
        .camera-card {
            grid-column: 3;
            grid-row: 1;
        }

        .camera-card .card-icon {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .camera-display {
            flex: 1;
            background: #000;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .motion-radar {
            position: absolute;
            width: 120px;
            height: 120px;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.7;
        }

        .motion-radar::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: #3b82f6;
            animation: radarSweep 2s linear infinite;
        }

        .motion-radar.active::before {
            border-top-color: #10b981;
            animation-duration: 0.5s;
        }

        @keyframes radarSweep {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .radar-dot {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
        }

        .radar-dot.active {
            opacity: 1;
            animation: dotPulse 1s infinite;
        }

        @keyframes dotPulse {
            0%, 100% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.5; transform: translate(-50%, -50%) scale(1.5); }
        }

        .camera-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 12px;
        }

        .camera-placeholder {
            color: #64748b;
            text-align: center;
        }

        .camera-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
            padding: 8px;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 8px;
            font-size: 14px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #64748b;
        }

        .status-indicator.active {
            background: #10b981;
            animation: statusBlink 1s infinite;
        }

        @keyframes statusBlink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .camera-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .camera-info {
            grid-column: 1 / 3;
            text-align: center;
            font-size: 12px;
            color: #94a3b8;
            margin-top: 12px;
        }

        /* History Card */
        .history-card {
            grid-column: 1 / 3;
            grid-row: 2;
        }

        .history-card .card-icon {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .history-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .date-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .date-input {
            padding: 8px 12px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        .filter-select {
            padding: 8px 12px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        .btn-export {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-left: auto;
        }

        .history-table {
            flex: 1;
            overflow-x: auto;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 12px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table th {
            background: rgba(15, 23, 42, 0.5);
            font-weight: 600;
            color: #e2e8f0;
            font-size: 14px;
        }

        .table td {
            color: #94a3b8;
            font-size: 14px;
        }

        .method-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .method-fingerprint {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .method-rfid {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-success {
            color: #10b981;
        }

        .status-failed {
            color: #ef4444;
        }

        /* Motion Detection Card */
        .motion-card {
            grid-column: 3;
            grid-row: 2;
        }

        .motion-card .card-icon {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .motion-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(30, 41, 59, 0.3);
            border-radius: 16px;
            position: relative;
            margin-bottom: 20px;
        }

        .motion-sensor {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.3), transparent);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 20px;
        }

        .motion-sensor.active {
            background: radial-gradient(circle, rgba(16, 185, 129, 0.3), transparent);
            animation: motionDetected 1s infinite;
        }

        @keyframes motionDetected {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .motion-waves {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid #8b5cf6;
            opacity: 0;
        }

        .motion-sensor.active .motion-waves {
            opacity: 1;
            animation: waveExpand 2s infinite;
        }

        @keyframes waveExpand {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        .motion-status {
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 16px;
        }

        .motion-info {
            text-align: center;
            color: #94a3b8;
            font-size: 14px;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto auto;
            }

            .security-card {
                grid-column: 1 / 3;
                grid-row: 2;
            }

            .history-card {
                grid-column: 1 / 3;
                grid-row: 3;
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: repeat(5, auto);
            }

            .door-card,
            .security-card,
            .camera-card,
            .history-card,
            .motion-card {
                grid-column: 1;
                grid-row: auto;
            }

            .door-controls,
            .camera-controls {
                grid-template-columns: 1fr;
            }

            .history-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .btn-export {
                margin-left: 0;
                margin-top: 12px;
            }
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border-left: 4px solid #3b82f6;
            animation: slideInRight 0.3s ease;
            max-width: 350px;
            color: #fff;
        }

        .toast.success { border-left-color: #10b981; }
        .toast.error { border-left-color: #ef4444; }
        .toast.warning { border-left-color: #f59e0b; }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Door Control Card -->
        <div class="card door-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-door-open"></i>
                </div>
                <h2 class="card-title">ƒêi·ªÅu Khi·ªÉn C·ª≠a</h2>
            </div>
            
            <div class="door-visual">
                <div class="door-display closed" id="door-display">
                    <div class="door-handle"></div>
                </div>
                <div class="door-status" id="door-status">ƒê√ìNG</div>
            </div>

            <div class="door-controls">
                <button class="btn btn-open" onclick="openDoor()">
                    <i class="fas fa-unlock"></i> M·ªû C·ª¨A
                </button>
                <button class="btn btn-close" onclick="closeDoor()">
                    <i class="fas fa-lock"></i> ƒê√ìNG C·ª¨A
                </button>
                <button class="btn btn-stop" onclick="stopDoor()">
                    <i class="fas fa-stop"></i> D·ª™NG
                </button>
            </div>
        </div>

        <!-- Security Management Card -->
        <div class="card security-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h2 class="card-title">Qu·∫£n L√Ω Truy C·∫≠p</h2>
            </div>

            <div class="security-tabs">
                <button class="tab-btn active" onclick="switchTab('fingerprint')">
                    <i class="fas fa-fingerprint"></i> V√¢n Tay
                </button>
                <button class="tab-btn" onclick="switchTab('rfid')">
                    <i class="fas fa-credit-card"></i> Th·∫ª RFID
                </button>
            </div>

            <!-- Fingerprint Tab -->
            <div id="fingerprint-tab" class="tab-content active">
                <div class="scan-area" id="fp-scan-area">
                    <div class="scan-icon">
                        <i class="fas fa-fingerprint"></i>
                    </div>
                    <div class="scan-result" id="fp-scan-result">Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ test qu√©t v√¢n tay</div>
                    <div class="scan-suggestion" id="fp-suggestion"></div>
                    
                    <div class="scan-controls">
                        <button class="btn-scan btn-primary" id="fp-test-btn" onclick="testFingerprintScan()">
                            <i class="fas fa-play"></i> B·∫ÆT ƒê·∫¶U TEST
                        </button>
                        <button class="btn-scan btn-secondary" id="fp-stop-btn" onclick="stopFingerprintScan()" disabled>
                            <i class="fas fa-stop"></i> D·ª™NG
                        </button>
                    </div>
                </div>

                <div class="enroll-form" id="fp-enroll-form">
                    <h4 style="margin-bottom: 16px; color: #e2e8f0;">Th√™m v√¢n tay th·ªß c√¥ng</h4>
                    <div class="form-group">
                        <label class="form-label">Nh·∫≠p ID</label>
                        <input type="number" class="form-input" id="fp-id-input" placeholder="ID v√¢n tay">
                    </div>
                    <div class="form-group">
                        <label class="form-label">T√™n ng∆∞·ªùi d√πng</label>
                        <input type="text" class="form-input" id="fp-name-input" placeholder="Nh·∫≠p t√™n">
                    </div>
                    <button class="btn-enroll" onclick="enrollFingerprint()">
                        <i class="fas fa-plus"></i> ƒêƒÇNG K√ù V√ÇN TAY
                    </button>
                </div>

                <div class="data-list">
                    <div class="list-header">
                        <span class="list-title">Danh s√°ch v√¢n tay ƒë√£ l∆∞u:</span>
                        <button class="btn-clear" onclick="clearFingerprintList()">
                            <i class="fas fa-trash"></i> X√ìA T·∫§T C·∫¢
                        </button>
                    </div>
                    <div id="fp-list">
                        <div class="empty-state">
                            <i class="fas fa-fingerprint" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                            <div>Ch∆∞a c√≥ v√¢n tay n√†o ƒë∆∞·ª£c l∆∞u</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RFID Tab -->
            <div id="rfid-tab" class="tab-content">
                <div class="scan-area" id="rfid-scan-area">
                    <div class="scan-icon">
                        <i class="fas fa-credit-card"></i>
                    </div>
                    <div class="scan-result" id="rfid-scan-result">Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ test qu√©t th·∫ª RFID</div>
                    <div class="scan-suggestion" id="rfid-suggestion"></div>
                    
                    <div class="scan-controls">
                        <button class="btn-scan btn-primary" id="rfid-test-btn" onclick="testRFIDScan()">
                            <i class="fas fa-play"></i> B·∫ÆT ƒê·∫¶U TEST
                        </button>
                        <button class="btn-scan btn-secondary" id="rfid-stop-btn" onclick="stopRFIDScan()" disabled>
                            <i class="fas fa-stop"></i> D·ª™NG
                        </button>
                    </div>
                </div>

                <div class="enroll-form" id="rfid-enroll-form">
                    <h4 style="margin-bottom: 16px; color: #e2e8f0;">Th√™m th·∫ª RFID th·ªß c√¥ng</h4>
                    <div class="form-group">
                        <label class="form-label">UID th·∫ª</label>
                        <input type="text" class="form-input" id="rfid-uid-input" placeholder="UID th·∫ª RFID">
                    </div>
                    <div class="form-group">
                        <label class="form-label">T√™n ng∆∞·ªùi d√πng</label>
                        <input type="text" class="form-input" id="rfid-name-input" placeholder="Nh·∫≠p t√™n">
                    </div>
                    <button class="btn-enroll" onclick="enrollRFID()">
                        <i class="fas fa-plus"></i> ƒêƒÇNG K√ù TH·∫∫ RFID
                    </button>
                </div>

                <div class="data-list">
                    <div class="list-header">
                        <span class="list-title">Danh s√°ch th·∫ª RFID ƒë√£ l∆∞u:</span>
                        <button class="btn-clear" onclick="clearRFIDList()">
                            <i class="fas fa-trash"></i> X√ìA T·∫§T C·∫¢
                        </button>
                    </div>
                    <div id="rfid-list">
                        <div class="empty-state">
                            <i class="fas fa-credit-card" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                            <div>Ch∆∞a c√≥ th·∫ª RFID n√†o ƒë∆∞·ª£c l∆∞u</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Camera Security Card -->
        <div class="card camera-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-video"></i>
                </div>
                <h2 class="card-title">Camera An Ninh</h2>
            </div>

            <div class="camera-display" id="camera-display">
                <div class="motion-radar" id="motion-radar">
                    <div class="radar-dot" id="radar-dot"></div>
                </div>
                <div class="camera-placeholder" id="camera-placeholder">
                    <i class="fas fa-camera" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px;"></i>
                    <div>Camera s·∫Ω t·ª± ƒë·ªông ch·ª•p khi c√≥ chuy·ªÉn ƒë·ªông</div>
                    <div style="font-size: 12px; margin-top: 8px;">·∫¢nh s·∫Ω ƒë∆∞·ª£c g·ª≠i v·ªÅ email ngay l·∫≠p t·ª©c</div>
                </div>
            </div>

            <div class="camera-status">
                <div class="status-indicator" id="camera-indicator"></div>
                <span id="camera-status-text">Kh√¥ng c√≥ chuy·ªÉn ƒë·ªông</span>
            </div>

            <div class="camera-controls">
                <button class="btn btn-primary" onclick="manualCapture()">
                    <i class="fas fa-camera"></i> CH·ª§P TH·ª¶ C√îNG
                </button>
                <button class="btn btn-secondary" onclick="toggleAutoCapture()">
                    <i class="fas fa-magic"></i> T·ª∞ ƒê·ªòNG: ON
                </button>
            </div>

            <div class="camera-info">
                üìß Email: phamquocthien17@gmail.com<br>
                üì∑ T·ª± ƒë·ªông g·ª≠i ·∫£nh khi ph√°t hi·ªán chuy·ªÉn ƒë·ªông<br>
                üì° Stream: ƒêang k·∫øt n·ªëi...
            </div>
        </div>

        <!-- Access History Card -->
        <div class="card history-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-history"></i>
                </div>
                <h2 class="card-title">L·ªãch S·ª≠ Truy C·∫≠p</h2>
            </div>

            <div class="history-controls">
                <div class="date-group">
                    <label style="color: #94a3b8; font-size: 14px;">Ng√†y:</label>
                    <input type="date" class="date-input" id="date-filter">
                </div>
                <div class="date-group">
                    <label style="color: #94a3b8; font-size: 14px;">Th√°ng:</label>
                    <select class="filter-select" id="month-filter">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="1">Th√°ng 1</option>
                        <option value="2">Th√°ng 2</option>
                        <option value="3">Th√°ng 3</option>
                        <option value="4">Th√°ng 4</option>
                        <option value="5">Th√°ng 5</option>
                        <option value="6">Th√°ng 6</option>
                        <option value="7">Th√°ng 7</option>
                        <option value="8">Th√°ng 8</option>
                        <option value="9">Th√°ng 9</option>
                        <option value="10">Th√°ng 10</option>
                        <option value="11">Th√°ng 11</option>
                        <option value="12">Th√°ng 12</option>
                    </select>
                </div>
                <div class="date-group">
                    <label style="color: #94a3b8; font-size: 14px;">Ph∆∞∆°ng th·ª©c:</label>
                    <select class="filter-select" id="method-filter">
                        <option value="">T·∫•t c·∫£</option>
                        <option value="fingerprint">V√¢n tay</option>
                        <option value="rfid">Th·∫ª RFID</option>
                    </select>
                </div>
                <button class="btn-export" onclick="exportHistory()">
                    <i class="fas fa-download"></i> XU·∫§T EXCEL
                </button>
                <button class="btn btn-secondary" onclick="clearHistory()">
                    <i class="fas fa-trash"></i> X√ìA L·ªäCH S·ª¨
                </button>
            </div>

            <div class="history-table">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Th·ªùi gian</th>
                            <th>Ph∆∞∆°ng th·ª©c</th>
                            <th>ID/UID</th>
                            <th>T√™n</th>
                            <th>K·∫øt qu·∫£</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="history-tbody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #64748b;">
                                <i class="fas fa-clock" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                                <div>Ch∆∞a c√≥ l·ªãch s·ª≠ truy c·∫≠p</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Motion Detection Card -->
        <div class="card motion-card">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-running"></i>
                </div>
                <h2 class="card-title">Ph√°t Hi·ªán Chuy·ªÉn ƒê·ªông</h2>
            </div>

            <div class="motion-display">
                <div class="motion-sensor" id="motion-sensor">
                    <i class="fas fa-walking" style="font-size: 32px; color: #8b5cf6;"></i>
                    <div class="motion-waves"></div>
                </div>
                <div class="motion-status" id="motion-status">Kh√¥ng ph√°t hi·ªán</div>
            </div>

            <div class="motion-info">
                <p><strong>C·∫£m bi·∫øn PIR HC-SR501</strong></p>
                <p>Ph·∫°m vi: 7 m√©t</p>
                <p>G√≥c ph√°t hi·ªán: 120¬∞</p>
                <p>T·ª± ƒë·ªông ƒë√≥ng c·ª≠a sau 10s kh√¥ng c√≥ chuy·ªÉn ƒë·ªông</p>
                <p style="margin-top: 16px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #ef4444;">
                    ‚ö†Ô∏è <strong>C·∫£nh b√°o:</strong> Sau 5 l·∫ßn th·ª≠ sai s·∫Ω k√≠ch ho·∫°t b√°o ƒë·ªông
                </p>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        // E-Ra Widget Setup
        const eraWidget = new EraWidget();
        
        // Configuration variables theo format E-Ra
        let configDoorStatus = null;          // V1 - Door Status
        let configPirMotion = null;           // V2 - PIR Motion  
        let configAccessLog = null;           // V3 - Access Log
        let configFingerprintList = null;     // V4 - Fingerprint List
        let configRfidList = null;            // V5 - RFID List
        let configIntruderAlert = null;       // V6 - Intruder Alert
        let configSystemStatus = null;        // V8 - System Status
        let configCameraStatus = null;        // V9 - Camera Status
        let configCameraImage = null;         // V10 - Camera Image
        let configFingerprintResult = null;   // V11 - Fingerprint Scan Result
        let configRfidResult = null;          // V12 - RFID Scan Result

        // Actions configuration
        let actionDoorOpen = null;            // Action: Open Door (V0=1)
        let actionDoorClose = null;           // Action: Close Door (V0=0)
        let actionDoorStop = null;            // Action: Stop Door (V0=2)
        let actionFingerprintTest = null;     // Action: Test Fingerprint (V4=1)
        let actionFingerprintStop = null;     // Action: Stop Fingerprint (V4=2)
        let actionFingerprintEnroll = null;   // Action: Enroll Fingerprint (V4=3)
        let actionFingerprintDelete = null;   // Action: Delete Fingerprint (V4=4)
        let actionRfidTest = null;            // Action: Test RFID (V5=1)
        let actionRfidStop = null;            // Action: Stop RFID (V5=2)
        let actionRfidEnroll = null;          // Action: Enroll RFID (V5=3)
        let actionRfidDelete = null;          // Action: Delete RFID (V5=4)
        let actionCameraManual = null;        // Action: Manual Camera (V7=2)
        
        // State variables
        let isScanning = {
            fingerprint: false,
            rfid: false
        };
        let isMotionDetected = false;
        let isAutoCapture = true;
        let accessHistory = [];
        let fingerprintList = [];
        let rfidList = [];

        // Initialize E-Ra Widget
        eraWidget.init({
            onConfiguration: (configuration) => {
                console.log('Configuration received:', configuration);
                
                // L∆∞u c√°c c·∫•u h√¨nh realtime configs theo th·ª© t·ª±
                configDoorStatus = configuration.realtime_configs[0];          // V1
                configPirMotion = configuration.realtime_configs[1];           // V2
                configAccessLog = configuration.realtime_configs[2];           // V3
                configFingerprintList = configuration.realtime_configs[3];     // V4
                configRfidList = configuration.realtime_configs[4];            // V5
                configIntruderAlert = configuration.realtime_configs[5];       // V6
                configSystemStatus = configuration.realtime_configs[6];        // V8
                configCameraStatus = configuration.realtime_configs[7];        // V9
                configCameraImage = configuration.realtime_configs[8];         // V10
                configFingerprintResult = configuration.realtime_configs[9];   // V11
                configRfidResult = configuration.realtime_configs[10];         // V12

                // L∆∞u c√°c c·∫•u h√¨nh actions theo th·ª© t·ª±
                actionDoorOpen = configuration.actions[0];            // Door Open
                actionDoorClose = configuration.actions[1];           // Door Close
                actionDoorStop = configuration.actions[2];            // Door Stop
                actionFingerprintTest = configuration.actions[3];     // Fingerprint Test
                actionFingerprintStop = configuration.actions[4];     // Fingerprint Stop
                actionFingerprintEnroll = configuration.actions[5];   // Fingerprint Enroll
                actionFingerprintDelete = configuration.actions[6];   // Fingerprint Delete
                actionRfidTest = configuration.actions[7];            // RFID Test
                actionRfidStop = configuration.actions[8];            // RFID Stop
                actionRfidEnroll = configuration.actions[9];          // RFID Enroll
                actionRfidDelete = configuration.actions[10];         // RFID Delete
                actionCameraManual = configuration.actions[11];       // Camera Manual
                
                console.log('E-Ra configuration loaded successfully');
                showToast('K·∫øt n·ªëi th√†nh c√¥ng v·ªõi E-Ra Platform', 'success');
            },

            onValues: (values) => {
                console.log('Values received:', values);
                updateDashboard(values);
            }
        });

        // Update dashboard with received values
        function updateDashboard(values) {
            // Update door status (V1)
            if (configDoorStatus && values[configDoorStatus.id]) {
                updateDoorStatus(values[configDoorStatus.id].value);
            }

            // Update motion detection (V2)
            if (configPirMotion && values[configPirMotion.id]) {
                updateMotionStatus(values[configPirMotion.id].value);
            }

            // Update access log (V3)
            if (configAccessLog && values[configAccessLog.id]) {
                updateAccessLog(values[configAccessLog.id].value);
            }

            // Update fingerprint list (V4)
            if (configFingerprintList && values[configFingerprintList.id]) {
                updateFingerprintList(values[configFingerprintList.id].value);
            }

            // Update RFID list (V5)
            if (configRfidList && values[configRfidList.id]) {
                updateRFIDList(values[configRfidList.id].value);
            }

            // Update intruder alert (V6)
            if (configIntruderAlert && values[configIntruderAlert.id]) {
                updateIntruderAlert(values[configIntruderAlert.id].value);
            }

            // Update camera status (V9)
            if (configCameraStatus && values[configCameraStatus.id]) {
                updateCameraStatus(values[configCameraStatus.id].value);
            }

            // Update camera image (V10)
            if (configCameraImage && values[configCameraImage.id]) {
                updateCameraImage(values[configCameraImage.id].value);
            }

            // Update fingerprint scan result (V11)
            if (configFingerprintResult && values[configFingerprintResult.id]) {
                updateFingerprintScanResult(values[configFingerprintResult.id].value);
            }

            // Update RFID scan result (V12)
            if (configRfidResult && values[configRfidResult.id]) {
                updateRFIDScanResult(values[configRfidResult.id].value);
            }
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Door Control Functions
        function openDoor() {
            if (actionDoorOpen) {
                eraWidget.triggerAction(actionDoorOpen.action, null);
                showToast('ƒêang m·ªü c·ª≠a...', 'success');
            }
        }

        function closeDoor() {
            if (actionDoorClose) {
                eraWidget.triggerAction(actionDoorClose.action, null);
                showToast('ƒêang ƒë√≥ng c·ª≠a...', 'success');
            }
        }

        function stopDoor() {
            if (actionDoorStop) {
                eraWidget.triggerAction(actionDoorStop.action, null);
                showToast('ƒê√£ d·ª´ng c·ª≠a', 'warning');
            }
        }

        function updateDoorStatus(status) {
            const doorDisplay = document.getElementById('door-display');
            const doorStatus = document.getElementById('door-status');
            
            doorDisplay.className = 'door-display';
            
            switch(status.toLowerCase()) {
                case 'closed':
                case 'ƒë√≥ng':
                    doorDisplay.classList.add('closed');
                    doorStatus.textContent = 'ƒê√ìNG';
                    doorStatus.style.color = '#ef4444';
                    break;
                case 'open':
                case 'm·ªü':
                    doorDisplay.classList.add('open');
                    doorStatus.textContent = 'M·ªû';
                    doorStatus.style.color = '#10b981';
                    break;
                case 'opening':
                case 'ƒëang m·ªü':
                    doorDisplay.classList.add('opening');
                    doorStatus.textContent = 'ƒêANG M·ªû';
                    doorStatus.style.color = '#f59e0b';
                    break;
                case 'closing':
                case 'ƒëang ƒë√≥ng':
                    doorDisplay.classList.add('closing');
                    doorStatus.textContent = 'ƒêANG ƒê√ìNG';
                    doorStatus.style.color = '#f59e0b';
                    break;
                case 'stopped':
                case 'd·ª´ng':
                    doorStatus.textContent = 'D·ª™NG';
                    doorStatus.style.color = '#6b7280';
                    break;
                default:
                    doorStatus.textContent = status.toUpperCase();
            }
        }

        // Fingerprint Control Functions
        function testFingerprintScan() {
            if (actionFingerprintTest) {
                eraWidget.triggerAction(actionFingerprintTest.action, null);
                isScanning.fingerprint = true;
                
                document.getElementById('fp-test-btn').disabled = true;
                document.getElementById('fp-stop-btn').disabled = false;
                document.getElementById('fp-scan-area').classList.add('scanning');
                document.getElementById('fp-scan-result').textContent = 'ƒêang qu√©t v√¢n tay...';
                
                showToast('B·∫Øt ƒë·∫ßu qu√©t v√¢n tay', 'success');
            }
        }

        function stopFingerprintScan() {
            if (actionFingerprintStop) {
                eraWidget.triggerAction(actionFingerprintStop.action, null);
                isScanning.fingerprint = false;
                
                document.getElementById('fp-test-btn').disabled = false;
                document.getElementById('fp-stop-btn').disabled = true;
                document.getElementById('fp-scan-area').classList.remove('scanning');
                document.getElementById('fp-scan-result').textContent = 'ƒê√£ d·ª´ng qu√©t';
                
                hideEnrollForm('fp');
                showToast('ƒê√£ d·ª´ng qu√©t v√¢n tay', 'warning');
            }
        }

        function updateFingerprintScanResult(result) {
            const resultElement = document.getElementById('fp-scan-result');
            const suggestionElement = document.getElementById('fp-suggestion');
            
            if (result === -1) {
                resultElement.textContent = 'V√¢n tay kh√¥ng ƒë∆∞·ª£c nh·∫≠n d·∫°ng';
                resultElement.style.color = '#ef4444';
                hideEnrollForm('fp');
            } else if (result > 0) {
                resultElement.textContent = `V√¢n tay ƒë∆∞·ª£c nh·∫≠n d·∫°ng: ID ${result}`;
                resultElement.style.color = '#10b981';
                hideEnrollForm('fp');
                showToast(`Truy c·∫≠p ƒë∆∞·ª£c c·∫•p: V√¢n tay ID ${result}`, 'success');
                
                // Add to history
                addToHistory('fingerprint', result, 'Cho ph√©p', 'success');
            } else {
                // New fingerprint detected
                resultElement.textContent = 'Ph√°t hi·ªán v√¢n tay m·ªõi';
                resultElement.style.color = '#f59e0b';
                
                const suggestedId = getNextAvailableFingerprintId();
                suggestionElement.textContent = `ID ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t: ${suggestedId}`;
                document.getElementById('fp-id-input').value = suggestedId;
                
                showEnrollForm('fp');
            }
        }

        function enrollFingerprint() {
            const id = document.getElementById('fp-id-input').value;
            const name = document.getElementById('fp-name-input').value;
            
            if (!name.trim()) {
                showToast('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi d√πng', 'error');
                return;
            }
            
            if (actionFingerprintEnroll) {
                eraWidget.triggerAction(actionFingerprintEnroll.action, null);
                showToast(`ƒêang ƒëƒÉng k√Ω v√¢n tay cho ${name}...`, 'success');
                
                // Add to local list (will be synced from server)
                fingerprintList.push({id: parseInt(id), name: name});
                renderFingerprintList();
                
                // Reset form
                document.getElementById('fp-name-input').value = '';
                hideEnrollForm('fp');
            }
        }

        // RFID Control Functions
        function testRFIDScan() {
            if (actionRfidTest) {
                eraWidget.triggerAction(actionRfidTest.action, null);
                isScanning.rfid = true;
                
                document.getElementById('rfid-test-btn').disabled = true;
                document.getElementById('rfid-stop-btn').disabled = false;
                document.getElementById('rfid-scan-area').classList.add('scanning');
                document.getElementById('rfid-scan-result').textContent = 'ƒêang qu√©t th·∫ª RFID...';
                
                showToast('B·∫Øt ƒë·∫ßu qu√©t th·∫ª RFID', 'success');
            }
        }

        function stopRFIDScan() {
            if (actionRfidStop) {
                eraWidget.triggerAction(actionRfidStop.action, null);
                isScanning.rfid = false;
                
                document.getElementById('rfid-test-btn').disabled = false;
                document.getElementById('rfid-stop-btn').disabled = true;
                document.getElementById('rfid-scan-area').classList.remove('scanning');
                document.getElementById('rfid-scan-result').textContent = 'ƒê√£ d·ª´ng qu√©t';
                
                hideEnrollForm('rfid');
                showToast('ƒê√£ d·ª´ng qu√©t th·∫ª RFID', 'warning');
            }
        }

        function updateRFIDScanResult(result) {
            const resultElement = document.getElementById('rfid-scan-result');
            const suggestionElement = document.getElementById('rfid-suggestion');
            
            if (result && result.length > 0) {
                if (isRFIDRegistered(result)) {
                    resultElement.textContent = `Th·∫ª RFID ƒë∆∞·ª£c nh·∫≠n d·∫°ng: ${result}`;
                    resultElement.style.color = '#10b981';
                    hideEnrollForm('rfid');
                    showToast(`Truy c·∫≠p ƒë∆∞·ª£c c·∫•p: Th·∫ª RFID ${result}`, 'success');
                    
                    // Add to history
                    addToHistory('rfid', result, 'Cho ph√©p', 'success');
                } else {
                    resultElement.textContent = `Ph√°t hi·ªán th·∫ª RFID m·ªõi: ${result}`;
                    resultElement.style.color = '#f59e0b';
                    
                    suggestionElement.textContent = `UID: ${result}`;
                    document.getElementById('rfid-uid-input').value = result;
                    
                    showEnrollForm('rfid');
                }
            }
        }

        function enrollRFID() {
            const uid = document.getElementById('rfid-uid-input').value;
            const name = document.getElementById('rfid-name-input').value;
            
            if (!name.trim()) {
                showToast('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi d√πng', 'error');
                return;
            }
            
            if (actionRfidEnroll) {
                eraWidget.triggerAction(actionRfidEnroll.action, null);
                showToast(`ƒêang ƒëƒÉng k√Ω th·∫ª RFID cho ${name}...`, 'success');
                
                // Add to local list (will be synced from server)
                rfidList.push({uid: uid, name: name});
                renderRFIDList();
                
                // Reset form
                document.getElementById('rfid-name-input').value = '';
                hideEnrollForm('rfid');
            }
        }

        // Camera Functions
        function manualCapture() {
            if (actionCameraManual) {
                eraWidget.triggerAction(actionCameraManual.action, null);
                showToast('ƒêang ch·ª•p ·∫£nh th·ªß c√¥ng...', 'success');
            }
        }

        function toggleAutoCapture() {
            isAutoCapture = !isAutoCapture;
            const btn = event.target;
            btn.innerHTML = `<i class="fas fa-magic"></i> T·ª∞ ƒê·ªòNG: ${isAutoCapture ? 'ON' : 'OFF'}`;
            btn.className = isAutoCapture ? 'btn btn-primary' : 'btn btn-secondary';
            showToast(`Ch·∫ø ƒë·ªô t·ª± ƒë·ªông ch·ª•p: ${isAutoCapture ? 'B·∫≠t' : 'T·∫Øt'}`, 'info');
        }

        function updateCameraStatus(status) {
            document.getElementById('camera-status-text').textContent = status;
            const indicator = document.getElementById('camera-indicator');
            
            if (status.includes('Capturing') || status.includes('ƒêang ch·ª•p')) {
                indicator.classList.add('active');
            } else {
                indicator.classList.remove('active');
            }
        }

        function updateCameraImage(base64Image) {
            const cameraDisplay = document.getElementById('camera-display');
            
            if (base64Image && base64Image.length > 0) {
                cameraDisplay.innerHTML = `
                    <img class="camera-image" src="data:image/jpeg;base64,${base64Image}" alt="Security Camera">
                    <div class="motion-radar" id="motion-radar">
                        <div class="radar-dot" id="radar-dot"></div>
                    </div>
                `;
                showToast('·∫¢nh m·ªõi ƒë√£ ƒë∆∞·ª£c ch·ª•p', 'success');
            }
        }

        // Motion Detection Functions
        function updateMotionStatus(motion) {
            const motionSensor = document.getElementById('motion-sensor');
            const motionStatus = document.getElementById('motion-status');
            const motionRadar = document.getElementById('motion-radar');
            const radarDot = document.getElementById('radar-dot');
            
            isMotionDetected = (motion === 1);
            
            if (isMotionDetected) {
                motionSensor.classList.add('active');
                motionStatus.textContent = 'Ph√°t hi·ªán chuy·ªÉn ƒë·ªông';
                motionStatus.style.color = '#10b981';
                motionRadar.classList.add('active');
                radarDot.classList.add('active');
                
                // Trigger camera if auto mode is on
                if (isAutoCapture && actionCameraManual) {
                    eraWidget.triggerAction(actionCameraManual.action, null);
                }
                
                showToast('‚ö†Ô∏è Ph√°t hi·ªán chuy·ªÉn ƒë·ªông!', 'warning');
            } else {
                motionSensor.classList.remove('active');
                motionStatus.textContent = 'Kh√¥ng ph√°t hi·ªán';
                motionStatus.style.color = '#64748b';
                motionRadar.classList.remove('active');
                radarDot.classList.remove('active');
            }
        }

        function updateIntruderAlert(alert) {
            if (alert === 1) {
                showToast('üö® C·∫¢NH B√ÅO X√ÇM NH·∫¨P! Ph√°t hi·ªán nhi·ªÅu l·∫ßn th·ª≠ sai!', 'error');
                
                // Add to history
                addToHistory('system', 'ALERT', 'C·∫£nh b√°o x√¢m nh·∫≠p', 'failed');
                
                // Trigger camera
                if (actionCameraManual) {
                    eraWidget.triggerAction(actionCameraManual.action, null);
                }
            }
        }

        // Access History Functions
        function updateAccessLog(logData) {
            if (logData && logData.length > 0) {
                try {
                    const log = JSON.parse(logData);
                    addToHistory(log.method, log.id, log.status === 'success' ? 'Cho ph√©p' : 'T·ª´ ch·ªëi', log.status);
                } catch (e) {
                    console.error('Error parsing access log:', e);
                }
            }
        }

        function addToHistory(method, id, result, status) {
            const now = new Date();
            const historyItem = {
                timestamp: now.toLocaleString('vi-VN'),
                method: method,
                id: id,
                name: getNameFromId(method, id),
                result: result,
                status: status
            };
            
            accessHistory.unshift(historyItem);
            
            // Keep only last 100 records
            if (accessHistory.length > 100) {
                accessHistory = accessHistory.slice(0, 100);
            }
            
            renderHistoryTable();
        }

        function renderHistoryTable() {
            const tbody = document.getElementById('history-tbody');
            
            if (accessHistory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #64748b;">
                            <i class="fas fa-clock" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                            <div>Ch∆∞a c√≥ l·ªãch s·ª≠ truy c·∫≠p</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const filteredHistory = filterHistory();
            
            tbody.innerHTML = filteredHistory.map(item => `
                <tr>
                    <td>${item.timestamp}</td>
                    <td>
                        <span class="method-badge method-${item.method}">
                            <i class="fas fa-${item.method === 'fingerprint' ? 'fingerprint' : item.method === 'rfid' ? 'credit-card' : 'exclamation-triangle'}"></i>
                            ${item.method === 'fingerprint' ? 'V√¢n tay' : item.method === 'rfid' ? 'RFID' : 'H·ªá th·ªëng'}
                        </span>
                    </td>
                    <td>${item.id}</td>
                    <td>${item.name || 'Kh√¥ng x√°c ƒë·ªãnh'}</td>
                    <td class="status-${item.status}">${item.result}</td>
                    <td>
                        <button class="btn-delete" onclick="deleteHistoryItem('${item.timestamp}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function filterHistory() {
            const dateFilter = document.getElementById('date-filter').value;
            const monthFilter = document.getElementById('month-filter').value;
            const methodFilter = document.getElementById('method-filter').value;
            
            return accessHistory.filter(item => {
                const itemDate = new Date(item.timestamp.split(', ')[0].split('/').reverse().join('-'));
                
                if (dateFilter && itemDate.toISOString().split('T')[0] !== dateFilter) {
                    return false;
                }
                
                if (monthFilter && (itemDate.getMonth() + 1).toString() !== monthFilter) {
                    return false;
                }
                
                if (methodFilter && item.method !== methodFilter) {
                    return false;
                }
                
                return true;
            });
        }

        function deleteHistoryItem(timestamp) {
            if (confirm('X√≥a m·ª•c l·ªãch s·ª≠ n√†y?')) {
                accessHistory = accessHistory.filter(item => item.timestamp !== timestamp);
                renderHistoryTable();
                showToast('ƒê√£ x√≥a m·ª•c l·ªãch s·ª≠', 'success');
            }
        }

        function clearHistory() {
            if (confirm('X√≥a t·∫•t c·∫£ l·ªãch s·ª≠ truy c·∫≠p?')) {
                accessHistory = [];
                renderHistoryTable();
                showToast('ƒê√£ x√≥a t·∫•t c·∫£ l·ªãch s·ª≠', 'success');
            }
        }

        function exportHistory() {
            const filteredHistory = filterHistory();
            
            if (filteredHistory.length === 0) {
                showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t', 'warning');
                return;
            }
            
            const csv = [
                ['Th·ªùi gian', 'Ph∆∞∆°ng th·ª©c', 'ID/UID', 'T√™n', 'K·∫øt qu·∫£', 'Tr·∫°ng th√°i'],
                ...filteredHistory.map(item => [
                    item.timestamp,
                    item.method === 'fingerprint' ? 'V√¢n tay' : item.method === 'rfid' ? 'RFID' : 'H·ªá th·ªëng',
                    item.id,
                    item.name || 'Kh√¥ng x√°c ƒë·ªãnh',
                    item.result,
                    item.status === 'success' ? 'Th√†nh c√¥ng' : 'Th·∫•t b·∫°i'
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `lich_su_truy_cap_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('ƒê√£ xu·∫•t file Excel th√†nh c√¥ng', 'success');
        }

        // List Management Functions
        function updateFingerprintList(listData) {
            if (listData && listData.length > 0) {
                try {
                    fingerprintList = JSON.parse(listData);
                    renderFingerprintList();
                } catch (e) {
                    console.error('Error parsing fingerprint list:', e);
                }
            }
        }

        function updateRFIDList(listData) {
            if (listData && listData.length > 0) {
                try {
                    rfidList = JSON.parse(listData);
                    renderRFIDList();
                } catch (e) {
                    console.error('Error parsing RFID list:', e);
                }
            }
        }

        function renderFingerprintList() {
            const container = document.getElementById('fp-list');
            
            if (fingerprintList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-fingerprint" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                        <div>Ch∆∞a c√≥ v√¢n tay n√†o ƒë∆∞·ª£c l∆∞u</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = fingerprintList.map(item => `
                <div class="list-item">
                    <div class="item-info">
                        <div class="item-id">ID: ${item.id}</div>
                        <div class="item-name">${item.name}</div>
                    </div>
                    <button class="btn-delete" onclick="deleteFingerprint(${item.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function renderRFIDList() {
            const container = document.getElementById('rfid-list');
            
            if (rfidList.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-credit-card" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                        <div>Ch∆∞a c√≥ th·∫ª RFID n√†o ƒë∆∞·ª£c l∆∞u</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = rfidList.map(item => `
                <div class="list-item">
                    <div class="item-info">
                        <div class="item-id">${item.uid}</div>
                        <div class="item-name">${item.name}</div>
                    </div>
                    <button class="btn-delete" onclick="deleteRFID('${item.uid}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        // Delete Functions
        function deleteFingerprint(id) {
            if (confirm(`X√≥a v√¢n tay ID ${id}?`)) {
                if (actionFingerprintDelete) {
                    eraWidget.triggerAction(actionFingerprintDelete.action, null);
                    showToast(`ƒêang x√≥a v√¢n tay ID ${id}...`, 'warning');
                    
                    // Remove from local list
                    fingerprintList = fingerprintList.filter(item => item.id !== id);
                    renderFingerprintList();
                }
            }
        }

        function deleteRFID(uid) {
            if (confirm(`X√≥a th·∫ª RFID ${uid}?`)) {
                if (actionRfidDelete) {
                    eraWidget.triggerAction(actionRfidDelete.action, null);
                    showToast(`ƒêang x√≥a th·∫ª RFID ${uid}...`, 'warning');
                    
                    // Remove from local list
                    rfidList = rfidList.filter(item => item.uid !== uid);
                    renderRFIDList();
                }
            }
        }

        function clearFingerprintList() {
            if (confirm('X√≥a t·∫•t c·∫£ v√¢n tay ƒë√£ l∆∞u?')) {
                fingerprintList.forEach(item => {
                    if (actionFingerprintDelete) {
                        eraWidget.triggerAction(actionFingerprintDelete.action, null);
                    }
                });
                fingerprintList = [];
                renderFingerprintList();
                showToast('ƒê√£ x√≥a t·∫•t c·∫£ v√¢n tay', 'warning');
            }
        }

        function clearRFIDList() {
            if (confirm('X√≥a t·∫•t c·∫£ th·∫ª RFID ƒë√£ l∆∞u?')) {
                rfidList.forEach(item => {
                    if (actionRfidDelete) {
                        eraWidget.triggerAction(actionRfidDelete.action, null);
                    }
                });
                rfidList = [];
                renderRFIDList();
                showToast('ƒê√£ x√≥a t·∫•t c·∫£ th·∫ª RFID', 'warning');
            }
        }

        // Utility Functions
        function showEnrollForm(type) {
            document.getElementById(type + '-enroll-form').classList.add('show');
        }

        function hideEnrollForm(type) {
            document.getElementById(type + '-enroll-form').classList.remove('show');
        }

        function getNextAvailableFingerprintId() {
            const usedIds = fingerprintList.map(item => item.id);
            for (let i = 1; i <= 255; i++) {
                if (!usedIds.includes(i)) {
                    return i;
                }
            }
            return 1;
        }

        function isRFIDRegistered(uid) {
            return rfidList.some(item => item.uid === uid);
        }

        function getNameFromId(method, id) {
            if (method === 'fingerprint') {
                const item = fingerprintList.find(fp => fp.id == id);
                return item ? item.name : 'Kh√¥ng x√°c ƒë·ªãnh';
            } else if (method === 'rfid') {
                const item = rfidList.find(rfid => rfid.uid === id);
                return item ? item.name : 'Kh√¥ng x√°c ƒë·ªãnh';
            }
            return 'H·ªá th·ªëng';
        }

        // Toast Notification System
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${getToastIcon(type)}"></i>
                    <div>${message}</div>
                </div>
            `;
            
            document.getElementById('toast-container').appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        function getToastIcon(type) {
            switch(type) {
                case 'success': return 'check-circle';
                case 'error': return 'exclamation-circle';
                case 'warning': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }

        // Initialize dashboard on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Smart Door Dashboard initialized');
            
            // Set current date
            document.getElementById('date-filter').value = new Date().toISOString().split('T')[0];
            
            // Add event listeners for filters
            document.getElementById('date-filter').addEventListener('change', renderHistoryTable);
            document.getElementById('month-filter').addEventListener('change', renderHistoryTable);
            document.getElementById('method-filter').addEventListener('change', renderHistoryTable);
            
            showToast('Dashboard ƒë√£ t·∫£i xong - ƒêang k·∫øt n·ªëi v·ªõi E-Ra...', 'info');
        });

        // Auto-refresh data every 5 seconds
        setInterval(() => {
            if (configDoorStatus) {
                eraWidget.readPin(configDoorStatus.pin);
            }
            if (configPirMotion) {
                eraWidget.readPin(configPirMotion.pin);
            }
            if (configCameraStatus) {
                eraWidget.readPin(configCameraStatus.pin);
            }
        }, 5000);
    </script>
</body>
</html>
