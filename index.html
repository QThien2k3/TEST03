<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Gate Security Dashboard v5.0 - Production Ready</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        :root {
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --background: #0a0e27;
            --surface: #151c3d;
            --surface-light: #1e2951;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --border: #2a3660;
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Alert System */
        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            width: 400px;
            max-width: calc(100vw - 40px);
            pointer-events: none;
        }

        .alert {
            pointer-events: all;
            margin-bottom: 12px;
            transform: translateX(100%);
            animation: slideInRight 0.4s ease forwards;
            padding: 16px 20px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 14px;
            background: var(--surface);
            border: 1px solid;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        @keyframes slideInRight {
            to { transform: translateX(0); }
        }

        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: currentColor;
        }

        .alert-success { border-color: var(--success-color); color: var(--success-color); }
        .alert-warning { border-color: var(--warning-color); color: var(--warning-color); }
        .alert-danger { border-color: var(--danger-color); color: var(--danger-color); }
        .alert-info { border-color: var(--primary-color); color: var(--primary-color); }

        .alert-close {
            margin-left: auto;
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 18px;
            opacity: 0.7;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .alert-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            background: var(--surface);
            border: 1px solid var(--border);
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            color: var(--success-color);
            border-color: var(--success-color);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }

        .connection-status.disconnected {
            color: var(--danger-color);
            border-color: var(--danger-color);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
        }

        .connection-status i {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Container */
        .dashboard-container {
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
            padding-top: 80px;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .dashboard-header h1 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 800;
            margin-bottom: 12px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .dashboard-header p {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 32px;
            margin-bottom: 32px;
        }

        .card {
            background: var(--surface);
            border-radius: 24px;
            padding: 32px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            transform: translateY(-8px);
            border-color: var(--primary-color);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.1);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 28px;
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-right: 18px;
            position: relative;
            overflow: hidden;
        }

        .card-icon::before {
            content: '';
            position: absolute;
            inset: 0;
            background: inherit;
            filter: brightness(1.2);
            animation: iconShimmer 3s ease-in-out infinite;
        }

        @keyframes iconShimmer {
            0%, 100% { opacity: 0; }
            50% { opacity: 0.3; }
        }

        .card-icon i {
            color: white;
            z-index: 1;
            position: relative;
        }

        .card-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Door Control */
        .door-control .card-icon {
            background: var(--gradient-success);
        }

        .door-visualization {
            width: 300px;
            height: 200px;
            margin: 28px auto;
            position: relative;
            perspective: 1500px;
        }

        .door-frame {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 16px;
            position: relative;
            border: 4px solid #2a3660;
            overflow: hidden;
            box-shadow: inset 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .door-panel {
            width: 85%;
            height: 90%;
            background: var(--gradient-primary);
            position: absolute;
            top: 5%;
            left: 7.5%;
            border-radius: 12px;
            transition: transform 2s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: left center;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
        }

        .door-panel.open {
            transform: perspective(1500px) rotateY(-85deg) translateZ(40px);
        }

        .door-handle {
            width: 16px;
            height: 45px;
            background: var(--gradient-warning);
            border-radius: 16px;
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.4);
        }

        .door-status {
            margin: 24px 0;
            font-size: 1.4rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 14px;
        }

        .status-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            animation: statusPulse 2s infinite;
            box-shadow: 0 0 20px currentColor;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.3); }
        }

        .status-closed { color: var(--danger-color); }
        .status-open { color: var(--success-color); }

        .status-closed .status-indicator { background: var(--danger-color); }
        .status-open .status-indicator { background: var(--success-color); }

        .control-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 28px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 140px;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: var(--gradient-warning);
            color: white;
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.2);
        }

        /* Access Management */
        .access-management .card-icon {
            background: var(--gradient-primary);
        }

        .access-tabs {
            display: flex;
            margin-bottom: 28px;
            background: var(--background);
            border-radius: 16px;
            padding: 6px;
            border: 1px solid var(--border);
        }

        .tab-button {
            flex: 1;
            padding: 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 15px;
        }

        .tab-button.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            background: var(--background);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            position: relative;
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 14px;
        }

        .section-header strong {
            font-size: 1.15rem;
            color: var(--text-primary);
        }

        .section-header i {
            color: var(--primary-color);
            font-size: 20px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .input-field {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border);
            border-radius: 14px;
            background: var(--surface);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--surface-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .scan-section, .detect-section {
            border: 2px dashed var(--border);
            background: rgba(30, 41, 81, 0.3);
            border-radius: 18px;
            padding: 24px;
            margin-bottom: 24px;
            transition: all 0.4s ease;
            text-align: center;
        }

        .scan-section.scanning, .detect-section.detecting {
            border-color: var(--primary-color);
            animation: scanPulse 2s infinite;
            background: rgba(59, 130, 246, 0.1);
        }

        @keyframes scanPulse {
            0%, 100% { 
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            50% { 
                border-color: #60a5fa;
                box-shadow: 0 0 0 15px rgba(59, 130, 246, 0);
            }
        }

        .scan-status, .rfid-status {
            margin: 16px 0;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            background: var(--surface-light);
            font-weight: 500;
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            border: 1px solid var(--border);
        }

        .fingerprint-list, .rfid-list {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 16px;
            background: var(--surface);
            margin-top: 24px;
        }

        .fingerprint-list::-webkit-scrollbar, .rfid-list::-webkit-scrollbar {
            width: 8px;
        }

        .fingerprint-list::-webkit-scrollbar-track, .rfid-list::-webkit-scrollbar-track {
            background: var(--background);
            border-radius: 10px;
        }

        .fingerprint-list::-webkit-scrollbar-thumb, .rfid-list::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        .list-item {
            padding: 18px 22px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            background: var(--surface);
        }

        .list-item:hover {
            background: var(--surface-light);
            transform: translateX(4px);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item-info {
            display: flex;
            align-items: center;
            gap: 14px;
            flex: 1;
        }

        .list-item-info i {
            color: var(--primary-color);
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .list-item-info span {
            font-weight: 500;
            color: var(--text-primary);
        }

        .delete-btn {
            padding: 8px 16px;
            background: var(--gradient-danger);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .delete-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        /* Camera Section */
        .camera-section .card-icon {
            background: var(--gradient-danger);
        }

        .security-radar {
            width: 100%;
            height: 260px;
            position: relative;
            background: radial-gradient(circle at center, rgba(30, 41, 81, 0.9) 0%, rgba(10, 14, 39, 1) 100%);
            border-radius: 18px;
            overflow: hidden;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
        }

        .radar-container {
            width: 220px;
            height: 220px;
            position: relative;
        }

        .radar-circle {
            position: absolute;
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .radar-circle:nth-child(1) { width: 220px; height: 220px; }
        .radar-circle:nth-child(2) { width: 165px; height: 165px; }
        .radar-circle:nth-child(3) { width: 110px; height: 110px; }
        .radar-circle:nth-child(4) { width: 55px; height: 55px; }

        .radar-sweep {
            position: absolute;
            width: 100%;
            height: 100%;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                rgba(59, 130, 246, 0.8) 10deg,
                rgba(59, 130, 246, 0.4) 30deg,
                transparent 60deg
            );
            animation: radarSweep 4s linear infinite;
            border-radius: 50%;
        }

        @keyframes radarSweep {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .radar-center {
            position: absolute;
            width: 14px;
            height: 14px;
            background: var(--primary-color);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 30px var(--primary-color);
            animation: centerPulse 2s ease-in-out infinite;
        }

        @keyframes centerPulse {
            0%, 100% { box-shadow: 0 0 30px var(--primary-color); }
            50% { box-shadow: 0 0 50px var(--primary-color), 0 0 80px rgba(59, 130, 246, 0.5); }
        }

        .motion-indicator {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            padding: 14px 28px;
            border-radius: 28px;
            font-weight: 600;
            margin: 20px auto;
            width: fit-content;
            font-size: 15px;
            border: 2px solid;
            transition: all 0.3s ease;
        }

        .motion-indicator-container {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .motion-detected {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
            border-color: var(--danger-color);
            animation: alertPulse 1.5s ease-in-out infinite;
        }

        @keyframes alertPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        .motion-clear {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .camera-feed {
            width: 100%;
            height: 260px;
            background: var(--surface);
            border-radius: 18px;
            margin: 24px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border);
            overflow: hidden;
            position: relative;
        }

        .camera-placeholder {
            text-align: center;
            color: var(--text-secondary);
            padding: 24px;
        }

        .camera-placeholder i {
            font-size: 64px;
            margin-bottom: 20px;
            color: var(--primary-color);
            opacity: 0.6;
            animation: cameraFloat 3s ease-in-out infinite;
        }

        @keyframes cameraFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .camera-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 16px;
        }

        .camera-info {
            margin-top: 24px;
            padding: 20px;
            background: var(--background);
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .camera-info div {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.8;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .camera-info div:last-child {
            margin-bottom: 0;
        }

        .camera-info i {
            color: var(--primary-color);
            width: 16px;
            text-align: center;
        }

        /* History Section */
        .history-section {
            grid-column: 1 / -1;
        }

        .history-section .card-icon {
            background: var(--gradient-warning);
        }

        .history-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .filter-select, .filter-input {
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--background);
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .history-table-container {
            overflow-x: auto;
            border-radius: 16px;
            border: 1px solid var(--border);
            background: var(--background);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
        }

        .history-table th {
            background: var(--surface-light);
            padding: 20px 18px;
            text-align: left;
            font-weight: 700;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .history-table td {
            padding: 16px 18px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
            font-size: 14px;
        }

        .history-table tr:hover td {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .method-badge, .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            border-radius: 24px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .method-fingerprint {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .method-rfid {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .status-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-failed {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .action-badge {
            padding: 8px 14px;
            border-radius: 24px;
            font-size: 12px;
            font-weight: 600;
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning-color);
            border: 1px solid rgba(245, 158, 11, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 16px;
                padding-top: 100px;
            }

            .dashboard-header h1 {
                font-size: 2.5rem;
                flex-direction: column;
                gap: 12px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .control-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .alert-container {
                width: calc(100vw - 32px);
                right: 16px;
            }

            .connection-status {
                left: 16px;
                top: 16px;
                font-size: 12px;
                padding: 8px 14px;
            }

            .card {
                padding: 24px;
            }

            .door-visualization {
                width: 250px;
                height: 160px;
            }

            .security-radar {
                height: 200px;
            }

            .radar-container {
                width: 180px;
                height: 180px;
            }

            .history-filters {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        @media (max-width: 480px) {
            .dashboard-header h1 {
                font-size: 2rem;
            }

            .card {
                padding: 20px;
                border-radius: 16px;
            }

            .door-visualization {
                width: 200px;
                height: 140px;
            }

            .camera-feed {
                height: 200px;
            }
        }

        /* Custom Animations */
        .enrollment-section {
            animation: slideDown 0.4s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .rfid-management {
            animation: slideDown 0.4s ease;
        }

        /* Motion Blips */
        .motion-blip {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--danger-color);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--danger-color);
            animation: blipPulse 3s ease-out forwards;
        }

        @keyframes blipPulse {
            0% { 
                transform: scale(0); 
                opacity: 1; 
            }
            30% { 
                transform: scale(1); 
                opacity: 0.8; 
            }
            100% { 
                transform: scale(3); 
                opacity: 0; 
            }
        }
    </style>
</head>
<body>
    <!-- Alert Container -->
    <div class="alert-container" id="alertContainer"></div>

    <!-- Connection Status -->
    <div class="connection-status disconnected" id="connectionStatus">
        <i class="fas fa-circle"></i>
        <span>Đang kết nối...</span>
    </div>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1>
                <i class="fas fa-door-open"></i>
                Smart Gate Security v5.0
            </h1>
            <p>Hệ thống cửa thông minh với AI & IoT - Production Ready</p>
        </div>

        <div class="dashboard-grid">
            <!-- Door Control -->
            <div class="card door-control">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-door-open"></i>
                    </div>
                    <div class="card-title">Điều Khiển Cửa</div>
                </div>
                
                <div class="door-visualization">
                    <div class="door-frame">
                        <div class="door-panel" id="doorPanel">
                            <div class="door-handle"></div>
                        </div>
                    </div>
                </div>
                
                <div class="door-status status-closed" id="doorStatus">
                    <span class="status-indicator"></span>
                    <span id="doorStatusText">Đóng</span>
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-success" onclick="doorController.openDoor()">
                        <i class="fas fa-unlock"></i>
                        <span>Mở Cửa</span>
                    </button>
                    <button class="btn btn-danger" onclick="doorController.closeDoor()">
                        <i class="fas fa-lock"></i>
                        <span>Đóng Cửa</span>
                    </button>
                </div>
            </div>

            <!-- Access Management -->
            <div class="card access-management">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="card-title">Quản Lý Truy Cập</div>
                </div>

                <div class="access-tabs">
                    <button class="tab-button active" onclick="switchTab('fingerprint', this)">
                        <i class="fas fa-fingerprint"></i>
                        <span>Vân Tay</span>
                    </button>
                    <button class="tab-button" onclick="switchTab('rfid', this)">
                        <i class="fas fa-id-card"></i>
                        <span>Thẻ RFID</span>
                    </button>
                </div>

                <!-- Fingerprint Tab -->
                <div class="tab-content active" id="fingerprintTab">
                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-fingerprint"></i>
                            <strong>Quét và xác minh vân tay</strong>
                        </div>
                        
                        <div class="scan-section" id="fingerprintScanSection">
                            <div class="scan-status" id="fingerprintScanStatus">
                                Nhấn nút bên dưới để bắt đầu quét vân tay
                            </div>
                            
                            <button class="btn btn-primary" id="startScanBtn" onclick="fingerprintController.startScan()" style="width: 100%; margin-top: 16px;">
                                <i class="fas fa-fingerprint"></i>
                                <span>Bắt Đầu Quét</span>
                            </button>
                            <button class="btn btn-danger" id="stopScanBtn" onclick="fingerprintController.stopScan()" style="display: none; width: 100%; margin-top: 16px;">
                                <i class="fas fa-stop"></i>
                                <span>Dừng Quét</span>
                            </button>
                        </div>

                        <!-- Fingerprint Enrollment -->
                        <div class="enrollment-section" style="display: none; margin-top: 24px;" id="fingerprintEnrollSection">
                            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                                <i class="fas fa-check-circle" style="font-size: 28px; margin-right: 14px; color: var(--success-color);"></i>
                                <strong style="font-size: 1.2rem; color: var(--success-color);">Vân tay đã xác minh thành công!</strong>
                            </div>
                            
                            <div class="input-group">
                                <label>ID Vân Tay Đã Phát Hiện:</label>
                                <input type="text" class="input-field" id="verifiedFingerprintId" readonly>
                            </div>
                            
                            <div class="input-group">
                                <label>Tên Người Dùng:</label>
                                <input type="text" class="input-field" id="fingerprintName" placeholder="Nhập tên cho vân tay này" maxlength="30">
                            </div>
                            
                            <button class="btn btn-success" onclick="fingerprintController.enrollVerified()" style="width: 100%;">
                                <i class="fas fa-check"></i>
                                <span>Thêm Vào Danh Sách</span>
                            </button>
                        </div>
                    </div>

                    <!-- Manual Fingerprint Enrollment -->
                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-plus-circle"></i>
                            <strong>Đăng ký vân tay mới</strong>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 16px; margin-bottom: 16px;">
                            <input type="number" class="input-field" id="manualFingerprintId" placeholder="ID (1-127)" min="1" max="127">
                            <input type="text" class="input-field" id="manualFingerprintName" placeholder="Tên người dùng" maxlength="30">
                        </div>
                        
                        <button class="btn btn-primary" style="width: 100%;" onclick="fingerprintController.enrollManual()">
                            <i class="fas fa-plus"></i>
                            <span>Đăng Ký Vân Tay Mới</span>
                        </button>
                    </div>
                    
                    <!-- Fingerprint List -->
                    <div style="margin-top: 28px;">
                        <div style="margin-bottom: 16px; font-weight: 600; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center;">
                            <span>
                                <i class="fas fa-list"></i> 
                                Danh sách vân tay đã lưu (<span id="fingerprintCount">0</span>):
                            </span>
                            <button class="btn btn-warning" style="padding: 8px 16px; font-size: 12px;" onclick="fingerprintController.clearAll()">
                                <i class="fas fa-trash-alt"></i> 
                                Xóa tất cả
                            </button>
                        </div>
                        
                        <div class="fingerprint-list" id="fingerprintList">
                            <div style="text-align: center; color: var(--text-secondary); padding: 32px;">
                                <div class="loading-text">
                                    <div class="loading"></div>
                                    <span>Đang tải danh sách vân tay...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RFID Tab -->
                <div class="tab-content" id="rfidTab">
                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-wifi"></i>
                            <strong>Quét và phát hiện thẻ RFID</strong>
                        </div>
                        
                        <div class="detect-section" id="rfidDetectSection">
                            <div class="rfid-status" id="rfidDetectionStatus">
                                Nhấn nút để bắt đầu quét thẻ RFID
                            </div>
                            
                            <button class="btn btn-primary" onclick="rfidController.testScan()" style="width: 100%; margin-top: 16px;">
                                <i class="fas fa-id-card"></i>
                                <span>Bắt Đầu Quét Thẻ</span>
                            </button>
                        </div>

                        <!-- RFID Management -->
                        <div class="rfid-management" id="rfidManagementSection" style="display: none; margin-top: 24px;">
                            <div style="display: flex; align-items: center; margin-bottom: 20px;">
                                <i class="fas fa-check-circle" style="font-size: 28px; margin-right: 14px; color: var(--success-color);"></i>
                                <strong style="font-size: 1.2rem; color: var(--success-color);">Thẻ RFID đã được phát hiện!</strong>
                            </div>
                            
                            <div class="input-group">
                                <label>UID Thẻ RFID:</label>
                                <input type="text" class="input-field" id="rfidUid" readonly>
                            </div>
                            
                            <div class="input-group">
                                <label>Tên Chủ Thẻ:</label>
                                <input type="text" class="input-field" id="rfidCardName" placeholder="Nhập tên cho thẻ này" maxlength="30">
                            </div>
                            
                            <button class="btn btn-success" onclick="rfidController.addScanned()" style="width: 100%;">
                                <i class="fas fa-check"></i>
                                <span>Thêm Vào Danh Sách</span>
                            </button>
                        </div>
                    </div>

                    <!-- Manual RFID Addition -->
                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-plus-circle"></i>
                            <strong>Thêm thẻ RFID thủ công</strong>
                        </div>
                        
                        <input type="text" class="input-field" id="manualRfidUid" placeholder="Nhập UID thẻ (VD: 04A1B2C3)" style="margin-bottom: 16px;" maxlength="20">
                        <input type="text" class="input-field" id="manualRfidName" placeholder="Tên chủ thẻ" maxlength="30">
                        
                        <button class="btn btn-primary" style="margin-top: 16px; width: 100%;" onclick="rfidController.addManual()">
                            <i class="fas fa-plus"></i>
                            <span>Thêm Thẻ RFID</span>
                        </button>
                    </div>
                    
                    <!-- RFID List -->
                    <div style="margin-top: 28px;">
                        <div style="margin-bottom: 16px; font-weight: 600; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center;">
                            <span>
                                <i class="fas fa-list"></i> 
                                Danh sách thẻ RFID đã lưu (<span id="rfidCount">0</span>):
                            </span>
                            <button class="btn btn-warning" style="padding: 8px 16px; font-size: 12px;" onclick="rfidController.clearAll()">
                                <i class="fas fa-trash-alt"></i> 
                                Xóa tất cả
                            </button>
                        </div>
                        
                        <div class="rfid-list" id="rfidList">
                            <div style="text-align: center; color: var(--text-secondary); padding: 32px;">
                                <div class="loading-text">
                                    <div class="loading"></div>
                                    <span>Đang tải danh sách thẻ RFID...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Camera Security -->
            <div class="card camera-section">
                <div class="card-header">
                    <div class="card-icon">
                        <i class="fas fa-video"></i>
                    </div>
                    <div class="card-title">Camera An Ninh</div>
                </div>

                <div class="security-radar">
                    <div class="radar-container">
                        <div class="radar-circle"></div>
                        <div class="radar-circle"></div>
                        <div class="radar-circle"></div>
                        <div class="radar-circle"></div>
                        <div class="radar-sweep"></div>
                        <div class="radar-center"></div>
                        <div id="motionBlips"></div>
                    </div>
                </div>

                <div class="motion-indicator-container">
                    <div class="motion-indicator motion-clear" id="motionIndicator">
                        <i class="fas fa-shield-alt"></i>
                        <span id="motionText">Không có chuyển động</span>
                    </div>
                </div>

                <div class="camera-feed" id="cameraFeed">
                    <div class="camera-placeholder">
                        <i class="fas fa-camera"></i>
                        <div style="font-weight: 600; margin-bottom: 8px;">ESP32-CAM Auto Capture</div>
                        <div style="font-size: 14px; opacity: 0.8;">
                            Camera sẽ tự động chụp ảnh khi phát hiện chuyển động
                        </div>
                        <div style="font-size: 12px; margin-top: 12px; opacity: 0.6;">
                            Ảnh sẽ được gửi ngay lập tức về email
                        </div>
                    </div>
                </div>

                <div class="camera-info">
                    <div>
                        <i class="fas fa-envelope"></i>
                        <span>Email nhận cảnh báo: phamquocthien17@gmail.com</span>
                    </div>
                    <div>
                        <i class="fas fa-robot"></i>
                        <span>Tự động chụp ảnh khi phát hiện chuyển động</span>
                    </div>
                    <div>
                        <i class="fas fa-clock"></i>
                        <span>Thời gian chờ giữa các lần chụp: 3 giây</span>
                    </div>
                    <div>
                        <i class="fas fa-camera"></i>
                        <span id="cameraStatus">ESP32-CAM: Đang kết nối...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Access History -->
        <div class="card history-section">
            <div class="card-header">
                <div class="card-icon">
                    <i class="fas fa-history"></i>
                </div>
                <div class="card-title">Lịch Sử Truy Cập</div>
            </div>

            <div class="history-filters">
                <div class="filter-group">
                    <label>Lọc theo ngày:</label>
                    <input type="date" class="filter-input" id="filterDate" onchange="historyController.filter()">
                </div>
                <div class="filter-group">
                    <label>Lọc theo tháng:</label>
                    <select class="filter-select" id="filterMonth" onchange="historyController.filter()">
                        <option value="">Tất cả tháng</option>
                        <option value="1">Tháng 1</option>
                        <option value="2">Tháng 2</option>
                        <option value="3">Tháng 3</option>
                        <option value="4">Tháng 4</option>
                        <option value="5">Tháng 5</option>
                        <option value="6">Tháng 6</option>
                        <option value="7">Tháng 7</option>
                        <option value="8">Tháng 8</option>
                        <option value="9">Tháng 9</option>
                        <option value="10">Tháng 10</option>
                        <option value="11">Tháng 11</option>
                        <option value="12">Tháng 12</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Phương thức:</label>
                    <select class="filter-select" id="filterMethod" onchange="historyController.filter()">
                        <option value="">Tất cả phương thức</option>
                        <option value="fingerprint">Vân tay</option>
                        <option value="rfid">Thẻ RFID</option>
                        <option value="manual">Thủ công</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-warning" onclick="historyController.clearHistory()">
                        <i class="fas fa-trash-alt"></i>
                        <span>Xóa lịch sử</span>
                    </button>
                </div>
            </div>

            <div class="history-table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Thời gian</th>
                            <th>Phương thức</th>
                            <th>ID/UID</th>
                            <th>Tên người dùng</th>
                            <th>Kết quả</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 48px;">
                                <div class="loading-text">
                                    <div class="loading"></div>
                                    <span>Đang tải lịch sử truy cập...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- E-Ra Widget Script -->
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
    <script>
        // Global E-Ra Widget Instance
        const eraWidget = new EraWidget();
        
        // System State Management
        let systemState = {
            doorStatus: 'closed',
            motionDetected: false,
            fingerprintScanActive: false,
            currentVerifiedFingerprintId: null,
            currentScannedRfidUid: null,
            fingerprintList: [],
            rfidList: [],
            accessHistory: [],
            isConnected: false,
            errorCount: 0,
            intruderAlert: false,
            cameraStatus: 'disconnected',
            lastMotionTime: null,
            lastAccessTime: null
        };

        // E-Ra Configuration Storage
        let eraConfigs = {};
        let eraActions = {};

        // Enhanced Alert Manager
        const alertManager = {
            alerts: new Map(),
            
            show(id, message, type = 'success', timeout = 5000) {
                this.remove(id);
                
                const container = document.getElementById('alertContainer');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.id = `alert-${id}`;
                alert.innerHTML = `
                    <i class="fas fa-${this.getIcon(type)}"></i>
                    <span>${message}</span>
                    <button class="alert-close" onclick="alertManager.remove('${id}')">×</button>
                `;
                
                container.appendChild(alert);
                this.alerts.set(id, alert);
                
                // Auto remove
                if (timeout > 0) {
                    setTimeout(() => this.remove(id), timeout);
                }
                
                // Accessibility
                alert.setAttribute('role', 'alert');
                alert.setAttribute('aria-live', 'polite');
                
                return alert;
            },
            
            getIcon(type) {
                const icons = {
                    success: 'check-circle',
                    warning: 'exclamation-triangle',
                    danger: 'exclamation-circle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            },
            
            remove(id) {
                const alert = this.alerts.get(id);
                if (alert && alert.parentElement) {
                    alert.style.transform = 'translateX(100%)';
                    alert.style.opacity = '0';
                    setTimeout(() => {
                        if (alert.parentElement) {
                            alert.remove();
                        }
                        this.alerts.delete(id);
                    }, 300);
                }
            },
            
            clear() {
                this.alerts.forEach((alert, id) => this.remove(id));
                setTimeout(() => {
                    this.show('cleared', '🧹 Đã xóa tất cả thông báo', 'success', 3000);
                }, 500);
            }
        };

        // Connection Manager
        const connectionManager = {
            updateStatus(connected) {
                systemState.isConnected = connected;
                const statusEl = document.getElementById('connectionStatus');
                
                if (connected) {
                    statusEl.className = 'connection-status connected';
                    statusEl.innerHTML = '<i class="fas fa-circle"></i><span>Kết nối E-Ra</span>';
                    alertManager.show('era-connected', '✅ Kết nối E-Ra thành công!', 'success', 4000);
                } else {
                    statusEl.className = 'connection-status disconnected';
                    statusEl.innerHTML = '<i class="fas fa-circle"></i><span>Mất kết nối</span>';
                    alertManager.show('era-disconnected', '❌ Mất kết nối E-Ra. Đang thử kết nối lại...', 'danger', 6000);
                }
            },
            
            testConnection() {
                if (!systemState.isConnected) {
                    alertManager.show('connection-test', '❌ Chưa kết nối E-Ra! Vui lòng kiểm tra kết nối.', 'danger', 4000);
                    return false;
                }
                return true;
            }
        };

        // Door Controller
        const doorController = {
            openDoor() {
                if (!connectionManager.testConnection()) return;
                
                try {
                    eraWidget.triggerAction(eraActions.openDoor.action, null);
                    alertManager.show('door-opening', '🚪 Đang gửi lệnh mở cửa...', 'info', 3000);
                    
                    // Add to history
                    historyController.addEntry('manual', 'DASHBOARD', 'Dashboard User', true, 'Mở cửa');
                } catch (error) {
                    console.error('Error opening door:', error);
                    alertManager.show('door-error', '❌ Lỗi gửi lệnh mở cửa', 'danger', 4000);
                }
            },

            closeDoor() {
                if (!connectionManager.testConnection()) return;
                
                try {
                    eraWidget.triggerAction(eraActions.closeDoor.action, null);
                    alertManager.show('door-closing', '🚪 Đang gửi lệnh đóng cửa...', 'warning', 3000);
                    
                    // Add to history
                    historyController.addEntry('manual', 'DASHBOARD', 'Dashboard User', true, 'Đóng cửa');
                } catch (error) {
                    console.error('Error closing door:', error);
                    alertManager.show('door-error', '❌ Lỗi gửi lệnh đóng cửa', 'danger', 4000);
                }
            }
        };

        // Door Status Handler
        const doorStatusHandler = {
            update(status) {
                const newStatus = (status === 1) ? 'open' : 'closed';
                const wasChanged = systemState.doorStatus !== newStatus;
                systemState.doorStatus = newStatus;
                
                const doorPanel = document.getElementById('doorPanel');
                const doorStatusEl = document.getElementById('doorStatus');
                const doorStatusText = document.getElementById('doorStatusText');
                
                // Update visual state
                doorPanel.classList.remove('open');
                doorStatusEl.className = 'door-status';
                
                if (systemState.doorStatus === 'open') {
                    doorPanel.classList.add('open');
                    doorStatusEl.className = 'door-status status-open';
                    doorStatusText.textContent = 'Mở';
                    
                    if (wasChanged) {
                        alertManager.show('door-opened', '🚪 Cửa đã được mở!', 'success', 4000);
                    }
                } else {
                    doorStatusEl.className = 'door-status status-closed';
                    doorStatusText.textContent = 'Đóng';
                    
                    if (wasChanged) {
                        alertManager.show('door-closed', '🚪 Cửa đã được đóng!', 'warning', 4000);
                    }
                }
            }
        };

        // Fingerprint Controller
        const fingerprintController = {
            startScan() {
                if (!connectionManager.testConnection()) return;
                
                try {
                    eraWidget.triggerAction(eraActions.fingerprintTestScan.action, null);
                    
                    systemState.fingerprintScanActive = true;
                    document.getElementById('startScanBtn').style.display = 'none';
                    document.getElementById('stopScanBtn').style.display = 'inline-flex';
                    document.getElementById('fingerprintScanSection').classList.add('scanning');
                    
                    const statusEl = document.getElementById('fingerprintScanStatus');
                    statusEl.innerHTML = '<i class="fas fa-fingerprint" style="margin-right: 8px; animation: pulse 1s infinite;"></i>Đặt ngón tay lên cảm biến AS608...';
                    statusEl.style.background = 'var(--primary-color)';
                    statusEl.style.color = 'white';
                    
                    alertManager.show('fp-scan-start', '👆 Bắt đầu quét vân tay! Đặt ngón tay lên cảm biến.', 'info', 5000);
                } catch (error) {
                    console.error('Error starting fingerprint scan:', error);
                    alertManager.show('fp-scan-error', '❌ Lỗi khởi động quét vân tay', 'danger', 4000);
                }
            },

            stopScan() {
                try {
                    // Send stop command if needed
                    this.resetScanUI();
                    alertManager.show('fp-scan-stop', '⏹️ Đã dừng quét vân tay', 'warning', 3000);
                } catch (error) {
                    console.error('Error stopping fingerprint scan:', error);
                }
            },

            resetScanUI() {
                systemState.fingerprintScanActive = false;
                document.getElementById('startScanBtn').style.display = 'inline-flex';
                document.getElementById('stopScanBtn').style.display = 'none';
                document.getElementById('fingerprintScanSection').classList.remove('scanning');
                document.getElementById('fingerprintEnrollSection').style.display = 'none';
                
                const statusEl = document.getElementById('fingerprintScanStatus');
                statusEl.textContent = 'Nhấn nút bên dưới để bắt đầu quét vân tay';
                statusEl.style.background = 'var(--surface-light)';
                statusEl.style.color = 'var(--text-primary)';
            },

            handleScanResult(fpId) {
                if (fpId > 0) {
                    // Fingerprint detected
                    systemState.currentVerifiedFingerprintId = fpId;
                    document.getElementById('verifiedFingerprintId').value = `ID #${fpId}`;
                    document.getElementById('fingerprintEnrollSection').style.display = 'block';
                    
                    const statusEl = document.getElementById('fingerprintScanStatus');
                    statusEl.innerHTML = `<i class="fas fa-check-circle" style="margin-right: 8px; color: var(--success-color);"></i>Phát hiện vân tay ID #${fpId}`;
                    statusEl.style.background = 'var(--success-color)';
                    statusEl.style.color = 'white';
                    
                    alertManager.show('fp-detected', `✅ Phát hiện vân tay ID #${fpId}! Nhập tên để thêm vào danh sách.`, 'success', 6000);
                } else {
                    // No fingerprint or error
                    this.resetScanUI();
                    alertManager.show('fp-not-detected', '❌ Không phát hiện vân tay. Vui lòng thử lại.', 'warning', 4000);
                }
            },

            enrollVerified() {
                const name = document.getElementById('fingerprintName').value.trim();
                
                if (!name) {
                    alertManager.show('fp-name-required', '⚠️ Vui lòng nhập tên người dùng', 'warning', 4000);
                    document.getElementById('fingerprintName').focus();
                    return;
                }

                if (!systemState.currentVerifiedFingerprintId) {
                    alertManager.show('fp-no-verified', '⚠️ Không có vân tay được xác minh', 'warning', 4000);
                    return;
                }

                try {
                    const enrollData = {
                        fingerprintId: systemState.currentVerifiedFingerprintId,
                        fingerprintName: name
                    };

                    // Send data to ESP32
                    eraWidget.triggerAction(eraActions.dataPayload.action, JSON.stringify(enrollData));
                    eraWidget.triggerAction(eraActions.fingerprintEnroll.action, null);
                    
                    // Update local list immediately for better UX
                    const newFingerprint = {
                        id: systemState.currentVerifiedFingerprintId,
                        name: name
                    };
                    
                    // Remove existing with same ID
                    systemState.fingerprintList = systemState.fingerprintList.filter(fp => fp.id !== newFingerprint.id);
                    systemState.fingerprintList.push(newFingerprint);
                    systemState.fingerprintList.sort((a, b) => a.id - b.id);
                    
                    alertManager.show('fp-enrolled', `✅ Đã thêm vân tay "${name}" (ID #${systemState.currentVerifiedFingerprintId})`, 'success', 6000);
                    
                    // Add to history
                    historyController.addEntry('fingerprint', systemState.currentVerifiedFingerprintId.toString(), name, true, 'Đăng ký vân tay');
                    
                    // Reset UI
                    document.getElementById('fingerprintName').value = '';
                    systemState.currentVerifiedFingerprintId = null;
                    this.stopScan();
                    this.updateList();
                    
                } catch (error) {
                    console.error('Error enrolling fingerprint:', error);
                    alertManager.show('fp-enroll-error', '❌ Lỗi đăng ký vân tay', 'danger', 4000);
                }
            },

            enrollManual() {
                const id = parseInt(document.getElementById('manualFingerprintId').value);
                const name = document.getElementById('manualFingerprintName').value.trim();
                
                if (!id || id < 1 || id > 127) {
                    alertManager.show('fp-invalid-id', '⚠️ ID vân tay phải từ 1 đến 127', 'warning', 4000);
                    document.getElementById('manualFingerprintId').focus();
                    return;
                }
                
                if (!name) {
                    alertManager.show('fp-name-required', '⚠️ Vui lòng nhập tên người dùng', 'warning', 4000);
                    document.getElementById('manualFingerprintName').focus();
                    return;
                }
                
                if (systemState.fingerprintList.some(fp => fp.id === id)) {
                    alertManager.show('fp-id-exists', `⚠️ ID ${id} đã tồn tại! Vui lòng chọn ID khác.`, 'warning', 5000);
                    document.getElementById('manualFingerprintId').focus();
                    return;
                }

                try {
                    const enrollData = {
                        fingerprintId: id,
                        fingerprintName: name
                    };

                    // Send data to ESP32
                    eraWidget.triggerAction(eraActions.dataPayload.action, JSON.stringify(enrollData));
                    eraWidget.triggerAction(eraActions.fingerprintEnroll.action, null);

                    // Update local list
                    const newFingerprint = { id, name };
                    systemState.fingerprintList.push(newFingerprint);
                    systemState.fingerprintList.sort((a, b) => a.id - b.id);
                    
                    alertManager.show('fp-manual-enrolled', `✅ Đã đăng ký vân tay "${name}" với ID #${id}`, 'success', 6000);
                    
                    // Add to history
                    historyController.addEntry('fingerprint', id.toString(), name, true, 'Đăng ký thủ công');
                    
                    // Clear inputs
                    document.getElementById('manualFingerprintId').value = '';
                    document.getElementById('manualFingerprintName').value = '';
                    this.updateList();
                    
                } catch (error) {
                    console.error('Error enrolling manual fingerprint:', error);
                    alertManager.show('fp-enroll-error', '❌ Lỗi đăng ký vân tay', 'danger', 4000);
                }
            },

            delete(id) {
                const fingerprint = systemState.fingerprintList.find(fp => fp.id === id);
                if (!fingerprint) return;
                
                if (!confirm(`Xác nhận xóa vân tay "${fingerprint.name}" (ID #${id})?`)) return;
                
                try {
                    // Send delete data to ESP32
                    const deleteData = { deleteFingerprintId: id };
                    eraWidget.triggerAction(eraActions.dataPayload.action, JSON.stringify(deleteData));
                    eraWidget.triggerAction(eraActions.fingerprintDelete.action, null);
                    
                    // Update local list
                    systemState.fingerprintList = systemState.fingerprintList.filter(fp => fp.id !== id);
                    
                    alertManager.show('fp-deleted', `🗑️ Đã xóa vân tay "${fingerprint.name}" (ID #${id})`, 'success', 5000);
                    
                    // Add to history
                    historyController.addEntry('fingerprint', id.toString(), fingerprint.name, true, 'Xóa vân tay');
                    
                    this.updateList();
                } catch (error) {
                    console.error('Error deleting fingerprint:', error);
                    alertManager.show('fp-delete-error', '❌ Lỗi xóa vân tay', 'danger', 4000);
                }
            },

            clearAll() {
                if (!confirm('Xác nhận xóa TẤT CẢ vân tay đã lưu?\n\nThao tác này không thể hoàn tác!')) return;
                
                try {
                    // Clear local list
                    systemState.fingerprintList = [];
                    this.updateList();
                    alertManager.show('fp-cleared', '🗑️ Đã xóa tất cả vân tay khỏi danh sách', 'warning', 5000);
                    
                    // Add to history
                    historyController.addEntry('fingerprint', 'ALL', 'System', true, 'Xóa tất cả');
                } catch (error) {
                    console.error('Error clearing all fingerprints:', error);
                    alertManager.show('fp-clear-error', '❌ Lỗi xóa danh sách vân tay', 'danger', 4000);
                }
            },

            updateList() {
                const list = document.getElementById('fingerprintList');
                const countEl = document.getElementById('fingerprintCount');
                
                if (countEl) {
                    countEl.textContent = systemState.fingerprintList.length;
                }
                
                if (systemState.fingerprintList.length === 0) {
                    list.innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
                            <i class="fas fa-fingerprint" style="font-size: 56px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                            <h3 style="margin-bottom: 8px; font-weight: 600;">Chưa có vân tay nào</h3>
                            <p style="font-size: 14px; opacity: 0.8;">Quét hoặc đăng ký vân tay để bắt đầu</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = systemState.fingerprintList.map(fp => `
                    <div class="list-item">
                        <div class="list-item-info">
                            <i class="fas fa-fingerprint"></i>
                            <span><strong>ID #${fp.id}</strong> - ${fp.name}</span>
                        </div>
                        <button class="delete-btn" onclick="fingerprintController.delete(${fp.id})" title="Xóa vân tay">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `).join('');
            }
        };

        // RFID Controller
        const rfidController = {
            testScan() {
                if (!connectionManager.testConnection()) return;

                try {
                    eraWidget.triggerAction(eraActions.rfidTestScan.action, null);
                    document.getElementById('rfidDetectSection').classList.add('detecting');
                    
                    const statusEl = document.getElementById('rfidDetectionStatus');
                    statusEl.innerHTML = '<i class="fas fa-wifi" style="margin-right: 8px; animation: pulse 1s infinite;"></i>Đang quét thẻ RFID... Đặt thẻ gần đầu đọc.';
                    statusEl.style.background = 'var(--primary-color)';
                    statusEl.style.color = 'white';
                    
                    alertManager.show('rfid-scan-start', '💳 Bắt đầu quét thẻ RFID! Đặt thẻ gần đầu đọc RC522.', 'info', 5000);
                    
                    // Auto timeout
                    setTimeout(() => {
                        const section = document.getElementById('rfidDetectSection');
                        if (section.classList.contains('detecting')) {
                            section.classList.remove('detecting');
                            if (statusEl.textContent.includes('Đang quét')) {
                                statusEl.textContent = 'Nhấn nút để bắt đầu quét thẻ RFID';
                                statusEl.style.background = 'var(--surface-light)';
                                statusEl.style.color = 'var(--text-primary)';
                                alertManager.show('rfid-timeout', '⏰ Hết thời gian quét thẻ. Vui lòng thử lại.', 'warning', 4000);
                            }
                        }
                    }, 15000);
                } catch (error) {
                    console.error('Error starting RFID scan:', error);
                    alertManager.show('rfid-scan-error', '❌ Lỗi khởi động quét thẻ RFID', 'danger', 4000);
                }
            },

            handleScanResult(success, uid = null) {
                const section = document.getElementById('rfidDetectSection');
                const statusEl = document.getElementById('rfidDetectionStatus');
                
                section.classList.remove('detecting');
                
                if (success && uid) {
                    // RFID detected
                    systemState.currentScannedRfidUid = uid;
                    document.getElementById('rfidUid').value = uid;
                    document.getElementById('rfidManagementSection').style.display = 'block';
                    
                    statusEl.innerHTML = `<i class="fas fa-check-circle" style="margin-right: 8px; color: var(--success-color);"></i>Phát hiện thẻ: ${uid}`;
                    statusEl.style.background = 'var(--success-color)';
                    statusEl.style.color = 'white';
                    
                    alertManager.show('rfid-detected', `✅ Phát hiện thẻ RFID: ${uid}! Nhập tên để thêm vào danh sách.`, 'success', 6000);
                } else {
                    // No RFID detected
                    statusEl.textContent = 'Nhấn nút để bắt đầu quét thẻ RFID';
                    statusEl.style.background = 'var(--surface-light)';
                    statusEl.style.color = 'var(--text-primary)';
                    alertManager.show('rfid-not-detected', '❌ Không phát hiện thẻ RFID. Vui lòng thử lại.', 'warning', 4000);
                }
            },

            addScanned() {
                const name = document.getElementById('rfidCardName').value.trim();
                
                if (!systemState.currentScannedRfidUid) {
                    alertManager.show('rfid-no-scanned', '⚠️ Không có thẻ được quét', 'warning', 4000);
                    return;
                }
                
                if (!name) {
                    alertManager.show('rfid-name-required', '⚠️ Vui lòng nhập tên chủ thẻ', 'warning', 4000);
                    document.getElementById('rfidCardName').focus();
                    return;
                }

                try {
                    const newCard = {
                        rfidUid: systemState.currentScannedRfidUid,
                        rfidName: name
                    };

                    // Send data to ESP32
                    eraWidget.triggerAction(eraActions.dataPayload.action, JSON.stringify(newCard));
                    eraWidget.triggerAction(eraActions.rfidAdd.action, null);
                    
                    // Update local list
                    const cardData = {
                        uid: systemState.currentScannedRfidUid,
                        name: name
                    };
                    
                    // Remove existing with same UID
                    systemState.rfidList = systemState.rfidList.filter(card => card.uid !== cardData.uid);
                    systemState.rfidList.push(cardData);
                    
                    alertManager.show('rfid-added', `✅ Đã thêm thẻ "${name}" (${systemState.currentScannedRfidUid})`, 'success', 6000);
                    
                    // Add to history
                    historyController.addEntry('rfid', systemState.currentScannedRfidUid, name, true, 'Đăng ký thẻ');
                    
                    // Reset UI
                    document.getElementById('rfidCardName').value = '';
                    document.getElementById('rfidManagementSection').style.display = 'none';
                    systemState.currentScannedRfidUid = null;
                    
                    const statusEl = document.getElementById('rfidDetectionStatus');
                    statusEl.textContent = 'Nhấn nút để bắt đầu quét thẻ RFID';
                    statusEl.style.background = 'var(--surface-light)';
                    statusEl.style.color = 'var(--text-primary)';
                    
                    this.updateList();
                    
                } catch (error) {
                    console.error('Error adding RFID:', error);
                    alertManager.show('rfid-add-error', '❌ Lỗi thêm thẻ RFID', 'danger', 4000);
                }
            },

            addManual() {
                const uid = document.getElementById('manualRfidUid').value.trim().toUpperCase();
                const name = document.getElementById('manualRfidName').value.trim();
                
                if (!uid) {
                    alertManager.show('rfid-uid-required', '⚠️ Vui lòng nhập UID thẻ', 'warning', 4000);
                    document.getElementById('manualRfidUid').focus();
                    return;
                }
                
                if (!name) {
                    alertManager.show('rfid-name-required', '⚠️ Vui lòng nhập tên chủ thẻ', 'warning', 4000);
                    document.getElementById('manualRfidName').focus();
                    return;
                }
                
                if (systemState.rfidList.some(card => card.uid === uid)) {
                    alertManager.show('rfid-uid-exists', '⚠️ UID này đã tồn tại! Vui lòng kiểm tra lại.', 'warning', 5000);
                    document.getElementById('manualRfidUid').focus();
                    return;
                }

                try {
                    const newCard = {
                        rfidUid: uid,
                        rfidName: name
                    };

                    // Send data to ESP32
                    eraWidget.triggerAction(eraActions.dataPayload.action, JSON.stringify(newCard));
                    eraWidget.triggerAction(eraActions.rfidAdd.action, null);

                    // Update local list
                    const cardData = { uid, name };
                    systemState.rfidList.push(cardData);
                    
                    alertManager.show('rfid-manual-added', `✅ Đã thêm thẻ "${name}" với UID ${uid}`, 'success', 6000);
                    
                    // Add to history
                    historyController.addEntry('rfid', uid, name, true, 'Đăng ký thủ công');
                    
                    // Clear inputs
                    document.getElementById('manualRfidUid').value = '';
                    document.getElementById('manualRfidName').value = '';
                    this.updateList();
                    
                } catch (error) {
                    console.error('Error adding manual RFID:', error);
                    alertManager.show('rfid-add-error', '❌ Lỗi thêm thẻ RFID', 'danger', 4000);
                }
            },

            remove(uid) {
                const card = systemState.rfidList.find(c => c.uid === uid);
                if (!card) return;
                
                if (!confirm(`Xác nhận xóa thẻ "${card.name}" (${uid})?`)) return;
                
                try {
                    // Send delete data to ESP32
                    const deleteData = { deleteRfidUid: uid };
                    eraWidget.triggerAction(eraActions.dataPayload.action, JSON.stringify(deleteData));
                    eraWidget.triggerAction(eraActions.rfidRemove.action, null);
                    
                    // Update local list
                    systemState.rfidList = systemState.rfidList.filter(c => c.uid !== uid);
                    
                    alertManager.show('rfid-removed', `🗑️ Đã xóa thẻ "${card.name}" (${uid})`, 'success', 5000);
                    
                    // Add to history
                    historyController.addEntry('rfid', uid, card.name, true, 'Xóa thẻ');
                    
                    this.updateList();
                } catch (error) {
                    console.error('Error removing RFID:', error);
                    alertManager.show('rfid-remove-error', '❌ Lỗi xóa thẻ RFID', 'danger', 4000);
                }
            },

            clearAll() {
                if (!confirm('Xác nhận xóa TẤT CẢ thẻ RFID đã lưu?\n\nThao tác này không thể hoàn tác!')) return;
                
                try {
                    // Clear local list
                    systemState.rfidList = [];
                    this.updateList();
                    alertManager.show('rfid-cleared', '🗑️ Đã xóa tất cả thẻ RFID khỏi danh sách', 'warning', 5000);
                    
                    // Add to history
                    historyController.addEntry('rfid', 'ALL', 'System', true, 'Xóa tất cả');
                } catch (error) {
                    console.error('Error clearing all RFID:', error);
                    alertManager.show('rfid-clear-error', '❌ Lỗi xóa danh sách thẻ RFID', 'danger', 4000);
                }
            },

            updateList() {
                const list = document.getElementById('rfidList');
                const countEl = document.getElementById('rfidCount');
                
                if (countEl) {
                    countEl.textContent = systemState.rfidList.length;
                }
                
                if (systemState.rfidList.length === 0) {
                    list.innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
                            <i class="fas fa-id-card" style="font-size: 56px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                            <h3 style="margin-bottom: 8px; font-weight: 600;">Chưa có thẻ RFID nào</h3>
                            <p style="font-size: 14px; opacity: 0.8;">Quét hoặc thêm thẻ RFID để bắt đầu</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = systemState.rfidList.map(card => `
                    <div class="list-item">
                        <div class="list-item-info">
                            <i class="fas fa-id-card"></i>
                            <span><strong>${card.uid}</strong> - ${card.name}</span>
                        </div>
                        <button class="delete-btn" onclick="rfidController.remove('${card.uid}')" title="Xóa thẻ RFID">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `).join('');
            }
        };

        // Camera Controller
        const cameraController = {
            updateStatus(status) {
                const statusEl = document.getElementById('cameraStatus');
                
                switch(status) {
                    case 0:
                        systemState.cameraStatus = 'ready';
                        statusEl.innerHTML = '<span style="color: var(--success-color);">ESP32-CAM: Sẵn sàng</span>';
                        break;
                    case 1:
                        systemState.cameraStatus = 'capturing';
                        statusEl.innerHTML = '<span style="color: var(--warning-color);">ESP32-CAM: Đang chụp ảnh...</span>';
                        break;
                    case 2:
                        systemState.cameraStatus = 'email_sent';
                        statusEl.innerHTML = '<span style="color: var(--success-color);">ESP32-CAM: Đã gửi email</span>';
                        alertManager.show('camera-email', '📧 Đã gửi ảnh về email thành công!', 'success', 5000);
                        break;
                    case 3:
                        systemState.cameraStatus = 'error';
                        statusEl.innerHTML = '<span style="color: var(--danger-color);">ESP32-CAM: Lỗi</span>';
                        alertManager.show('camera-error', '❌ Camera gặp lỗi khi chụp ảnh', 'danger', 5000);
                        break;
                    default:
                        systemState.cameraStatus = 'unknown';
                        statusEl.innerHTML = '<span style="color: var(--text-secondary);">ESP32-CAM: Không xác định</span>';
                }
            },

            displayImage(imageData) {
                if (!imageData || imageData.length < 100) {
                    console.log('Invalid image data received');
                    return;
                }
                
                const cameraFeed = document.getElementById('cameraFeed');
                const img = document.createElement('img');
                img.className = 'camera-image';
                
                // Handle different image data formats
                if (imageData.startsWith('data:image/')) {
                    img.src = imageData;
                } else if (imageData.startsWith('/9j/') || imageData.startsWith('iVBOR')) {
                    // Base64 encoded image
                    img.src = `data:image/jpeg;base64,${imageData}`;
                } else {
                    console.log('Unknown image format');
                    return;
                }
                
                img.onload = () => {
                    cameraFeed.innerHTML = '';
                    cameraFeed.appendChild(img);
                    alertManager.show('camera-image', '📸 Nhận được ảnh từ ESP32-CAM!', 'success', 4000);
                    
                    // Auto hide image after 30 seconds
                    setTimeout(() => {
                        if (cameraFeed.contains(img)) {
                            cameraFeed.innerHTML = `
                                <div class="camera-placeholder">
                                    <i class="fas fa-camera"></i>
                                    <div style="font-weight: 600; margin-bottom: 8px;">ESP32-CAM Auto Capture</div>
                                    <div style="font-size: 14px; opacity: 0.8;">
                                        Camera sẽ tự động chụp ảnh khi phát hiện chuyển động
                                    </div>
                                    <div style="font-size: 12px; margin-top: 12px; opacity: 0.6;">
                                        Ảnh sẽ được gửi ngay lập tức về email
                                    </div>
                                </div>
                            `;
                        }
                    }, 30000);
                };
                
                img.onerror = () => {
                    console.error('Failed to load camera image');
                    alertManager.show('camera-image-error', '❌ Lỗi hiển thị ảnh từ camera', 'danger', 4000);
                };
            }
        };

        // Motion Handler
        const motionHandler = {
            update(detected) {
                const wasDetected = systemState.motionDetected;
                systemState.motionDetected = Boolean(detected);
                
                const indicator = document.getElementById('motionIndicator');
                const text = document.getElementById('motionText');
                const motionBlips = document.getElementById('motionBlips');
                
                if (detected && !wasDetected) {
                    // Motion started
                    systemState.lastMotionTime = new Date();
                    
                    indicator.className = 'motion-indicator motion-detected';
                    text.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Phát hiện chuyển động!';
                    
                    // Add motion blip on radar
                    const blip = document.createElement('div');
                    blip.className = 'motion-blip';
                    blip.style.top = `${Math.random() * 180 + 20}px`;
                    blip.style.left = `${Math.random() * 180 + 20}px`;
                    motionBlips.appendChild(blip);
                    
                    setTimeout(() => {
                        if (blip.parentElement) blip.remove();
                    }, 3000);
                    
                    alertManager.show('motion-detected', '🚨 Phát hiện chuyển động! ESP32-CAM đang chụp ảnh...', 'danger', 6000);
                    
                    // Add to history
                    historyController.addEntry('motion', 'SENSOR', 'PIR Sensor', true, 'Phát hiện chuyển động');
                    
                } else if (!detected && wasDetected) {
                    // Motion stopped
                    indicator.className = 'motion-indicator motion-clear';
                    text.innerHTML = '<i class="fas fa-shield-alt"></i> Không có chuyển động';
                    
                    alertManager.show('motion-cleared', '✅ Không còn chuyển động', 'success', 3000);
                }
            }
        };

        // History Controller
        const historyController = {
            addEntry(method, id, name, success, action) {
                const entry = {
                    timestamp: new Date(),
                    method: method,
                    id: id,
                    name: name,
                    success: success,
                    action: action
                };
                
                systemState.accessHistory.unshift(entry); // Add to beginning
                
                // Keep only last 100 entries
                if (systemState.accessHistory.length > 100) {
                    systemState.accessHistory = systemState.accessHistory.slice(0, 100);
                }
                
                this.updateTable();
            },

            updateTable() {
                const tbody = document.getElementById('historyTableBody');
                
                if (systemState.accessHistory.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 48px;">
                                <i class="fas fa-history" style="font-size: 56px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                                <h3 style="margin-bottom: 8px; font-weight: 600;">Chưa có lịch sử truy cập</h3>
                                <p style="font-size: 14px; opacity: 0.8;">Lịch sử sẽ được cập nhật khi có hoạt động</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const filteredHistory = this.getFilteredHistory();
                
                if (filteredHistory.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 48px;">
                                <i class="fas fa-filter" style="font-size: 48px; opacity: 0.3; margin-bottom: 16px; display: block;"></i>
                                <h3 style="margin-bottom: 8px; font-weight: 600;">Không có kết quả</h3>
                                <p style="font-size: 14px; opacity: 0.8;">Thử thay đổi bộ lọc để xem thêm kết quả</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = filteredHistory.slice(0, 50).map(item => `
                    <tr>
                        <td>${this.formatDateTime(item.timestamp)}</td>
                        <td>
                            <span class="method-badge method-${item.method}">
                                <i class="fas fa-${this.getMethodIcon(item.method)}"></i>
                                ${this.getMethodName(item.method)}
                            </span>
                        </td>
                        <td><code>${item.id}</code></td>
                        <td>${item.name}</td>
                        <td>
                            <span class="status-badge status-${item.success ? 'success' : 'failed'}">
                                <i class="fas fa-${item.success ? 'check' : 'times'}"></i>
                                ${item.success ? 'Thành công' : 'Từ chối'}
                            </span>
                        </td>
                        <td><span class="action-badge">${item.action}</span></td>
                    </tr>
                `).join('');
            },

            getFilteredHistory() {
                let filtered = [...systemState.accessHistory];
                
                // Filter by date
                const dateFilter = document.getElementById('filterDate').value;
                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    filtered = filtered.filter(item => {
                        const itemDate = new Date(item.timestamp);
                        return itemDate.toDateString() === filterDate.toDateString();
                    });
                }
                
                // Filter by month
                const monthFilter = document.getElementById('filterMonth').value;
                if (monthFilter) {
                    const filterMonth = parseInt(monthFilter);
                    filtered = filtered.filter(item => {
                        return new Date(item.timestamp).getMonth() + 1 === filterMonth;
                    });
                }
                
                // Filter by method
                const methodFilter = document.getElementById('filterMethod').value;
                if (methodFilter) {
                    filtered = filtered.filter(item => item.method === methodFilter);
                }
                
                return filtered;
            },

            filter() {
                this.updateTable();
                alertManager.show('filter-applied', '🔍 Đã áp dụng bộ lọc', 'info', 2000);
            },

            clearHistory() {
                if (!confirm('Xác nhận xóa toàn bộ lịch sử truy cập?\n\nThao tác này không thể hoàn tác!')) return;
                
                systemState.accessHistory = [];
                this.updateTable();
                alertManager.show('history-cleared', '🗑️ Đã xóa toàn bộ lịch sử truy cập', 'success', 4000);
            },

            formatDateTime(date) {
                return new Date(date).toLocaleString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            },

            getMethodIcon(method) {
                const icons = {
                    fingerprint: 'fingerprint',
                    rfid: 'id-card',
                    manual: 'hand-pointer',
                    motion: 'running'
                };
                return icons[method] || 'question';
            },

            getMethodName(method) {
                const names = {
                    fingerprint: 'Vân tay',
                    rfid: 'RFID',
                    manual: 'Thủ công',
                    motion: 'Chuyển động'
                };
                return names[method] || method;
            }
        };

        // E-Ra Widget Initialization
        function initializeEraWidget() {
            console.log('Initializing E-Ra Widget...');
            
            eraWidget.init({
                onConfiguration: (configuration) => {
                    console.log('E-Ra Configuration received:', configuration);
                    
                    // Store configurations (Virtual Pins for reading)
                    eraConfigs = {
                        doorStatus: configuration.realtime_configs[0],      // V0 - Door Status
                        motionStatus: configuration.realtime_configs[1],    // V2 - Motion Status  
                        fpListCount: configuration.realtime_configs[2],     // V5 - Fingerprint Count
                        rfidListCount: configuration.realtime_configs[3],   // V6 - RFID Count
                        errorCount: configuration.realtime_configs[4],      // V8 - Error Count
                        intruderAlert: configuration.realtime_configs[5],   // V9 - Intruder Alert
                        cameraStatus: configuration.realtime_configs[6]     // V11 - Camera Status
                    };
                   
                    // Store actions (Virtual Pins for writing)
                    eraActions = {
                        closeDoor: configuration.actions[0],                // V1=0 - Close Door
                        openDoor: configuration.actions[1],                 // V1=1 - Open Door
                        fingerprintTestScan: configuration.actions[2],      // V3=1 - Test Scan
                        fingerprintEnroll: configuration.actions[3],        // V3=2 - Enroll
                        fingerprintDelete: configuration.actions[4],        // V3=3 - Delete
                        rfidTestScan: configuration.actions[5],             // V4=1 - Test Scan
                        rfidAdd: configuration.actions[6],                  // V4=2 - Add Card
                        rfidRemove: configuration.actions[7],               // V4=3 - Remove Card
                        dataPayload: configuration.actions[8]               // V7 - JSON Data Transfer
                    };
                   
                    connectionManager.updateStatus(true);
                    console.log('E-Ra Widget initialized successfully');
                },

                onValues: (values) => {
                    // Process received values from ESP32
                    
                    // Door Status (V0)
                    if (eraConfigs.doorStatus && values[eraConfigs.doorStatus.id]) {
                        doorStatusHandler.update(values[eraConfigs.doorStatus.id].value);
                    }
                    
                    // Motion Status (V2)
                    if (eraConfigs.motionStatus && values[eraConfigs.motionStatus.id]) {
                        motionHandler.update(values[eraConfigs.motionStatus.id].value);
                    }
                    
                    // Fingerprint List Count (V5)
                    if (eraConfigs.fpListCount && values[eraConfigs.fpListCount.id]) {
                        const count = values[eraConfigs.fpListCount.id].value;
                        document.getElementById('fingerprintCount').textContent = count;
                    }
                    
                    // RFID List Count (V6)
                    if (eraConfigs.rfidListCount && values[eraConfigs.rfidListCount.id]) {
                        const count = values[eraConfigs.rfidListCount.id].value;
                        document.getElementById('rfidCount').textContent = count;
                    }
                    
                    // Error Count (V8)
                    if (eraConfigs.errorCount && values[eraConfigs.errorCount.id]) {
                        systemState.errorCount = values[eraConfigs.errorCount.id].value;
                        if (systemState.errorCount >= 3) {
                            alertManager.show('high-error-count', `⚠️ Nhiều lần thử sai: ${systemState.errorCount}/5`, 'warning', 5000);
                        }
                        if (systemState.errorCount >= 5) {
                            alertManager.show('max-errors', '🚨 Đã đạt giới hạn lỗi tối đa!', 'danger', 8000);
                        }
                    }
                    
                    // Intruder Alert (V9)
                    if (eraConfigs.intruderAlert && values[eraConfigs.intruderAlert.id]) {
                        systemState.intruderAlert = (values[eraConfigs.intruderAlert.id].value === 1);
                        if (systemState.intruderAlert) {
                            alertManager.show('intruder-alert', '🚨 CẢNH BÁO KẺ LẠ! Hệ thống đã bị khóa!', 'danger', 0);
                        }
                    }
                    
                    // Camera Status (V11)
                    if (eraConfigs.cameraStatus && values[eraConfigs.cameraStatus.id]) {
                        cameraController.updateStatus(values[eraConfigs.cameraStatus.id].value);
                    }
                    
                    console.log('Processed values from ESP32:', Object.keys(values).length, 'updates');
                },

                onError: (error) => {
                    console.error('E-Ra Widget error:', error);
                    connectionManager.updateStatus(false);
                    alertManager.show('era-error', '❌ Lỗi kết nối E-Ra. Đang thử kết nối lại...', 'danger', 6000);
                }
            });
        }

        // Utility Functions
        function switchTab(tab, button) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            
            alertManager.show('tab-switched', `📋 Chuyển sang tab ${tab === 'fingerprint' ? 'Vân tay' : 'RFID'}`, 'info', 2000);
        }

        // System Monitoring
        function monitorSystemHealth() {
            // Check connection status
            if (!systemState.isConnected) {
                console.warn('System disconnected from E-Ra');
            }
            
            // Monitor memory usage (if available)
            if (performance && performance.memory) {
                const memUsed = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                const memLimit = Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024);
                
                if (memUsed > memLimit * 0.8) {
                    console.warn('High memory usage detected:', memUsed, 'MB');
                }
            }
            
            // Check for stale data
            const now = new Date();
            if (systemState.lastMotionTime && (now - systemState.lastMotionTime) > 300000) { // 5 minutes
                // Motion detection might be stale
                console.log('Motion detection data might be stale');
            }
        }

        // Application Initialization
        function initializeApplication() {
            console.log('=== Smart Gate Dashboard v5.0 Initializing ===');
            
            // Initialize E-Ra Widget
            initializeEraWidget();
            
            // Initialize UI components
            fingerprintController.updateList();
            rfidController.updateList();
            historyController.updateTable();
            
            // Set default date filter to today
            const today = new Date();
            document.getElementById('filterDate').value = today.toISOString().split('T')[0];
            
            // Initialize connection status
            connectionManager.updateStatus(false);
            
            // Add some demo history entries for testing
            setTimeout(() => {
                historyController.addEntry('fingerprint', '1', 'Admin User', true, 'Truy cập');
                historyController.addEntry('rfid', 'ABC123', 'Guest Card', true, 'Truy cập');
                historyController.addEntry('motion', 'SENSOR', 'PIR Sensor', true, 'Phát hiện chuyển động');
            }, 2000);
            
            // Setup system monitoring
            setInterval(monitorSystemHealth, 30000); // Every 30 seconds
            
            // Show startup message
            setTimeout(() => {
                if (!systemState.isConnected) {
                    alertManager.show('startup-connecting', '🔗 Đang kết nối với ESP32 Gate Controller...', 'info', 6000);
                } else {
                    alertManager.show('startup-ready', '✅ Dashboard v5.0 sẵn sàng hoạt động!', 'success', 4000);
                }
            }, 1500);
            
            console.log('=== Dashboard Initialization Complete ===');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            initializeApplication();
        });

        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('Dashboard hidden - reducing activity');
            } else {
                console.log('Dashboard visible - resuming normal activity');
                // Refresh connection status when page becomes visible
                if (systemState.isConnected) {
                    alertManager.show('page-resumed', '👁️ Dashboard đã hoạt động trở lại', 'info', 2000);
                }
            }
        });

        // Handle online/offline events
        window.addEventListener('online', function() {
            alertManager.show('network-online', '🌐 Kết nối mạng đã được khôi phục', 'success', 3000);
        });

        window.addEventListener('offline', function() {
            alertManager.show('network-offline', '📶 Mất kết nối mạng', 'danger', 5000);
        });

        // Global access for debugging and external access
        window.smartGateSystem = {
            systemState,
            alertManager,
            doorController,
            fingerprintController,
            rfidController,
            cameraController,
            motionHandler,
            historyController,
            connectionManager
        };

        // Console welcome message
        console.log(`
╔══════════════════════════════════════╗
║     Smart Gate Dashboard v5.0        ║
║     Production Ready Version         ║
║                                      ║
║  ESP32 + AS608 + RFID + ESP32-CAM    ║
║  Real-time monitoring & control      ║
╚══════════════════════════════════════╝
        `);
    </script>
</body>
</html>
