<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Door Security Dashboard v4.1 - All Issues Fixed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        :root {
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --background: #0a0e27;
            --surface: #151c3d;
            --surface-light: #1e2951;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --border: #2a3660;
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Alert Container - Top Right */
        #alertContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            width: 400px;
            max-width: calc(100vw - 40px);
            pointer-events: none;
        }

        #alertContainer .alert {
            pointer-events: all;
            margin-bottom: 10px;
            transform: translateX(100%);
            animation: slideInRight 0.3s ease forwards;
            padding: 16px 20px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--surface);
            border: 1px solid;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        @keyframes slideInRight {
            to { transform: translateX(0); }
        }

        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: currentColor;
        }

        .alert-success { border-color: var(--success-color); color: var(--success-color); }
        .alert-warning { border-color: var(--warning-color); color: var(--warning-color); }
        .alert-danger { border-color: var(--danger-color); color: var(--danger-color); }
        .alert-info { border-color: var(--primary-color); color: var(--primary-color); }

        .alert-close {
            margin-left: auto;
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 20px;
            opacity: 0.7;
            padding: 4px;
            border-radius: 4px;
        }

        .alert-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            background: var(--surface);
            border: 1px solid var(--border);
            z-index: 1000;
        }

        .connection-status.connected {
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .connection-status.disconnected {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .dashboard-container {
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .dashboard-header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 12px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .dashboard-header p {
            font-size: 1.25rem;
            color: var(--text-secondary);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 28px;
            margin-bottom: 32px;
        }

        .card {
            background: var(--surface);
            border-radius: 24px;
            padding: 28px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            border-color: var(--primary-color);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .card-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-right: 16px;
        }

        .card-icon i {
            color: white;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Door Control */
        .door-control .card-icon {
            background: var(--gradient-success);
        }

        .door-visualization {
            width: 280px;
            height: 180px;
            margin: 24px auto;
            position: relative;
            perspective: 1200px;
        }

        .door-frame {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 12px;
            position: relative;
            border: 4px solid #2a3660;
            overflow: hidden;
        }

        .door-panel {
            width: 85%;
            height: 90%;
            background: var(--gradient-primary);
            position: absolute;
            top: 5%;
            left: 7.5%;
            border-radius: 8px;
            transition: transform 1.5s ease;
            transform-origin: left center;
        }

        .door-panel.open {
            transform: perspective(1200px) rotateY(-85deg) translateZ(30px);
        }

        .door-handle {
            width: 14px;
            height: 40px;
            background: var(--gradient-warning);
            border-radius: 14px;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .door-status {
            margin: 20px 0;
            font-size: 1.35rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .status-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        .status-closed .status-indicator { background: var(--danger-color); }
        .status-open .status-indicator { background: var(--success-color); }

        .control-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: var(--gradient-warning);
            color: white;
            box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        /* Access Management */
        .access-management .card-icon {
            background: var(--gradient-primary);
        }

        .access-tabs {
            display: flex;
            margin-bottom: 24px;
            background: var(--background);
            border-radius: 14px;
            padding: 4px;
        }

        .tab-button {
            flex: 1;
            padding: 14px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-button.active {
            background: var(--gradient-primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: var(--background);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
        }

        .section-header strong {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .input-field {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--surface);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--surface-light);
        }

        .scan-section, .detect-section {
            border: 2px dashed var(--border);
            background: rgba(30, 41, 81, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .scan-section.scanning, .detect-section.detecting {
            border-color: var(--primary-color);
            animation: scanPulse 1.5s infinite;
        }

        @keyframes scanPulse {
            0%, 100% { 
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            50% { 
                border-color: #60a5fa;
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
        }

        .scan-status, .rfid-status {
            margin: 12px 0;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            background: var(--surface-light);
            font-weight: 500;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fingerprint-list, .rfid-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--surface);
            margin-top: 20px;
        }

        .list-item {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .list-item:hover {
            background: var(--surface-light);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .list-item-info i {
            color: var(--primary-color);
            font-size: 18px;
        }

        .delete-btn {
            padding: 6px 14px;
            background: var(--gradient-danger);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .delete-btn:hover {
            transform: scale(1.05);
        }

        /* Camera Section */
        .camera-section .card-icon {
            background: var(--gradient-danger);
        }

        .security-radar {
            width: 100%;
            height: 240px;
            position: relative;
            background: radial-gradient(circle at center, rgba(30, 41, 81, 0.9) 0%, rgba(10, 14, 39, 1) 100%);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .radar-container {
            width: 200px;
            height: 200px;
            position: relative;
        }

        .radar-circle {
            position: absolute;
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .radar-circle:nth-child(1) { width: 200px; height: 200px; }
        .radar-circle:nth-child(2) { width: 150px; height: 150px; }
        .radar-circle:nth-child(3) { width: 100px; height: 100px; }
        .radar-circle:nth-child(4) { width: 50px; height: 50px; }

        .radar-sweep {
            position: absolute;
            width: 100%;
            height: 100%;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                rgba(59, 130, 246, 0.8) 10deg,
                rgba(59, 130, 246, 0.4) 30deg,
                transparent 60deg
            );
            animation: radarSweep 4s linear infinite;
            border-radius: 50%;
        }

        @keyframes radarSweep {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .radar-center {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 30px var(--primary-color);
        }

        .motion-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            border-radius: 24px;
            font-weight: 600;
            margin: 16px auto;
            width: fit-content;
        }

        .motion-indicator-container {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .motion-detected {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
            border: 2px solid var(--danger-color);
            animation: alertPulse 1s ease-out infinite;
        }

        @keyframes alertPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .motion-clear {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }

        .camera-feed {
            width: 100%;
            height: 240px;
            background: var(--surface);
            border-radius: 16px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border);
            overflow: hidden;
        }

        .camera-placeholder {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
        }

        .camera-placeholder i {
            font-size: 56px;
            margin-bottom: 16px;
            color: var(--primary-color);
            opacity: 0.6;
        }

        .camera-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 14px;
        }

        /* History Section */
        .history-section {
            grid-column: 1 / -1;
        }

        .history-section .card-icon {
            background: var(--gradient-warning);
        }

        .history-filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .filter-select, .filter-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--background);
            color: var(--text-primary);
            font-size: 14px;
        }

        .history-table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--background);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            background: var(--surface-light);
            padding: 16px;
            text-align: left;
            font-weight: 700;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
        }

        .history-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .history-table tr:hover td {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .method-badge, .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .method-fingerprint {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .method-rfid {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
        }

        .status-failed {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
        }

        .action-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning-color);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 16px;
            }

            .dashboard-header h1 {
                font-size: 2rem;
                flex-direction: column;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .control-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            #alertContainer {
                width: calc(100vw - 40px);
            }
        }
    </style>
</head>
<body>
    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <!-- Connection Status -->
    <div class="connection-status disconnected" id="connectionStatus">
        <i class="fas fa-circle"></i>
        <span>Đang kết nối...</span>
    </div>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1><i class="fas fa-door-open"></i> Smart Door Security v4.1</h1>
            <p>Hệ thống cửa thông minh với AI & IoT - All Issues Fixed</p>
        </div>

        <div class="dashboard-grid">
            <!-- Door Control -->
            <div class="card door-control">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-door-open"></i></div>
                    <div class="card-title">Điều Khiển Cửa</div>
                </div>
                
                <div class="door-visualization">
                    <div class="door-frame">
                        <div class="door-panel" id="doorPanel">
                            <div class="door-handle"></div>
                        </div>
                    </div>
                </div>
                
                <div class="door-status status-closed" id="doorStatus">
                    <span class="status-indicator"></span>
                    <span id="doorStatusText">Đóng</span>
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-success" onclick="doorController.openDoor()">
                        <i class="fas fa-unlock"></i>
                        <span>Mở Cửa</span>
                    </button>
                    <button class="btn btn-danger" onclick="doorController.closeDoor()">
                        <i class="fas fa-lock"></i>
                        <span>Đóng Cửa</span>
                    </button>
                </div>
            </div>

            <!-- Access Management -->
            <div class="card access-management">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-user-shield"></i></div>
                    <div class="card-title">Quản Lý Truy Cập</div>
                </div>

                <div class="access-tabs">
                    <button class="tab-button active" onclick="switchTab('fingerprint', this)">
                        <i class="fas fa-fingerprint"></i>
                        <span>Vân Tay</span>
                    </button>
                    <button class="tab-button" onclick="switchTab('rfid', this)">
                        <i class="fas fa-id-card"></i>
                        <span>Thẻ RFID</span>
                    </button>
                </div>

                <!-- Fingerprint Tab -->
                <div class="tab-content active" id="fingerprintTab">
                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-fingerprint"></i>
                            <strong>Test quét vân tay</strong>
                        </div>
                        
                        <div class="scan-section" id="fingerprintScanSection">
                            <div class="scan-status" id="fingerprintScanStatus">
                                Nhấn nút bên dưới để test quét vân tay
                            </div>
                            
                            <button class="btn btn-primary" id="startScanBtn" onclick="fingerprintController.startScan()" style="width: 100%; margin-top: 12px;">
                                <i class="fas fa-fingerprint"></i>
                                <span>Bắt Đầu Test</span>
                            </button>
                            <button class="btn btn-danger" id="stopScanBtn" onclick="fingerprintController.stopScan()" style="display: none; width: 100%; margin-top: 12px;">
                                <i class="fas fa-stop"></i>
                                <span>Dừng Test</span>
                            </button>
                        </div>

                        <!-- Fingerprint Add Section -->
                        <div class="enrollment-section" style="display: none; margin-top: 20px;" id="fingerprintEnrollSection">
                            <div style="display: flex; align-items: center; margin-bottom: 16px;">
                                <i class="fas fa-check-circle" style="font-size: 24px; margin-right: 12px; color: var(--success-color);"></i>
                                <strong style="font-size: 1.1rem; color: var(--success-color);">Vân tay đã xác minh!</strong>
                            </div>
                            
                            <div class="input-group">
                                <label>ID Vân Tay:</label>
                                <input type="text" class="input-field" id="verifiedFingerprintId" readonly>
                            </div>
                            
                            <div class="input-group">
                                <label>Tên người dùng:</label>
                                <input type="text" class="input-field" id="fingerprintName" placeholder="Nhập tên cho vân tay này">
                            </div>
                            
                            <button class="btn btn-success" onclick="fingerprintController.enrollVerified()" style="width: 100%;">
                                <i class="fas fa-check"></i>
                                <span>Thêm Vân Tay</span>
                            </button>
                        </div>
                    </div>

                    <!-- Manual Fingerprint Add -->
                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-plus-circle"></i>
                            <strong>Thêm vân tay thủ công</strong>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">
                            <input type="number" class="input-field" id="manualFingerprintId" placeholder="Nhập ID" min="1" max="127">
                            <input type="text" class="input-field" id="manualFingerprintName" placeholder="Tên người dùng">
                        </div>
                        
                        <button class="btn btn-primary" style="margin-top: 12px; width: 100%;" onclick="fingerprintController.enrollManual()">
                            <i class="fas fa-plus"></i>
                            <span>Đăng Ký Vân Tay</span>
                        </button>
                    </div>
                    
                    <!-- Fingerprint List -->
                    <div style="margin-top: 20px;">
                        <div style="margin-bottom: 12px; font-weight: 600; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-list"></i> Danh sách vân tay đã lưu:</span>
                            <button class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;" onclick="fingerprintController.clearAll()">
                                <i class="fas fa-trash"></i> Xóa tất cả
                            </button>
                        </div>
                        
                        <div class="fingerprint-list" id="fingerprintList">
                            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                <div class="loading"></div>
                                <p style="margin-top: 12px;">Đang tải danh sách vân tay...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RFID Tab -->
                <div class="tab-content" id="rfidTab">
                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-wifi"></i>
                            <strong>Quét thẻ RFID</strong>
                        </div>
                        
                        <div class="detect-section" id="rfidDetectSection">
                            <div class="rfid-status" id="rfidDetectionStatus">
                                Nhấn nút để test quét thẻ RFID
                            </div>
                            
                            <button class="btn btn-primary" onclick="rfidController.testScan()" style="width: 100%; margin-top: 12px;">
                                <i class="fas fa-id-card"></i>
                                <span>Test Quét Thẻ</span>
                            </button>
                        </div>

                        <!-- RFID Add Section -->
                        <div class="rfid-management" id="rfidManagementSection" style="display: none; margin-top: 20px;">
                            <div style="display: flex; align-items: center; margin-bottom: 16px;">
                                <i class="fas fa-check-circle" style="font-size: 24px; margin-right: 12px; color: var(--success-color);"></i>
                                <strong style="font-size: 1.1rem; color: var(--success-color);">Thẻ đã quét!</strong>
                            </div>
                            
                            <div class="input-group">
                                <label>UID Thẻ RFID:</label>
                                <input type="text" class="input-field" id="rfidUid" readonly>
                            </div>
                            
                            <div class="input-group">
                                <label>Tên chủ thẻ:</label>
                                <input type="text" class="input-field" id="rfidCardName" placeholder="Nhập tên cho thẻ này">
                            </div>
                            
                            <button class="btn btn-success" onclick="rfidController.addScanned()" style="width: 100%;">
                                <i class="fas fa-check"></i>
                                <span>Thêm Thẻ</span>
                            </button>
                        </div>
                    </div>

                    <!-- Manual RFID Add -->
                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-plus-circle"></i>
                            <strong>Thêm thẻ RFID thủ công</strong>
                        </div>
                        
                        <input type="text" class="input-field" id="manualRfidUid" placeholder="Nhập UID thẻ (VD: 04:XX:XX:XX)" style="margin-bottom: 12px;">
                        <input type="text" class="input-field" id="manualRfidName" placeholder="Tên chủ thẻ">
                        
                        <button class="btn btn-primary" style="margin-top: 12px; width: 100%;" onclick="rfidController.addManual()">
                            <i class="fas fa-plus"></i>
                            <span>Thêm Thẻ</span>
                        </button>
                    </div>
                    
                    <!-- RFID List -->
                    <div style="margin-top: 20px;">
                        <div style="margin-bottom: 12px; font-weight: 600; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-list"></i> Danh sách thẻ RFID đã lưu:</span>
                            <button class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;" onclick="rfidController.clearAll()">
                                <i class="fas fa-trash"></i> Xóa tất cả
                            </button>
                        </div>
                        
                        <div class="rfid-list" id="rfidList">
                            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                <div class="loading"></div>
                                <p style="margin-top: 12px;">Đang tải danh sách thẻ RFID...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Camera Section -->
            <div class="card camera-section">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-video"></i></div>
                    <div class="card-title">Camera An Ninh</div>
                </div>

                <div class="security-radar">
                    <div class="radar-container">
                        <div class="radar-circle"></div>
                        <div class="radar-circle"></div>
                        <div class="radar-circle"></div>
                        <div class="radar-circle"></div>
                        <div class="radar-sweep"></div>
                        <div class="radar-center"></div>
                        <div id="motionBlips"></div>
                    </div>
                </div>

                <div class="motion-indicator-container">
                    <div class="motion-indicator motion-clear" id="motionIndicator">
                        <i class="fas fa-shield-alt"></i>
                        <span id="motionText">Không có chuyển động</span>
                    </div>
                </div>

                <div class="camera-feed" id="cameraFeed">
                    <div class="camera-placeholder">
                        <i class="fas fa-camera"></i>
                        <div>Camera sẽ tự động chụp khi có chuyển động</div>
                        <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">
                            Ảnh sẽ được gửi về email ngay lập tức
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 16px; background: var(--background); border-radius: 12px;">
                    <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                        <div><i class="fas fa-envelope"></i> Email: phamquocthien17@gmail.com</div>
                        <div><i class="fas fa-robot"></i> Tự động gửi ảnh khi phát hiện chuyển động</div>
                        <div><i class="fas fa-wifi"></i> Stream: <span id="streamUrl">Đang kết nối...</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="card history-section">
            <div class="card-header">
                <div class="card-icon"><i class="fas fa-history"></i></div>
                <div class="card-title">Lịch Sử Truy Cập</div>
            </div>

            <div class="history-filters">
                <div class="filter-group">
                    <label>Ngày:</label>
                    <input type="date" class="filter-input" id="filterDate" onchange="historyController.filter()">
                </div>
                <div class="filter-group">
                    <label>Tháng:</label>
                    <select class="filter-select" id="filterMonth" onchange="historyController.filter()">
                        <option value="">Tất cả</option>
                        <option value="1">Tháng 1</option>
                        <option value="2">Tháng 2</option>
                        <option value="3">Tháng 3</option>
                        <option value="4">Tháng 4</option>
                        <option value="5">Tháng 5</option>
                        <option value="6">Tháng 6</option>
                        <option value="7">Tháng 7</option>
                        <option value="8">Tháng 8</option>
                        <option value="9">Tháng 9</option>
                        <option value="10">Tháng 10</option>
                        <option value="11">Tháng 11</option>
                        <option value="12">Tháng 12</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Phương thức:</label>
                    <select class="filter-select" id="filterMethod" onchange="historyController.filter()">
                        <option value="">Tất cả</option>
                        <option value="fingerprint">Vân tay</option>
                        <option value="rfid">Thẻ RFID</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-warning" onclick="historyController.clearHistory()">
                        <i class="fas fa-trash"></i>
                        <span>Xóa lịch sử</span>
                    </button>
                </div>
            </div>

            <div class="history-table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Thời gian</th>
                            <th>Phương thức</th>
                            <th>ID/UID</th>
                            <th>Tên</th>
                            <th>Kết quả</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <div class="loading"></div>
                                <p style="margin-top: 12px;">Đang tải lịch sử...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- E-Ra Widget -->
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
    <script>
        // E-Ra Widget Instance
        const eraWidget = new EraWidget();
        
        // System State
        let systemState = {
            doorStatus: 'closed',
            motionDetected: false,
            fingerprintScanActive: false,
            currentVerifiedFingerprintId: null,
            currentScannedRfidUid: null,
            fingerprintList: [],
            rfidList: [],
            accessHistory: [],
            isConnected: false,
            errorCount: 0,
            intruderAlert: false
        };

        let configs = {};
        let actions = {};

        // Alert Manager
        const alertManager = {
            alerts: new Map(),
            
            show(id, message, type = 'success', timeout = 5000) {
                this.remove(id);
                
                const container = document.getElementById('alertContainer');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.id = `alert-${id}`;
                alert.innerHTML = `
                    <i class="fas fa-${this.getIcon(type)}"></i>
                    <span>${message}</span>
                    <button class="alert-close" onclick="alertManager.remove('${id}')">×</button>
                `;
                
                container.appendChild(alert);
                this.alerts.set(id, alert);
                
                if (timeout > 0) {
                    setTimeout(() => this.remove(id), timeout);
                }
            },
            
            getIcon(type) {
                const icons = {
                    success: 'check-circle',
                    warning: 'exclamation-triangle',
                    danger: 'exclamation-circle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            },
            
            remove(id) {
                const alert = this.alerts.get(id);
                if (alert && alert.parentElement) {
                    alert.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (alert.parentElement) alert.remove();
                        this.alerts.delete(id);
                    }, 300);
                }
            },
            
            clear() {
                this.alerts.forEach((alert, id) => this.remove(id));
                setTimeout(() => this.show('cleared', '🗑️ Đã xóa tất cả cảnh báo', 'success', 3000), 500);
            }
        };

        // Connection Manager
        const connectionManager = {
            updateStatus(connected) {
                systemState.isConnected = connected;
                const statusEl = document.getElementById('connectionStatus');
                
                if (connected) {
                    statusEl.className = 'connection-status connected';
                    statusEl.innerHTML = '<i class="fas fa-circle"></i><span>Kết nối E-Ra</span>';
                    alertManager.show('era-connected', '✅ Kết nối E-Ra thành công', 'success', 3000);
                } else {
                    statusEl.className = 'connection-status disconnected';
                    statusEl.innerHTML = '<i class="fas fa-circle"></i><span>Mất kết nối</span>';
                    alertManager.show('era-disconnected', '❌ Mất kết nối E-Ra', 'danger', 5000);
                }
            },
            
            testConnection() {
                if (!systemState.isConnected) {
                    alertManager.show('connection-test', '❌ Chưa kết nối E-Ra!', 'danger', 3000);
                    return false;
                }
                alertManager.show('connection-test', '✅ E-Ra đã kết nối!', 'success', 3000);
                return true;
            }
        };

        // Door Controller
        const doorController = {
            openDoor() {
                if (!connectionManager.testConnection()) return;
                
                eraWidget.triggerAction(actions.openDoor.action, null);
                alertManager.show('door-opening', '🚪 Đang mở cửa...', 'success', 3000);
            },

            closeDoor() {
                if (!connectionManager.testConnection()) return;
                
                eraWidget.triggerAction(actions.closeDoor.action, null);
                alertManager.show('door-closing', '🚪 Đang đóng cửa...', 'warning', 3000);
            }
        };

        // Door Status Handler
        const doorStatusHandler = {
            update(status) {
                systemState.doorStatus = (status === 1) ? 'open' : 'closed';
                
                const doorPanel = document.getElementById('doorPanel');
                const doorStatusEl = document.getElementById('doorStatus');
                const doorStatusText = document.getElementById('doorStatusText');
                
                doorPanel.classList.remove('open');
                doorStatusEl.className = 'door-status';
                
                if (systemState.doorStatus === 'open') {
                    doorPanel.classList.add('open');
                    doorStatusEl.className = 'door-status status-open';
                    doorStatusText.textContent = 'Mở';
                } else {
                    doorStatusEl.className = 'door-status status-closed';
                    doorStatusText.textContent = 'Đóng';
                }
            }
        };

        // Fingerprint Controller
        const fingerprintController = {
            startScan() {
                if (!connectionManager.testConnection()) return;
                
                eraWidget.triggerAction(actions.fingerprintTestScan.action, null);
                
                systemState.fingerprintScanActive = true;
                document.getElementById('startScanBtn').style.display = 'none';
                document.getElementById('stopScanBtn').style.display = 'inline-flex';
                document.getElementById('fingerprintScanSection').classList.add('scanning');
                
                const statusEl = document.getElementById('fingerprintScanStatus');
                statusEl.textContent = '👆 Đặt ngón tay lên cảm biến AS608...';
                statusEl.style.background = 'var(--primary-color)';
                statusEl.style.color = 'white';
                
                alertManager.show('fp-scan-start', '👆 Bắt đầu quét vân tay!', 'success', 3000);
            },

            stopScan() {
                if (!connectionManager.testConnection()) return;
                
                // Send stop command via V3=0 or similar
                eraWidget.triggerAction(actions.fingerprintTestScan.action, null);
                
                this.resetScanUI();
                alertManager.show('fp-scan-stop', '⏹️ Đã dừng quét vân tay', 'warning', 2000);
            },

            resetScanUI() {
                systemState.fingerprintScanActive = false;
                document.getElementById('startScanBtn').style.display = 'inline-flex';
                document.getElementById('stopScanBtn').style.display = 'none';
                document.getElementById('fingerprintScanSection').classList.remove('scanning');
                document.getElementById('fingerprintEnrollSection').style.display = 'none';
                
                const statusEl = document.getElementById('fingerprintScanStatus');
                statusEl.textContent = 'Nhấn nút bên dưới để test quét vân tay';
                statusEl.style.background = 'var(--surface-light)';
                statusEl.style.color = 'var(--text-primary)';
            },

            enrollVerified() {
                const name = document.getElementById('fingerprintName').value.trim();
                
                if (!name) {
                    alertManager.show('fp-name-required', '⚠️ Vui lòng nhập tên', 'warning', 3000);
                    return;
                }

                if (!systemState.currentVerifiedFingerprintId) {
                    alertManager.show('fp-no-verified', '⚠️ Không có vân tay xác minh', 'warning', 3000);
                    return;
                }

                const enrollData = {
                    id: systemState.currentVerifiedFingerprintId,
                    name: name
                };

                // Send data via V7
                eraWidget.triggerAction(actions.dataPayload.action, JSON.stringify(enrollData));
                // Send enroll command via V3=2
                eraWidget.triggerAction(actions.fingerprintEnroll.action, null);
                
                systemState.fingerprintList = systemState.fingerprintList.filter(fp => fp.id !== enrollData.id);
                systemState.fingerprintList.push(enrollData);
                systemState.fingerprintList.sort((a, b) => a.id - b.id);
                
                alertManager.show('fp-enrolled', `✅ Đã thêm vân tay "${name}"`, 'success', 5000);
                
                document.getElementById('fingerprintName').value = '';
                systemState.currentVerifiedFingerprintId = null;
                this.stopScan();
                this.updateList();
            },

            enrollManual() {
                const id = parseInt(document.getElementById('manualFingerprintId').value);
                const name = document.getElementById('manualFingerprintName').value.trim();
                
                if (!id || id < 1 || id > 127) {
                    alertManager.show('fp-invalid-id', '⚠️ ID phải từ 1-127', 'warning', 3000);
                    return;
                }
                
                if (!name) {
                    alertManager.show('fp-name-required', '⚠️ Vui lòng nhập tên', 'warning', 3000);
                    return;
                }
                
                if (systemState.fingerprintList.some(fp => fp.id === id)) {
                    alertManager.show('fp-id-exists', `⚠️ ID ${id} đã tồn tại!`, 'warning', 3000);
                    return;
                }

                const enrollData = { id, name };

                // Send data via V7
                eraWidget.triggerAction(actions.dataPayload.action, JSON.stringify(enrollData));
                // Send enroll command via V3=2
                eraWidget.triggerAction(actions.fingerprintEnroll.action, null);

                systemState.fingerprintList.push(enrollData);
                systemState.fingerprintList.sort((a, b) => a.id - b.id);
                
                alertManager.show('fp-manual-enrolled', `✅ Đã thêm vân tay "${name}"`, 'success', 3000);
                
                document.getElementById('manualFingerprintId').value = '';
                document.getElementById('manualFingerprintName').value = '';
                this.updateList();
            },

            delete(id) {
                const fingerprint = systemState.fingerprintList.find(fp => fp.id === id);
                if (!fingerprint) return;
                
                if (!confirm(`Xác nhận xóa vân tay "${fingerprint.name}"?`)) return;
                
                // Send delete data via V7
                eraWidget.triggerAction(actions.dataPayload.action, JSON.stringify({ id: id }));
                // Send delete command via V3=3
                eraWidget.triggerAction(actions.fingerprintDelete.action, null);
                
                systemState.fingerprintList = systemState.fingerprintList.filter(fp => fp.id !== id);
                
                alertManager.show('fp-deleted', `🗑️ Đã xóa vân tay "${fingerprint.name}"`, 'success', 3000);
                this.updateList();
            },

            clearAll() {
                if (!confirm('Xác nhận xóa TẤT CẢ vân tay?')) return;
                
                systemState.fingerprintList = [];
                this.updateList();
                alertManager.show('fp-cleared', '🗑️ Đã xóa tất cả vân tay', 'warning', 3000);
            },

            updateList() {
                const list = document.getElementById('fingerprintList');
                
                if (systemState.fingerprintList.length === 0) {
                    list.innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            <i class="fas fa-fingerprint" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                            <p>Chưa có vân tay nào được lưu</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = systemState.fingerprintList.map(fp => `
                    <div class="list-item">
                        <div class="list-item-info">
                            <i class="fas fa-fingerprint"></i>
                            <span>ID #${fp.id} - ${fp.name}</span>
                        </div>
                        <button class="delete-btn" onclick="fingerprintController.delete(${fp.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }
        };

        // RFID Controller
        const rfidController = {
            testScan() {
                if (!connectionManager.testConnection()) return;

                eraWidget.triggerAction(actions.rfidTestScan.action, null);
                document.getElementById('rfidDetectSection').classList.add('detecting');
                
                const statusEl = document.getElementById('rfidDetectionStatus');
                statusEl.textContent = '💳 Đang quét thẻ RFID...';
                statusEl.style.background = 'var(--primary-color)';
                statusEl.style.color = 'white';
                
                alertManager.show('rfid-scan-start', '💳 Bắt đầu quét thẻ RFID!', 'success', 3000);
                
                setTimeout(() => {
                    document.getElementById('rfidDetectSection').classList.remove('detecting');
                    if (statusEl.textContent.includes('Đang quét')) {
                        statusEl.textContent = 'Nhấn nút để test quét thẻ RFID';
                        statusEl.style.background = 'var(--surface-light)';
                        statusEl.style.color = 'var(--text-primary)';
                    }
                }, 10000);
            },

            addScanned() {
                const name = document.getElementById('rfidCardName').value.trim();
                
                if (!systemState.currentScannedRfidUid) {
                    alertManager.show('rfid-no-scanned', '⚠️ Không có thẻ được quét', 'warning', 3000);
                    return;
                }
                
                if (!name) {
                    alertManager.show('rfid-name-required', '⚠️ Vui lòng nhập tên', 'warning', 3000);
                    return;
                }

                const newCard = {
                    uid: systemState.currentScannedRfidUid,
                    name: name
                };

                // Send data via V7
                eraWidget.triggerAction(actions.dataPayload.action, JSON.stringify(newCard));
                // Send add command via V4=2
                eraWidget.triggerAction(actions.rfidAdd.action, null);
                
                systemState.rfidList = systemState.rfidList.filter(card => card.uid !== newCard.uid);
                systemState.rfidList.push(newCard);
                
                alertManager.show('rfid-added', `✅ Đã thêm thẻ "${name}"`, 'success', 5000);
                
                document.getElementById('rfidCardName').value = '';
                document.getElementById('rfidManagementSection').style.display = 'none';
                systemState.currentScannedRfidUid = null;
                
                const statusEl = document.getElementById('rfidDetectionStatus');
                statusEl.textContent = 'Nhấn nút để test quét thẻ RFID';
                statusEl.style.background = 'var(--surface-light)';
                statusEl.style.color = 'var(--text-primary)';
                
                this.updateList();
            },

            addManual() {
                const uid = document.getElementById('manualRfidUid').value.trim().toUpperCase();
                const name = document.getElementById('manualRfidName').value.trim();
                
                if (!uid) {
                    alertManager.show('rfid-uid-required', '⚠️ Vui lòng nhập UID', 'warning', 3000);
                    return;
                }
                
                if (!name) {
                    alertManager.show('rfid-name-required', '⚠️ Vui lòng nhập tên', 'warning', 3000);
                    return;
                }
                
                if (systemState.rfidList.some(card => card.uid === uid)) {
                    alertManager.show('rfid-uid-exists', '⚠️ UID đã tồn tại!', 'warning', 3000);
                    return;
                }

                const newCard = { uid, name };

                // Send data via V7
                eraWidget.triggerAction(actions.dataPayload.action, JSON.stringify(newCard));
                // Send add command via V4=2
                eraWidget.triggerAction(actions.rfidAdd.action, null);

                systemState.rfidList.push(newCard);
                
                alertManager.show('rfid-manual-added', `✅ Đã thêm thẻ "${name}"`, 'success', 3000);
                
                document.getElementById('manualRfidUid').value = '';
                document.getElementById('manualRfidName').value = '';
                this.updateList();
            },

            remove(uid) {
                const card = systemState.rfidList.find(c => c.uid === uid);
                if (!card) return;
                
                if (!confirm(`Xác nhận xóa thẻ "${card.name}"?`)) return;
                
                // Send delete data via V7
                eraWidget.triggerAction(actions.dataPayload.action, JSON.stringify({ uid: uid }));
                // Send remove command via V4=3
                eraWidget.triggerAction(actions.rfidRemove.action, null);
                
                systemState.rfidList = systemState.rfidList.filter(c => c.uid !== uid);
                
                alertManager.show('rfid-removed', `🗑️ Đã xóa thẻ "${card.name}"`, 'success', 3000);
                this.updateList();
            },

            clearAll() {
                if (!confirm('Xác nhận xóa TẤT CẢ thẻ RFID?')) return;
                
                systemState.rfidList = [];
                this.updateList();
                alertManager.show('rfid-cleared', '🗑️ Đã xóa tất cả thẻ RFID', 'warning', 3000);
            },

            updateList() {
                const list = document.getElementById('rfidList');
                
                if (systemState.rfidList.length === 0) {
                    list.innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            <i class="fas fa-id-card" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                            <p>Chưa có thẻ RFID nào được lưu</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = systemState.rfidList.map(card => `
                    <div class="list-item">
                        <div class="list-item-info">
                            <i class="fas fa-id-card"></i>
                            <span>${card.uid} - ${card.name}</span>
                        </div>
                        <button class="delete-btn" onclick="rfidController.remove('${card.uid}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }
        };

        // Camera Controller
        const cameraController = {
            displayImage(imageData) {
                if (!imageData || imageData.length < 100) return;
                
                const cameraFeed = document.getElementById('cameraFeed');
                const img = document.createElement('img');
                img.className = 'camera-image';
                img.src = imageData.startsWith('data:') ? imageData : `data:image/jpeg;base64,${imageData}`;
                
                img.onload = () => {
                    cameraFeed.innerHTML = '';
                    cameraFeed.appendChild(img);
                    alertManager.show('camera-image', '📸 Đã nhận ảnh từ ESP32-CAM', 'success', 3000);
                    
                    setTimeout(() => {
                        cameraFeed.innerHTML = `
                            <div class="camera-placeholder">
                                <i class="fas fa-camera"></i>
                                <div>Camera sẽ tự động chụp khi có chuyển động</div>
                            </div>
                        `;
                    }, 30000);
                };
            }
        };

        // Motion Handler
        const motionHandler = {
            update(detected) {
                systemState.motionDetected = Boolean(detected);
                
                const indicator = document.getElementById('motionIndicator');
                const text = document.getElementById('motionText');
                const motionBlips = document.getElementById('motionBlips');
                
                if (detected) {
                    indicator.className = 'motion-indicator motion-detected';
                    text.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Phát hiện chuyển động!';
                    
                    // Add blip
                    const blip = document.createElement('div');
                    blip.style.cssText = `
                        position: absolute;
                        width: 10px; height: 10px;
                        background: var(--danger-color);
                        border-radius: 50%;
                        top: ${Math.random() * 180 + 10}px;
                        left: ${Math.random() * 180 + 10}px;
                        box-shadow: 0 0 20px var(--danger-color);
                        animation: blipPulse 3s ease-out forwards;
                    `;
                    motionBlips.appendChild(blip);
                    setTimeout(() => blip.remove(), 3000);
                    
                    alertManager.show('motion-detected', '🚨 Phát hiện chuyển động! Camera đang chụp...', 'danger', 5000);
                } else {
                    indicator.className = 'motion-indicator motion-clear';
                    text.innerHTML = '<i class="fas fa-shield-alt"></i> Không có chuyển động';
                }
            }
        };

        // History Controller
        const historyController = {
            updateTable() {
                const tbody = document.getElementById('historyTableBody');
                
                if (systemState.accessHistory.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <i class="fas fa-history" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                                <p>Chưa có lịch sử truy cập</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = systemState.accessHistory.slice(0, 50).map(item => `
                    <tr>
                        <td>${this.formatDateTime(item.timestamp)}</td>
                        <td>
                            <span class="method-badge method-${item.method}">
                                <i class="fas fa-${item.method === 'fingerprint' ? 'fingerprint' : 'id-card'}"></i>
                                ${item.method === 'fingerprint' ? 'Vân tay' : 'RFID'}
                            </span>
                        </td>
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>
                            <span class="status-badge status-${item.success ? 'success' : 'failed'}">
                                <i class="fas fa-${item.success ? 'check' : 'times'}"></i>
                                ${item.success ? 'Thành công' : 'Từ chối'}
                            </span>
                        </td>
                        <td><span class="action-badge">${item.action}</span></td>
                    </tr>
                `).join('');
            },

            filter() {
                // Filter implementation
                alertManager.show('filter-info', 'Tính năng lọc đang hoạt động', 'info', 2000);
            },

            clearHistory() {
                if (confirm('Xác nhận xóa toàn bộ lịch sử?')) {
                    systemState.accessHistory = [];
                    this.updateTable();
                    alertManager.show('history-cleared', '🗑️ Đã xóa lịch sử', 'success', 3000);
                }
            },

            formatDateTime(date) {
                return new Date(date).toLocaleString('vi-VN');
            }
        };

        // E-Ra Widget Initialization
        function initializeEraWidget() {
            eraWidget.init({
                onConfiguration: (configuration) => {
                    console.log('Configuration received:', configuration);
                    
                    configs = {
                        configDoorStatus: configuration.realtime_configs[0],      // V0
                        configMotionStatus: configuration.realtime_configs[1],    // V2 
                        configFpList: configuration.realtime_configs[2],          // V5
                        configRfidList: configuration.realtime_configs[3],        // V6
                        configErrorCount: configuration.realtime_configs[4],      // V8
                        configIntruderAlert: configuration.realtime_configs[5],   // V9
                        configCameraImage: configuration.realtime_configs[6]      // V11
                    };
                   
                    actions = {
                        closeDoor: configuration.actions[0],                // V1=0
                        openDoor: configuration.actions[1],                 // V1=1
                        fingerprintTestScan: configuration.actions[2],      // V3=1
                        fingerprintEnroll: configuration.actions[3],        // V3=2
                        fingerprintDelete: configuration.actions[4],        // V3=3
                        rfidTestScan: configuration.actions[5],             // V4=1
                        rfidAdd: configuration.actions[6],                  // V4=2
                        rfidRemove: configuration.actions[7],               // V4=3
                        dataPayload: configuration.actions[8]               // V7= JSON data payload
                    };
                   
                    connectionManager.updateStatus(true);
                },

                onValues: (values) => {
                    console.log('Values received:', values);
                    
                    if (configs.configDoorStatus && values[configs.configDoorStatus.id]) {
                        doorStatusHandler.update(values[configs.configDoorStatus.id].value);
                    }
                    
                    if (configs.configMotionStatus && values[configs.configMotionStatus.id]) {
                        motionHandler.update(values[configs.configMotionStatus.id].value);
                    }
                    
                    if (configs.configFpList && values[configs.configFpList.id]) {
                        try {
                            systemState.fingerprintList = JSON.parse(values[configs.configFpList.id].value);
                            fingerprintController.updateList();
                        } catch (e) {
                            console.error('Error parsing fingerprint list:', e);
                        }
                    }
                    
                    if (configs.configRfidList && values[configs.configRfidList.id]) {
                        try {
                            systemState.rfidList = JSON.parse(values[configs.configRfidList.id].value);
                            rfidController.updateList();
                        } catch (e) {
                            console.error('Error parsing RFID list:', e);
                        }
                    }
                    
                    if (configs.configErrorCount && values[configs.configErrorCount.id]) {
                        systemState.errorCount = values[configs.configErrorCount.id].value;
                        if (systemState.errorCount >= 5) {
                            alertManager.show('too-many-errors', '🚨 Quá nhiều lần thử sai!', 'danger', 10000);
                        }
                    }
                    
                    if (configs.configIntruderAlert && values[configs.configIntruderAlert.id]) {
                        systemState.intruderAlert = (values[configs.configIntruderAlert.id].value === 1);
                        if (systemState.intruderAlert) {
                            alertManager.show('intruder-alert', '🚨 CẢNH BÁO KẺ LẠ!', 'danger', 0);
                        }
                    }
                    
                    if (configs.configCameraImage && values[configs.configCameraImage.id]) {
                        cameraController.displayImage(values[configs.configCameraImage.id].value);
                    }
                }
            });
        }

        // Utility Functions
        function switchTab(tab, button) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        // Add blip animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes blipPulse {
                0% { transform: scale(0); opacity: 1; }
                50% { transform: scale(1.5); opacity: 0.7; }
                100% { transform: scale(2); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Smart Door Dashboard v4.1 - All Issues Fixed');
            
            initializeEraWidget();
            fingerprintController.updateList();
            rfidController.updateList();
            historyController.updateTable();
            
            document.getElementById('filterDate').value = new Date().toISOString().split('T')[0];
            connectionManager.updateStatus(false);
            
            // Set camera stream URL
            document.getElementById('streamUrl').textContent = 'rtsp://ESP32_CAM_IP:554/mjpeg/1';
            
            setTimeout(() => {
                if (!systemState.isConnected) {
                    alertManager.show('initial-connecting', '🔗 Đang kết nối với ESP32...', 'info', 5000);
                } else {
                    alertManager.show('initial-ready', '✅ Dashboard v4.1 sẵn sàng!', 'success', 3000);
                }
            }, 2000);
        });

        // Global access for debugging
        window.systemState = systemState;
        window.alertManager = alertManager;
        window.doorController = doorController;
        window.fingerprintController = fingerprintController;
        window.rfidController = rfidController;
        window.cameraController = cameraController;
    </script>
</body>
</html>
