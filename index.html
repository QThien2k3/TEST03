<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Door Security Dashboard - Optimized for E-Ra</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        :root {
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --background: #0a0e27;
            --surface: #151c3d;
            --surface-light: #1e2951;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --border: #2a3660;
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Alert Container - Top Right */
        #alertContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            width: 400px;
            max-width: calc(100vw - 40px);
            pointer-events: none;
        }

        #alertContainer .alert {
            pointer-events: all;
            margin-bottom: 10px;
            transform: translateX(100%);
            animation: slideInRight 0.3s ease forwards;
            padding: 16px 20px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--surface);
            border: 1px solid;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        @keyframes slideInRight {
            to { transform: translateX(0); }
        }

        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: currentColor;
        }

        .alert-success { border-color: var(--success-color); color: var(--success-color); }
        .alert-warning { border-color: var(--warning-color); color: var(--warning-color); }
        .alert-danger { border-color: var(--danger-color); color: var(--danger-color); }
        .alert-info { border-color: var(--primary-color); color: var(--primary-color); }

        .alert-close {
            margin-left: auto;
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 20px;
            opacity: 0.7;
            padding: 4px;
            border-radius: 4px;
        }

        .alert-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            background: var(--surface);
            border: 1px solid var(--border);
            z-index: 1000;
        }

        .connection-status.connected {
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .connection-status.disconnected {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .dashboard-container {
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .dashboard-header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 12px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .dashboard-header p {
            font-size: 1.25rem;
            color: var(--text-secondary);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 28px;
            margin-bottom: 32px;
        }

        .card {
            background: var(--surface);
            border-radius: 24px;
            padding: 28px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            border-color: var(--primary-color);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .card-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-right: 16px;
        }

        .card-icon i {
            color: white;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Door Control */
        .door-control .card-icon {
            background: var(--gradient-success);
        }

        .door-visualization {
            width: 280px;
            height: 180px;
            margin: 24px auto;
            position: relative;
            perspective: 1200px;
        }

        .door-frame {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 12px;
            position: relative;
            border: 4px solid #2a3660;
            overflow: hidden;
        }

        .door-panel {
            width: 85%;
            height: 90%;
            background: var(--gradient-primary);
            position: absolute;
            top: 5%;
            left: 7.5%;
            border-radius: 8px;
            transition: transform 1.5s ease;
            transform-origin: left center;
        }

        .door-panel.open {
            transform: perspective(1200px) rotateY(-85deg) translateZ(30px);
        }

        .door-handle {
            width: 14px;
            height: 40px;
            background: var(--gradient-warning);
            border-radius: 14px;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .door-status {
            margin: 20px 0;
            font-size: 1.35rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .status-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        .status-closed .status-indicator { background: var(--danger-color); }
        .status-open .status-indicator { background: var(--success-color); }
        .status-opening .status-indicator { background: var(--warning-color); animation: pulse 0.5s infinite; }
        .status-closing .status-indicator { background: var(--warning-color); animation: pulse 0.5s infinite; }

        .control-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: var(--gradient-warning);
            color: white;
            box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        /* PIR Motion Status */
        .motion-status {
            margin-top: 20px;
            padding: 16px;
            border-radius: 12px;
            background: var(--background);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .motion-status.detected {
            border-color: var(--danger-color);
            background: rgba(239, 68, 68, 0.1);
        }

        .motion-status.clear {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
        }

        /* Access Management */
        .access-management .card-icon {
            background: var(--gradient-primary);
        }

        .access-tabs {
            display: flex;
            margin-bottom: 24px;
            background: var(--background);
            border-radius: 14px;
            padding: 4px;
        }

        .tab-button {
            flex: 1;
            padding: 14px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-button.active {
            background: var(--gradient-primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            background: var(--background);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
        }

        .section-header strong {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .input-field {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--surface);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--surface-light);
        }

        .scan-section, .detect-section {
            border: 2px dashed var(--border);
            background: rgba(30, 41, 81, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .scan-section.scanning, .detect-section.detecting {
            border-color: var(--primary-color);
            animation: scanPulse 1.5s infinite;
        }

        @keyframes scanPulse {
            0%, 100% { 
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            50% { 
                border-color: #60a5fa;
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
        }

        .scan-status, .rfid-status {
            margin: 12px 0;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            background: var(--surface-light);
            font-weight: 500;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fingerprint-list, .rfid-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--surface);
            margin-top: 20px;
        }

        .list-item {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .list-item:hover {
            background: var(--surface-light);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .list-item-info i {
            color: var(--primary-color);
            font-size: 18px;
        }

        .delete-btn {
            padding: 6px 14px;
            background: var(--gradient-danger);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .delete-btn:hover {
            transform: scale(1.05);
        }

        /* Camera Section */
        .camera-section .card-icon {
            background: var(--gradient-danger);
        }

        .camera-radar {
            width: 100%;
            height: 200px;
            position: relative;
            background: radial-gradient(circle at center, rgba(30, 41, 81, 0.9) 0%, rgba(10, 14, 39, 1) 100%);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .radar-container {
            width: 160px;
            height: 160px;
            position: relative;
        }

        .radar-circle {
            position: absolute;
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .radar-circle:nth-child(1) { width: 160px; height: 160px; }
        .radar-circle:nth-child(2) { width: 120px; height: 120px; }
        .radar-circle:nth-child(3) { width: 80px; height: 80px; }
        .radar-circle:nth-child(4) { width: 40px; height: 40px; }

        .radar-sweep {
            position: absolute;
            width: 100%;
            height: 100%;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                rgba(59, 130, 246, 0.8) 10deg,
                rgba(59, 130, 246, 0.4) 30deg,
                transparent 60deg
            );
            animation: radarSweep 4s linear infinite;
            border-radius: 50%;
        }

        @keyframes radarSweep {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .radar-center {
            position: absolute;
            width: 10px;
            height: 10px;
            background: var(--primary-color);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px var(--primary-color);
        }

        .camera-status {
            margin: 16px 0;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            background: var(--background);
            border: 1px solid var(--border);
            font-weight: 600;
        }

        .camera-feed {
            width: 100%;
            height: 200px;
            background: var(--surface);
            border-radius: 16px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--border);
            overflow: hidden;
        }

        .camera-placeholder {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
        }

        .camera-placeholder i {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--primary-color);
            opacity: 0.6;
        }

        .camera-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 14px;
        }

        /* History Section */
        .history-section {
            grid-column: 1 / -1;
        }

        .history-section .card-icon {
            background: var(--gradient-warning);
        }

        .history-filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .filter-select, .filter-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--background);
            color: var(--text-primary);
            font-size: 14px;
        }

        .history-table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--background);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            background: var(--surface-light);
            padding: 16px;
            text-align: left;
            font-weight: 700;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
        }

        .history-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .history-table tr:hover td {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .method-badge, .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .method-fingerprint {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .method-rfid {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .status-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
        }

        .status-failed {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
        }

        .action-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning-color);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 16px;
            }

            .dashboard-header h1 {
                font-size: 2rem;
                flex-direction: column;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .control-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            #alertContainer {
                width: calc(100vw - 40px);
            }
        }
    </style>
</head>
<body>
    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <!-- Connection Status -->
    <div class="connection-status disconnected" id="connectionStatus">
        <i class="fas fa-circle"></i>
        <span>Đang kết nối...</span>
    </div>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1><i class="fas fa-door-open"></i> Smart Door Security</h1>
            <p>Hệ thống cửa thông minh với E-Ra IoT Platform</p>
        </div>

        <div class="dashboard-grid">
            <!-- Door Control -->
            <div class="card door-control">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-door-open"></i></div>
                    <div class="card-title">Điều Khiển Cửa</div>
                </div>
                
                <div class="door-visualization">
                    <div class="door-frame">
                        <div class="door-panel" id="doorPanel">
                            <div class="door-handle"></div>
                        </div>
                    </div>
                </div>
                
                <div class="door-status status-closed" id="doorStatus">
                    <span class="status-indicator"></span>
                    <span id="doorStatusText">Đóng</span>
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-success" onclick="doorController.openDoor()">
                        <i class="fas fa-unlock"></i>
                        <span>Mở Cửa</span>
                    </button>
                    <button class="btn btn-danger" onclick="doorController.closeDoor()">
                        <i class="fas fa-lock"></i>
                        <span>Đóng Cửa</span>
                    </button>
                    <button class="btn btn-warning" onclick="doorController.stopDoor()">
                        <i class="fas fa-pause"></i>
                        <span>Dừng</span>
                    </button>
                </div>

                <!-- PIR Motion Status -->
                <div class="motion-status clear" id="motionStatus">
                    <div>
                        <i class="fas fa-running"></i>
                        <strong>Cảm biến chuyển động</strong>
                    </div>
                    <span class="badge" id="motionStatusText">Không có chuyển động</span>
                </div>
            </div>

            <!-- Access Management -->
            <div class="card access-management">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-user-shield"></i></div>
                    <div class="card-title">Quản Lý Truy Cập</div>
                </div>

                <div class="access-tabs">
                    <button class="tab-button active" onclick="switchTab('fingerprint', this)">
                        <i class="fas fa-fingerprint"></i>
                        <span>Vân Tay</span>
                    </button>
                    <button class="tab-button" onclick="switchTab('rfid', this)">
                        <i class="fas fa-id-card"></i>
                        <span>Thẻ RFID</span>
                    </button>
                </div>

                <!-- Fingerprint Tab -->
                <div class="tab-content active" id="fingerprintTab">
                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-fingerprint"></i>
                            <strong>Quét vân tay</strong>
                        </div>
                        
                        <div class="scan-section" id="fingerprintScanSection">
                            <div class="scan-status" id="fingerprintScanStatus">
                                Nhấn nút bên dưới để bắt đầu quét vân tay
                            </div>
                            
                            <button class="btn btn-primary" id="startScanBtn" onclick="fingerprintController.startScan()" style="width: 100%; margin-top: 12px;">
                                <i class="fas fa-fingerprint"></i>
                                <span>Bắt Đầu Quét</span>
                            </button>
                            <button class="btn btn-danger" id="stopScanBtn" onclick="fingerprintController.stopScan()" style="display: none; width: 100%; margin-top: 12px;">
                                <i class="fas fa-stop"></i>
                                <span>Dừng Quét</span>
                            </button>
                        </div>

                        <!-- Fingerprint Enrollment Section -->
                        <div class="enrollment-section" style="display: none; margin-top: 20px;" id="fingerprintEnrollSection">
                            <div style="display: flex; align-items: center; margin-bottom: 16px;">
                                <i class="fas fa-check-circle" style="font-size: 24px; margin-right: 12px; color: var(--success-color);"></i>
                                <strong style="font-size: 1.1rem; color: var(--success-color);">Vân tay mới phát hiện!</strong>
                            </div>
                            
                            <div class="input-group">
                                <label>ID Vân Tay:</label>
                                <input type="text" class="input-field" id="verifiedFingerprintId" readonly>
                            </div>
                            
                            <div class="input-group">
                                <label>Tên người dùng:</label>
                                <input type="text" class="input-field" id="fingerprintName" placeholder="Nhập tên cho vân tay này">
                            </div>
                            
                            <button class="btn btn-success" onclick="fingerprintController.enrollVerified()" style="width: 100%;">
                                <i class="fas fa-check"></i>
                                <span>Thêm Vân Tay</span>
                            </button>
                        </div>
                    </div>

                    <!-- Manual Fingerprint Add -->
                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-plus-circle"></i>
                            <strong>Thêm vân tay thủ công</strong>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 12px;">
                            <input type="number" class="input-field" id="manualFingerprintId" placeholder="ID (1-127)" min="1" max="127">
                            <input type="text" class="input-field" id="manualFingerprintName" placeholder="Tên người dùng">
                        </div>
                        
                        <button class="btn btn-primary" style="margin-top: 12px; width: 100%;" onclick="fingerprintController.enrollManual()">
                            <i class="fas fa-plus"></i>
                            <span>Đăng Ký</span>
                        </button>
                    </div>
                    
                    <!-- Fingerprint List -->
                    <div style="margin-top: 20px;">
                        <div style="margin-bottom: 12px; font-weight: 600; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-list"></i> Danh sách vân tay:</span>
                            <button class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;" onclick="fingerprintController.clearAll()">
                                <i class="fas fa-trash"></i> Xóa tất cả
                            </button>
                        </div>
                        
                        <div class="fingerprint-list" id="fingerprintList">
                            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                <div class="loading"></div>
                                <p style="margin-top: 12px;">Đang tải danh sách...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RFID Tab -->
                <div class="tab-content" id="rfidTab">
                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-wifi"></i>
                            <strong>Quét thẻ RFID</strong>
                        </div>
                        
                        <div class="detect-section" id="rfidDetectSection">
                            <div class="rfid-status" id="rfidDetectionStatus">
                                Nhấn nút để bắt đầu quét thẻ RFID
                            </div>
                            
                            <button class="btn btn-primary" onclick="rfidController.testScan()" style="width: 100%; margin-top: 12px;">
                                <i class="fas fa-id-card"></i>
                                <span>Bắt Đầu Quét</span>
                            </button>
                        </div>

                        <!-- RFID Add Section -->
                        <div class="rfid-management" id="rfidManagementSection" style="display: none; margin-top: 20px;">
                            <div style="display: flex; align-items: center; margin-bottom: 16px;">
                                <i class="fas fa-check-circle" style="font-size: 24px; margin-right: 12px; color: var(--success-color);"></i>
                                <strong style="font-size: 1.1rem; color: var(--success-color);">Thẻ mới phát hiện!</strong>
                            </div>
                            
                            <div class="input-group">
                                <label>UID Thẻ RFID:</label>
                                <input type="text" class="input-field" id="rfidUid" readonly>
                            </div>
                            
                            <div class="input-group">
                                <label>Tên chủ thẻ:</label>
                                <input type="text" class="input-field" id="rfidCardName" placeholder="Nhập tên cho thẻ này">
                            </div>
                            
                            <button class="btn btn-success" onclick="rfidController.addScanned()" style="width: 100%;">
                                <i class="fas fa-check"></i>
                                <span>Thêm Thẻ</span>
                            </button>
                        </div>
                    </div>

                    <!-- Manual RFID Add -->
                    <div class="section">
                        <div class="section-header">
                            <i class="fas fa-plus-circle"></i>
                            <strong>Thêm thẻ RFID thủ công</strong>
                        </div>
                        
                        <input type="text" class="input-field" id="manualRfidUid" placeholder="Nhập UID thẻ (VD: 04ABCDEF)" style="margin-bottom: 12px;">
                        <input type="text" class="input-field" id="manualRfidName" placeholder="Tên chủ thẻ">
                        
                        <button class="btn btn-primary" style="margin-top: 12px; width: 100%;" onclick="rfidController.addManual()">
                            <i class="fas fa-plus"></i>
                            <span>Thêm Thẻ</span>
                        </button>
                    </div>
                    
                    <!-- RFID List -->
                    <div style="margin-top: 20px;">
                        <div style="margin-bottom: 12px; font-weight: 600; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center;">
                            <span><i class="fas fa-list"></i> Danh sách thẻ RFID:</span>
                            <button class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;" onclick="rfidController.clearAll()">
                                <i class="fas fa-trash"></i> Xóa tất cả
                            </button>
                        </div>
                        
                        <div class="rfid-list" id="rfidList">
                            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                <div class="loading"></div>
                                <p style="margin-top: 12px;">Đang tải danh sách...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Camera Section -->
            <div class="card camera-section">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-video"></i></div>
                    <div class="card-title">Camera An Ninh</div>
                </div>

                <div class="camera-radar">
                    <div class="radar-container">
                        <div class="radar-circle"></div>
                        <div class="radar-circle"></div>
                        <div class="radar-circle"></div>
                        <div class="radar-circle"></div>
                        <div class="radar-sweep"></div>
                        <div class="radar-center"></div>
                    </div>
                </div>

                <div class="camera-status" id="cameraStatus">
                    <i class="fas fa-camera"></i> Sẵn sàng chụp ảnh
                </div>

                <div class="camera-feed" id="cameraFeed">
                    <div class="camera-placeholder">
                        <i class="fas fa-camera"></i>
                        <div>Camera sẽ tự động chụp khi có chuyển động</div>
                        <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">
                            Ảnh sẽ được gửi qua email tự động
                        </div>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="btn btn-primary" onclick="cameraController.manualCapture()">
                        <i class="fas fa-camera"></i>
                        <span>Chụp Thủ Công</span>
                    </button>
                </div>

                <div style="margin-top: 20px; padding: 16px; background: var(--background); border-radius: 12px;">
                    <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
                        <div><i class="fas fa-envelope"></i> Email: phamquocthien17@gmail.com</div>
                        <div><i class="fas fa-robot"></i> Tự động gửi ảnh khi phát hiện chuyển động</div>
                        <div><i class="fas fa-clock"></i> Thời gian chụp: <span id="lastCaptureTime">Chưa có</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="card history-section">
            <div class="card-header">
                <div class="card-icon"><i class="fas fa-history"></i></div>
                <div class="card-title">Lịch Sử Truy Cập</div>
            </div>

            <div class="history-filters">
                <div class="filter-group">
                    <label>Ngày:</label>
                    <input type="date" class="filter-input" id="filterDate" onchange="historyController.filter()">
                </div>
                <div class="filter-group">
                    <label>Phương thức:</label>
                    <select class="filter-select" id="filterMethod" onchange="historyController.filter()">
                        <option value="">Tất cả</option>
                        <option value="fp">Vân tay</option>
                        <option value="rfid">Thẻ RFID</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="historyController.export()">
                        <i class="fas fa-file-excel"></i>
                        <span>Xuất Excel</span>
                    </button>
                    <button class="btn btn-warning" onclick="historyController.clearHistory()" style="margin-top: 8px;">
                        <i class="fas fa-trash"></i>
                        <span>Xóa lịch sử</span>
                    </button>
                </div>
            </div>

            <div class="history-table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Thời gian</th>
                            <th>Phương thức</th>
                            <th>ID/UID</th>
                            <th>Tên</th>
                            <th>Kết quả</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <div class="loading"></div>
                                <p style="margin-top: 12px;">Đang tải lịch sử...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- E-Ra Widget -->
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
    <script>
        // E-Ra Widget Instance
        const eraWidget = new EraWidget();
        
        // Configuration mapping for ESP32 Door Controller & ESP32-CAM
        let configDoorStatus = null;        // V1: Door status
        let configPirMotion = null;         // V2: PIR motion
        let configAccessLog = null;         // V3: Access log
        let configFingerprintList = null;   // V4: Fingerprint list
        let configRfidList = null;          // V5: RFID list
        let configIntruderAlert = null;     // V6: Intruder alert
        let configSystemStatus = null;      // V8: System status
        let configCameraStatus = null;      // V9: Camera status
        let configCameraImage = null;       // V10: Camera image (if available)
        let configFingerprintResult = null; // V11: Fingerprint result
        let configRfidResult = null;        // V12: RFID result

        // Action mapping - Match với 13 actions trong E-Ra config
        let actionDoorClose = null;             // action[0]: V0=0
        let actionDoorOpen = null;              // action[1]: V0=1  
        let actionDoorStop = null;              // action[2]: V0=2
        let actionFingerprintTestScan = null;   // action[3]: V4=1
        let actionFingerprintTestStop = null;   // action[4]: V4=2
        let actionFingerprintEnroll = null;     // action[5]: V4=3
        let actionFingerprintDelete = null;     // action[6]: V4=4
        let actionRfidTestScan = null;          // action[7]: V5=1
        let actionRfidAdd = null;               // action[8]: V5=2
        let actionRfidRemove = null;            // action[9]: V5=3
        let actionRfidTestStop = null;          // action[10]: V5=4
        let actionCameraMotionTrigger = null;   // action[11]: V7=1
        let actionCameraManualTrigger = null;   // action[12]: V7=2

        // System State
        let systemState = {
            doorStatus: 'closed',
            motionDetected: false,
            fingerprintScanActive: false,
            currentVerifiedFingerprintId: null,
            currentScannedRfidUid: null,
            fingerprintList: [],
            rfidList: [],
            accessHistory: [],
            isConnected: false,
            failedAttempts: 0,
            lastCaptureTime: null,
            // Camera image chunk handling
            imageChunks: null,
            imageSize: 0,
            imageTotalChunks: 0
        };

        // Alert Manager
        const alertManager = {
            alerts: new Map(),
            
            show(id, message, type = 'success', timeout = 5000) {
                this.remove(id);
                
                const container = document.getElementById('alertContainer');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.id = `alert-${id}`;
                alert.innerHTML = `
                    <i class="fas fa-${this.getIcon(type)}"></i>
                    <span>${message}</span>
                    <button class="alert-close" onclick="alertManager.remove('${id}')">×</button>
                `;
                
                container.appendChild(alert);
                this.alerts.set(id, alert);
                
                if (timeout > 0) {
                    setTimeout(() => this.remove(id), timeout);
                }
            },
            
            getIcon(type) {
                const icons = {
                    success: 'check-circle',
                    warning: 'exclamation-triangle',
                    danger: 'exclamation-circle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            },
            
            remove(id) {
                const alert = this.alerts.get(id);
                if (alert && alert.parentElement) {
                    alert.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (alert.parentElement) alert.remove();
                        this.alerts.delete(id);
                    }, 300);
                }
            }
        };

        // Connection Manager
        const connectionManager = {
            updateStatus(connected) {
                systemState.isConnected = connected;
                const statusEl = document.getElementById('connectionStatus');
                
                if (connected) {
                    statusEl.className = 'connection-status connected';
                    statusEl.innerHTML = '<i class="fas fa-circle"></i><span>Kết nối E-Ra</span>';
                    alertManager.show('era-connected', '✅ Kết nối E-Ra thành công', 'success', 3000);
                } else {
                    statusEl.className = 'connection-status disconnected';
                    statusEl.innerHTML = '<i class="fas fa-circle"></i><span>Mất kết nối</span>';
                    alertManager.show('era-disconnected', '❌ Mất kết nối E-Ra', 'danger', 5000);
                }
            },
            
            testConnection() {
                if (!systemState.isConnected) {
                    alertManager.show('connection-test', '❌ Chưa kết nối E-Ra!', 'danger', 3000);
                    return false;
                }
                return true;
            }
        };

        // Door Controller
        const doorController = {
            openDoor() {
                if (!connectionManager.testConnection()) return;
                
                if (actionDoorOpen && actionDoorOpen.action) {
                    // Trigger separate open door action
                    eraWidget.triggerAction(actionDoorOpen.action, null);
                    alertManager.show('door-opening', '🚪 Đang mở cửa...', 'success', 3000);
                    doorStatusHandler.update('opening');
                }
            },

            closeDoor() {
                if (!connectionManager.testConnection()) return;
                
                if (actionDoorClose && actionDoorClose.action) {
                    // Trigger separate close door action
                    eraWidget.triggerAction(actionDoorClose.action, null);
                    alertManager.show('door-closing', '🚪 Đang đóng cửa...', 'warning', 3000);
                    doorStatusHandler.update('closing');
                }
            },

            stopDoor() {
                if (!connectionManager.testConnection()) return;
                
                if (actionDoorStop && actionDoorStop.action) {
                    // Trigger separate stop door action
                    eraWidget.triggerAction(actionDoorStop.action, null);
                    alertManager.show('door-stopping', '⏸️ Đang dừng cửa...', 'warning', 2000);
                }
            }
        };

        // Door Status Handler
        const doorStatusHandler = {
            update(status) {
                systemState.doorStatus = status;
                
                const doorPanel = document.getElementById('doorPanel');
                const doorStatusEl = document.getElementById('doorStatus');
                const doorStatusText = document.getElementById('doorStatusText');
                
                doorPanel.classList.remove('open');
                doorStatusEl.className = 'door-status';
                
                // Handle Vietnamese status from ESP32
                if (status === 'Mo' || status === 'Open' || status === 'opening') {
                    doorPanel.classList.add('open');
                    doorStatusEl.className = 'door-status status-open';
                    doorStatusText.textContent = 'Mở';
                } else if (status === 'Dong' || status === 'Closed' || status === 'closed') {
                    doorStatusEl.className = 'door-status status-closed';
                    doorStatusText.textContent = 'Đóng';
                } else if (status === 'Mo...' || status === 'opening') {
                    doorStatusEl.className = 'door-status status-opening';
                    doorStatusText.textContent = 'Đang Mở';
                    setTimeout(() => doorPanel.classList.add('open'), 500);
                } else if (status === 'Dong...' || status === 'closing') {
                    doorStatusEl.className = 'door-status status-closing';
                    doorStatusText.textContent = 'Đang Đóng';
                } else {
                    doorStatusText.textContent = status || 'Không xác định';
                }
            }
        };

        // PIR Motion Handler
        const motionHandler = {
            update(detected) {
                systemState.motionDetected = Boolean(detected);
                
                const motionStatus = document.getElementById('motionStatus');
                const motionStatusText = document.getElementById('motionStatusText');
                
                if (detected) {
                    motionStatus.className = 'motion-status detected';
                    motionStatusText.textContent = 'Phát hiện chuyển động!';
                    motionStatusText.className = 'badge';
                    motionStatusText.style.background = 'var(--danger-color)';
                    motionStatusText.style.color = 'white';
                    
                    alertManager.show('motion-detected', '🚨 Phát hiện chuyển động!', 'danger', 3000);
                } else {
                    motionStatus.className = 'motion-status clear';
                    motionStatusText.textContent = 'Không có chuyển động';
                    motionStatusText.className = 'badge';
                    motionStatusText.style.background = 'var(--success-color)';
                    motionStatusText.style.color = 'white';
                }
            }
        };

        // Fingerprint Controller
        const fingerprintController = {
            startScan() {
                if (!connectionManager.testConnection()) return;
                
                if (actionFingerprintTestScan && actionFingerprintTestScan.action) {
                    // Trigger fingerprint test scan action
                    eraWidget.triggerAction(actionFingerprintTestScan.action, null);
                    
                    systemState.fingerprintScanActive = true;
                    document.getElementById('startScanBtn').style.display = 'none';
                    document.getElementById('stopScanBtn').style.display = 'inline-flex';
                    document.getElementById('fingerprintScanSection').classList.add('scanning');
                    
                    const statusEl = document.getElementById('fingerprintScanStatus');
                    statusEl.textContent = '👆 Đặt ngón tay lên cảm biến AS608...';
                    statusEl.style.background = 'var(--primary-color)';
                    statusEl.style.color = 'white';
                    
                    alertManager.show('fp-scan-start', '👆 Bắt đầu quét vân tay!', 'success', 3000);
                }
            },

            stopScan() {
                if (actionFingerprintTestStop && actionFingerprintTestStop.action) {
                    // Trigger fingerprint test stop action
                    eraWidget.triggerAction(actionFingerprintTestStop.action, null);
                }
                
                this.resetScanUI();
                alertManager.show('fp-scan-stop', '⏹️ Đã dừng quét vân tay', 'warning', 2000);
            },

            resetScanUI() {
                systemState.fingerprintScanActive = false;
                document.getElementById('startScanBtn').style.display = 'inline-flex';
                document.getElementById('stopScanBtn').style.display = 'none';
                document.getElementById('fingerprintScanSection').classList.remove('scanning');
                document.getElementById('fingerprintEnrollSection').style.display = 'none';
                
                const statusEl = document.getElementById('fingerprintScanStatus');
                statusEl.textContent = 'Nhấn nút bên dưới để bắt đầu quét vân tay';
                statusEl.style.background = 'var(--surface-light)';
                statusEl.style.color = 'var(--text-primary)';
            },

            // Thêm vân tay đã quét với tên
            enrollVerified() {
                const name = document.getElementById('fingerprintName').value.trim();
                
                if (!name) {
                    alertManager.show('fp-name-required', '⚠️ Vui lòng nhập tên', 'warning', 3000);
                    return;
                }

                if (!systemState.currentVerifiedFingerprintId) {
                    alertManager.show('fp-no-verified', '⚠️ Không có vân tay được quét', 'warning', 3000);
                    return;
                }

                if (actionFingerprintEnroll && actionFingerprintEnroll.action) {
                    // Trigger fingerprint enroll action với data
                    const enrollData = {
                        id: systemState.currentVerifiedFingerprintId,
                        name: name
                    };
                    
                    eraWidget.triggerAction(actionFingerprintEnroll.action, enrollData);
                    
                    // Update local list
                    systemState.fingerprintList = systemState.fingerprintList.filter(fp => fp.id !== systemState.currentVerifiedFingerprintId);
                    systemState.fingerprintList.push({
                        id: systemState.currentVerifiedFingerprintId,
                        name: name
                    });
                    systemState.fingerprintList.sort((a, b) => a.id - b.id);
                    
                    alertManager.show('fp-enrolled', `✅ Đã thêm vân tay "${name}" với ID ${systemState.currentVerifiedFingerprintId}`, 'success', 5000);
                    
                    // Reset form
                    document.getElementById('fingerprintName').value = '';
                    systemState.currentVerifiedFingerprintId = null;
                    document.getElementById('fingerprintEnrollSection').style.display = 'none';
                    this.updateList();
                }
            },

            // Thêm vân tay thủ công
            enrollManual() {
                const id = parseInt(document.getElementById('manualFingerprintId').value);
                const name = document.getElementById('manualFingerprintName').value.trim();
                
                if (!id || id < 1 || id > 127) {
                    alertManager.show('fp-invalid-id', '⚠️ ID phải từ 1-127', 'warning', 3000);
                    return;
                }
                
                if (!name) {
                    alertManager.show('fp-name-required', '⚠️ Vui lòng nhập tên', 'warning', 3000);
                    return;
                }
                
                if (systemState.fingerprintList.some(fp => fp.id === id)) {
                    alertManager.show('fp-id-exists', `⚠️ ID ${id} đã tồn tại!`, 'warning', 3000);
                    return;
                }

                if (actionFingerprintEnroll && actionFingerprintEnroll.action) {
                    // Trigger fingerprint enroll action với data
                    const enrollData = {
                        id: id,
                        name: name
                    };
                    
                    eraWidget.triggerAction(actionFingerprintEnroll.action, enrollData);
                    
                    systemState.fingerprintList.push({ id, name });
                    systemState.fingerprintList.sort((a, b) => a.id - b.id);
                    
                    alertManager.show('fp-manual-enrolled', `✅ Đã thêm vân tay "${name}" với ID ${id}`, 'success', 3000);
                    
                    document.getElementById('manualFingerprintId').value = '';
                    document.getElementById('manualFingerprintName').value = '';
                    this.updateList();
                }
            },

            delete(id) {
                const fingerprint = systemState.fingerprintList.find(fp => fp.id === id);
                if (!fingerprint) return;
                
                if (!confirm(`Xác nhận xóa vân tay "${fingerprint.name}"?`)) return;
                
                if (actionFingerprintDelete && actionFingerprintDelete.action) {
                    // Trigger fingerprint delete action với data
                    const deleteData = { id: id };
                    
                    eraWidget.triggerAction(actionFingerprintDelete.action, deleteData);
                    systemState.fingerprintList = systemState.fingerprintList.filter(fp => fp.id !== id);
                    
                    alertManager.show('fp-deleted', `🗑️ Đã xóa vân tay "${fingerprint.name}"`, 'success', 3000);
                    this.updateList();
                }
            },

            clearAll() {
                if (!confirm('Xác nhận xóa TẤT CẢ vân tay?')) return;
                
                systemState.fingerprintList = [];
                this.updateList();
                alertManager.show('fp-cleared', '🗑️ Đã xóa tất cả vân tay', 'warning', 3000);
            },

            updateList() {
                const list = document.getElementById('fingerprintList');
                
                if (systemState.fingerprintList.length === 0) {
                    list.innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            <i class="fas fa-fingerprint" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                            <p>Chưa có vân tay nào được lưu</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = systemState.fingerprintList.map(fp => `
                    <div class="list-item">
                        <div class="list-item-info">
                            <i class="fas fa-fingerprint"></i>
                            <span>ID #${fp.id} - ${fp.name}</span>
                        </div>
                        <button class="delete-btn" onclick="fingerprintController.delete(${fp.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }
        };

        // RFID Controller
        const rfidController = {
            testScan() {
                if (!connectionManager.testConnection()) return;

                if (actionRfidTestScan && actionRfidTestScan.action) {
                    // Trigger RFID test scan action
                    eraWidget.triggerAction(actionRfidTestScan.action, null);
                    
                    document.getElementById('rfidDetectSection').classList.add('detecting');
                    
                    const statusEl = document.getElementById('rfidDetectionStatus');
                    statusEl.textContent = '💳 Đang quét thẻ RFID...';
                    statusEl.style.background = 'var(--primary-color)';
                    statusEl.style.color = 'white';
                    
                    // Show stop button
                    const testBtn = document.querySelector('#rfidTab .btn-primary');
                    testBtn.style.display = 'none';
                    
                    const stopBtn = document.createElement('button');
                    stopBtn.className = 'btn btn-danger';
                    stopBtn.style.width = '100%';
                    stopBtn.style.marginTop = '12px';
                    stopBtn.id = 'rfidStopBtn';
                    stopBtn.innerHTML = '<i class="fas fa-stop"></i><span>Dừng Quét</span>';
                    stopBtn.onclick = () => this.stopScan();
                    
                    testBtn.parentElement.appendChild(stopBtn);
                    
                    alertManager.show('rfid-scan-start', '💳 Bắt đầu quét thẻ RFID!', 'success', 3000);
                }
            },

            stopScan() {
                if (actionRfidTestStop && actionRfidTestStop.action) {
                    // Trigger RFID test stop action
                    eraWidget.triggerAction(actionRfidTestStop.action, null);
                }
                
                this.resetScanUI();
                alertManager.show('rfid-scan-stop', '⏹️ Đã dừng quét thẻ RFID', 'warning', 2000);
            },

            resetScanUI() {
                document.getElementById('rfidDetectSection').classList.remove('detecting');
                
                const statusEl = document.getElementById('rfidDetectionStatus');
                statusEl.textContent = 'Nhấn nút để bắt đầu quét thẻ RFID';
                statusEl.style.background = 'var(--surface-light)';
                statusEl.style.color = 'var(--text-primary)';
                
                // Reset buttons
                const testBtn = document.querySelector('#rfidTab .btn-primary');
                const stopBtn = document.getElementById('rfidStopBtn');
                
                if (testBtn) testBtn.style.display = 'inline-flex';
                if (stopBtn) stopBtn.remove();
                
                // Hide management section
                document.getElementById('rfidManagementSection').style.display = 'none';
            },

            // Thêm thẻ RFID đã quét với tên
            addScanned() {
                const name = document.getElementById('rfidCardName').value.trim();
                
                if (!systemState.currentScannedRfidUid) {
                    alertManager.show('rfid-no-scanned', '⚠️ Không có thẻ được quét', 'warning', 3000);
                    return;
                }
                
                if (!name) {
                    alertManager.show('rfid-name-required', '⚠️ Vui lòng nhập tên', 'warning', 3000);
                    return;
                }

                if (actionRfidAdd && actionRfidAdd.action) {
                    // Trigger RFID add action với data
                    const addData = {
                        uid: systemState.currentScannedRfidUid,
                        name: name
                    };
                    
                    eraWidget.triggerAction(actionRfidAdd.action, addData);
                    
                    const newCard = {
                        uid: systemState.currentScannedRfidUid,
                        name: name
                    };
                    
                    systemState.rfidList = systemState.rfidList.filter(card => card.uid !== newCard.uid);
                    systemState.rfidList.push(newCard);
                    
                    alertManager.show('rfid-added', `✅ Đã thêm thẻ "${name}" với UID ${systemState.currentScannedRfidUid}`, 'success', 5000);
                    
                    // Reset form
                    document.getElementById('rfidCardName').value = '';
                    document.getElementById('rfidManagementSection').style.display = 'none';
                    systemState.currentScannedRfidUid = null;
                    this.resetScanUI();
                    this.updateList();
                }
            },

            // Thêm thẻ RFID thủ công
            addManual() {
                const uid = document.getElementById('manualRfidUid').value.trim().toUpperCase();
                const name = document.getElementById('manualRfidName').value.trim();
                
                if (!uid) {
                    alertManager.show('rfid-uid-required', '⚠️ Vui lòng nhập UID', 'warning', 3000);
                    return;
                }
                
                if (!name) {
                    alertManager.show('rfid-name-required', '⚠️ Vui lòng nhập tên', 'warning', 3000);
                    return;
                }
                
                if (systemState.rfidList.some(card => card.uid === uid)) {
                    alertManager.show('rfid-uid-exists', '⚠️ UID đã tồn tại!', 'warning', 3000);
                    return;
                }

                if (actionRfidAdd && actionRfidAdd.action) {
                    // Trigger RFID add action với data
                    const addData = {
                        uid: uid,
                        name: name
                    };
                    
                    eraWidget.triggerAction(actionRfidAdd.action, addData);
                    
                    systemState.rfidList.push({ uid, name });
                    
                    alertManager.show('rfid-manual-added', `✅ Đã thêm thẻ "${name}" với UID ${uid}`, 'success', 3000);
                    
                    document.getElementById('manualRfidUid').value = '';
                    document.getElementById('manualRfidName').value = '';
                    this.updateList();
                }
            },

            remove(uid) {
                const card = systemState.rfidList.find(c => c.uid === uid);
                if (!card) return;
                
                if (!confirm(`Xác nhận xóa thẻ "${card.name}"?`)) return;
                
                if (actionRfidRemove && actionRfidRemove.action) {
                    // Trigger RFID remove action với data
                    const removeData = { uid: uid };
                    
                    eraWidget.triggerAction(actionRfidRemove.action, removeData);
                    systemState.rfidList = systemState.rfidList.filter(c => c.uid !== uid);
                    
                    alertManager.show('rfid-removed', `🗑️ Đã xóa thẻ "${card.name}"`, 'success', 3000);
                    this.updateList();
                }
            },

            clearAll() {
                if (!confirm('Xác nhận xóa TẤT CẢ thẻ RFID?')) return;
                
                systemState.rfidList = [];
                this.updateList();
                alertManager.show('rfid-cleared', '🗑️ Đã xóa tất cả thẻ RFID', 'warning', 3000);
            },

            updateList() {
                const list = document.getElementById('rfidList');
                
                if (systemState.rfidList.length === 0) {
                    list.innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            <i class="fas fa-id-card" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                            <p>Chưa có thẻ RFID nào được lưu</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = systemState.rfidList.map(card => `
                    <div class="list-item">
                        <div class="list-item-info">
                            <i class="fas fa-id-card"></i>
                            <span>${card.uid} - ${card.name}</span>
                        </div>
                        <button class="delete-btn" onclick="rfidController.remove('${card.uid}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            }
        };

        // Camera Controller
        const cameraController = {
            manualCapture() {
                if (!connectionManager.testConnection()) return;

                if (actionCameraManualTrigger && actionCameraManualTrigger.action) {
                    // Trigger camera manual action
                    eraWidget.triggerAction(actionCameraManualTrigger.action, null);
                    alertManager.show('camera-manual', '📸 Đang chụp ảnh thủ công...', 'success', 5000);
                    
                    document.getElementById('cameraStatus').innerHTML = '<i class="fas fa-camera"></i> Đang chụp ảnh...';
                    systemState.lastCaptureTime = new Date();
                    document.getElementById('lastCaptureTime').textContent = systemState.lastCaptureTime.toLocaleTimeString('vi-VN');
                }
            },

            handleImageChunks(size, chunkIndex, totalChunks) {
                // Handle image chunks from ESP32-CAM (V14, V15, V16)
                if (!systemState.imageChunks) {
                    systemState.imageChunks = [];
                    systemState.imageSize = size;
                    systemState.imageTotalChunks = totalChunks;
                }
                
                console.log(`Received chunk ${chunkIndex} of ${totalChunks}`);
                
                // When all chunks received, reconstruct image
                if (systemState.imageChunks.length === totalChunks) {
                    const completeImage = systemState.imageChunks.join('');
                    this.displayImage(completeImage);
                    
                    // Reset chunk state
                    systemState.imageChunks = null;
                    systemState.imageSize = 0;
                    systemState.imageTotalChunks = 0;
                }
            },

            displayImage(imageData) {
                if (!imageData || imageData.length < 100) return;
                
                const cameraFeed = document.getElementById('cameraFeed');
                const img = document.createElement('img');
                img.className = 'camera-image';
                
                // Handle different image formats
                if (imageData.startsWith('data:image')) {
                    img.src = imageData;
                } else if (imageData.startsWith('/9j/') || imageData.startsWith('iVBORw0KGgo')) {
                    img.src = `data:image/jpeg;base64,${imageData}`;
                } else {
                    img.src = imageData; // Assume it's a URL
                }
                
                img.onload = () => {
                    cameraFeed.innerHTML = '';
                    cameraFeed.appendChild(img);
                    alertManager.show('camera-image', '📸 Đã nhận ảnh từ ESP32-CAM', 'success', 3000);
                    
                    document.getElementById('cameraStatus').innerHTML = '<i class="fas fa-check-circle"></i> Đã chụp ảnh thành công';
                    
                    // Reset after 30 seconds
                    setTimeout(() => {
                        cameraFeed.innerHTML = `
                            <div class="camera-placeholder">
                                <i class="fas fa-camera"></i>
                                <div>Camera sẽ tự động chụp khi có chuyển động</div>
                                <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">
                                    Ảnh sẽ được gửi qua email tự động
                                </div>
                            </div>
                        `;
                        document.getElementById('cameraStatus').innerHTML = '<i class="fas fa-camera"></i> Sẵn sàng chụp ảnh';
                    }, 30000);
                };
                
                img.onerror = () => {
                    alertManager.show('camera-error', '❌ Lỗi hiển thị ảnh', 'danger', 3000);
                };
            }
        };

        // History Controller
        const historyController = {
            addEntry(logData) {
                try {
                    const log = JSON.parse(logData);
                    
                    const historyItem = {
                        timestamp: new Date(log.time || Date.now()),
                        method: log.method,
                        id: log.id,
                        name: log.name || 'Unknown',
                        success: true, // Assume success if logged
                        action: 'Mở cửa'
                    };
                    
                    systemState.accessHistory.unshift(historyItem);
                    
                    // Limit to 100 entries
                    if (systemState.accessHistory.length > 100) {
                        systemState.accessHistory = systemState.accessHistory.slice(0, 100);
                    }
                    
                    this.updateTable();
                    
                    const method = log.method === 'fp' ? '👆' : '💳';
                    alertManager.show('access-success', `${method} Truy cập thành công: ${log.name}`, 'success', 3000);
                } catch (e) {
                    console.error('History parse error:', e);
                }
            },

            updateTable() {
                const tbody = document.getElementById('historyTableBody');
                
                if (systemState.accessHistory.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                <i class="fas fa-history" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                                <p>Chưa có lịch sử truy cập</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = systemState.accessHistory.slice(0, 50).map(item => `
                    <tr>
                        <td>${this.formatDateTime(item.timestamp)}</td>
                        <td>
                            <span class="method-badge method-${item.method}">
                                <i class="fas fa-${item.method === 'fp' ? 'fingerprint' : 'id-card'}"></i>
                                ${item.method === 'fp' ? 'Vân tay' : 'RFID'}
                            </span>
                        </td>
                        <td>${item.id}</td>
                        <td>${item.name}</td>
                        <td>
                            <span class="status-badge status-${item.success ? 'success' : 'failed'}">
                                <i class="fas fa-${item.success ? 'check' : 'times'}"></i>
                                ${item.success ? 'Thành công' : 'Từ chối'}
                            </span>
                        </td>
                        <td><span class="action-badge">${item.action}</span></td>
                    </tr>
                `).join('');
            },

            filter() {
                alertManager.show('filter-info', 'Tính năng lọc đang hoạt động', 'info', 2000);
            },

            clearHistory() {
                if (confirm('Xác nhận xóa toàn bộ lịch sử?')) {
                    systemState.accessHistory = [];
                    this.updateTable();
                    alertManager.show('history-cleared', '🗑️ Đã xóa lịch sử', 'success', 3000);
                }
            },

            export() {
                if (systemState.accessHistory.length === 0) {
                    alertManager.show('export-empty', '📊 Không có dữ liệu để xuất', 'warning', 3000);
                    return;
                }
                
                const headers = ['Thời gian', 'Phương thức', 'ID/UID', 'Tên', 'Kết quả', 'Hành động'];
                const csvContent = [
                    headers.join(','),
                    ...systemState.accessHistory.map(item => [
                        `"${this.formatDateTime(item.timestamp)}"`,
                        `"${item.method === 'fp' ? 'Vân tay' : 'RFID'}"`,
                        `"${item.id}"`,
                        `"${item.name}"`,
                        `"${item.success ? 'Thành công' : 'Từ chối'}"`,
                        `"${item.action}"`
                    ].join(','))
                ].join('\n');
                
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `lich_su_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                
                alertManager.show('export-success', '📁 Đã xuất CSV', 'success', 3000);
            },

            formatDateTime(date) {
                return new Date(date).toLocaleString('vi-VN');
            }
        };

        // E-Ra Widget Initialization
        eraWidget.init({
            onConfiguration: (configuration) => {
                console.log('E-Ra Configuration received:', configuration);
                
                // Map realtime configs to ESP32 Virtual Pins
                configDoorStatus = configuration.realtime_configs[0];        // V1
                configPirMotion = configuration.realtime_configs[1];         // V2
                configAccessLog = configuration.realtime_configs[2];         // V3
                configFingerprintList = configuration.realtime_configs[3];   // V4
                configRfidList = configuration.realtime_configs[4];          // V5
                configIntruderAlert = configuration.realtime_configs[5];     // V6
                configSystemStatus = configuration.realtime_configs[6];      // V8
                configCameraStatus = configuration.realtime_configs[7];      // V9
                configFingerprintResult = configuration.realtime_configs[8]; // V11
                configRfidResult = configuration.realtime_configs[9];        // V12
                configCameraImageSize = configuration.realtime_configs[10];  // V14 (ESP32-CAM)
                configCameraChunkIndex = configuration.realtime_configs[11]; // V15 (ESP32-CAM)
                configCameraChunkTotal = configuration.realtime_configs[12]; // V16 (ESP32-CAM)

                // Map actions theo đúng 13 actions trong E-Ra config
                actionDoorClose = configuration.actions[0];                 // V0=0
                actionDoorOpen = configuration.actions[1];                  // V0=1
                actionDoorStop = configuration.actions[2];                  // V0=2
                actionFingerprintTestScan = configuration.actions[3];       // V4=1
                actionFingerprintTestStop = configuration.actions[4];       // V4=2
                actionFingerprintEnroll = configuration.actions[5];         // V4=3
                actionFingerprintDelete = configuration.actions[6];         // V4=4
                actionRfidTestScan = configuration.actions[7];              // V5=1
                actionRfidAdd = configuration.actions[8];                   // V5=2
                actionRfidRemove = configuration.actions[9];                // V5=3
                actionRfidTestStop = configuration.actions[10];             // V5=4
                actionCameraMotionTrigger = configuration.actions[11];      // V7=1
                actionCameraManualTrigger = configuration.actions[12];      // V7=2

                connectionManager.updateStatus(true);
            },

            onValues: (values) => {
                console.log('E-Ra Values received:', values);
                
                // Update door status from ESP32 Door Controller
                if (configDoorStatus && values[configDoorStatus.id]) {
                    doorStatusHandler.update(values[configDoorStatus.id].value);
                }

                // Update PIR motion from ESP32 Door Controller
                if (configPirMotion && values[configPirMotion.id]) {
                    motionHandler.update(values[configPirMotion.id].value);
                }

                // Update access log from ESP32 Door Controller
                if (configAccessLog && values[configAccessLog.id]) {
                    historyController.addEntry(values[configAccessLog.id].value);
                }

                // Update fingerprint list from ESP32 Door Controller
                if (configFingerprintList && values[configFingerprintList.id]) {
                    try {
                        const fpList = JSON.parse(values[configFingerprintList.id].value);
                        systemState.fingerprintList = fpList;
                        fingerprintController.updateList();
                    } catch (e) {
                        console.error('Fingerprint list parse error:', e);
                    }
                }

                // Update RFID list from ESP32 Door Controller
                if (configRfidList && values[configRfidList.id]) {
                    try {
                        const rfidList = JSON.parse(values[configRfidList.id].value);
                        systemState.rfidList = rfidList;
                        rfidController.updateList();
                    } catch (e) {
                        console.error('RFID list parse error:', e);
                    }
                }

                // Handle intruder alert from ESP32 Door Controller
                if (configIntruderAlert && values[configIntruderAlert.id]) {
                    if (values[configIntruderAlert.id].value == 1) {
                        alertManager.show('intruder-alert', '🚨 CẢNH BÁO: Phát hiện xâm nhập!', 'danger', 10000);
                    }
                }

                // Handle camera status from ESP32-CAM
                if (configCameraStatus && values[configCameraStatus.id]) {
                    const status = values[configCameraStatus.id].value;
                    const statusMap = {
                        0: 'Sẵn sàng',
                        1: 'Đang chụp',
                        2: 'Đã chụp',
                        3: 'Lỗi gửi ảnh',
                        4: 'Đã gửi email',
                        5: 'Lỗi email',
                        6: 'Lỗi chụp'
                    };
                    
                    const statusText = statusMap[status] || 'Không xác định';
                    document.getElementById('cameraStatus').innerHTML = `<i class="fas fa-camera"></i> ${statusText}`;
                }

                // Handle fingerprint result from ESP32 Door Controller (V11)
                if (configFingerprintResult && values[configFingerprintResult.id]) {
                    const result = values[configFingerprintResult.id].value;
                    
                    // Check if this is a number (fingerprint result) vs image size
                    if (typeof result === 'number' || !isNaN(result)) {
                        if (result > 0) {
                            // Existing fingerprint recognized
                            alertManager.show('fp-recognized', `✅ Vân tay được nhận dạng: ID ${result}`, 'success', 3000);
                            
                            const statusEl = document.getElementById('fingerprintScanStatus');
                            statusEl.textContent = `✅ Vân tay đã có! ID: ${result}`;
                            statusEl.style.background = 'var(--success-color)';
                            statusEl.style.color = 'white';
                            
                        } else if (result < 0) {
                            // New fingerprint detected, ready to enroll
                            const availableId = Math.abs(result);
                            systemState.currentVerifiedFingerprintId = availableId;
                            
                            document.getElementById('verifiedFingerprintId').value = availableId;
                            document.getElementById('fingerprintEnrollSection').style.display = 'block';
                            document.getElementById('fingerprintName').focus();
                            
                            const statusEl = document.getElementById('fingerprintScanStatus');
                            statusEl.textContent = `🆕 Vân tay mới! ID khả dụng: ${availableId}`;
                            statusEl.style.background = 'var(--warning-color)';
                            statusEl.style.color = 'white';
                            
                            alertManager.show('fp-new-detected', `🆕 Phát hiện vân tay mới! ID khả dụng: ${availableId}`, 'warning', 5000);
                        }
                    } else {
                        // This might be image size from ESP32-CAM, handle as camera data
                        console.log('Received image size from ESP32-CAM:', result);
                    }
                }

                // Handle RFID result from ESP32 Door Controller (V12)
                if (configRfidResult && values[configRfidResult.id]) {
                    const result = values[configRfidResult.id].value;
                    
                    // Check if this is a string (RFID result) vs chunk index
                    if (typeof result === 'string' && result.length > 2) {
                        if (result.startsWith('NEW:')) {
                            // New RFID card detected
                            const uid = result.substring(4);
                            systemState.currentScannedRfidUid = uid;
                            
                            document.getElementById('rfidUid').value = uid;
                            document.getElementById('rfidManagementSection').style.display = 'block';
                            document.getElementById('rfidCardName').focus();
                            
                            const statusEl = document.getElementById('rfidDetectionStatus');
                            statusEl.textContent = `💳 Thẻ mới! UID: ${uid}`;
                            statusEl.style.background = 'var(--warning-color)';
                            statusEl.style.color = 'white';
                            
                            alertManager.show('rfid-new-detected', `💳 Phát hiện thẻ RFID mới: ${uid}`, 'info', 5000);
                            
                        } else {
                            // Existing RFID card recognized
                            alertManager.show('rfid-recognized', `✅ Thẻ RFID được nhận dạng: ${result}`, 'success', 3000);
                            
                            const statusEl = document.getElementById('rfidDetectionStatus');
                            statusEl.textContent = `✅ Thẻ đã có! UID: ${result}`;
                            statusEl.style.background = 'var(--success-color)';
                            statusEl.style.color = 'white';
                        }
                    } else {
                        // This might be chunk index from ESP32-CAM, handle as camera data
                        console.log('Received chunk index from ESP32-CAM:', result);
                    }
                }

                // Handle camera image chunks from ESP32-CAM (V11=size, V12=index, V13=total)
                // Note: There's a conflict with V11, V12 from ESP32 Door Controller
                // In practice, you might need to use different Virtual Pins or device IDs to separate them
                if (configCameraImageSize && values[configCameraImageSize.id] && 
                    configCameraChunkIndex && values[configCameraChunkIndex.id] &&
                    configCameraChunkTotal && values[configCameraChunkTotal.id]) {
                    
                    const imageSize = values[configCameraImageSize.id].value;
                    const chunkIndex = values[configCameraChunkIndex.id].value;
                    const totalChunks = values[configCameraChunkTotal.id].value;
                    
                    cameraController.handleImageChunks(imageSize, chunkIndex, totalChunks);
                }
            }
        });

        // Utility Functions
        function switchTab(tab, button) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Smart Door Dashboard - E-Ra Platform Ready');
            
            // Initialize lists
            fingerprintController.updateList();
            rfidController.updateList();
            historyController.updateTable();
            
            // Set current date filter
            document.getElementById('filterDate').value = new Date().toISOString().split('T')[0];
            
            // Initial connection status
            connectionManager.updateStatus(false);
            
            // Welcome message
            setTimeout(() => {
                if (!systemState.isConnected) {
                    alertManager.show('initial-connecting', '🔗 Đang kết nối với ESP32...', 'info', 5000);
                } else {
                    alertManager.show('dashboard-ready', '✅ Dashboard sẵn sàng!', 'success', 3000);
                }
            }, 2000);
        });

        // Global access for debugging
        window.systemState = systemState;
        window.doorController = doorController;
        window.fingerprintController = fingerprintController;
        window.rfidController = rfidController;
        window.cameraController = cameraController;
        window.historyController = historyController;
        window.alertManager = alertManager;
    </script>
</body>
</html>
