<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Door Security Dashboard v5.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --background: #0a0e27;
            --surface: #151c3d;
            --surface-light: #1e2951;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --border: #2a3660;
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.2);
            --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Background Particles */
        .bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        /* FIXED Alert Container */
        #alertContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            width: 400px;
            max-width: calc(100vw - 40px);
            pointer-events: none;
        }

        #alertContainer .alert {
            pointer-events: all;
            margin-bottom: 10px;
            transform: translateX(100%);
            animation: slideInRight 0.3s ease forwards;
            padding: 16px 20px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--surface);
            border: 1px solid;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        @keyframes slideInRight {
            to { transform: translateX(0); }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: currentColor;
        }

        .alert-success { border-color: var(--success-color); color: var(--success-color); }
        .alert-warning { border-color: var(--warning-color); color: var(--warning-color); }
        .alert-danger { border-color: var(--danger-color); color: var(--danger-color); }
        .alert-info { border-color: var(--primary-color); color: var(--primary-color); }

        .alert-close {
            margin-left: auto;
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 20px;
            opacity: 0.7;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .alert-close:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            background: var(--surface);
            border: 1px solid var(--border);
            z-index: 1000;
        }

        .connection-status.connected {
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .connection-status.disconnected {
            color: var(--danger-color);
            border-color: var(--danger-color);
        }

        /* Security Status */
        .security-status {
            position: fixed;
            top: 70px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            background: var(--surface);
            border: 1px solid var(--border);
            z-index: 1000;
        }

        .security-status.armed {
            color: var(--success-color);
            border-color: var(--success-color);
        }

        .security-status.alert {
            color: var(--danger-color);
            border-color: var(--danger-color);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .dashboard-container {
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .dashboard-header h1 {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 12px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .dashboard-header p {
            font-size: 1.25rem;
            color: var(--text-secondary);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 28px;
            margin-bottom: 32px;
        }

        .card {
            background: var(--surface);
            border-radius: 24px;
            padding: 28px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.03) 0%, transparent 70%);
            transform: rotate(45deg);
            transition: all 0.4s ease;
            opacity: 0;
        }

        .card:hover {
            transform: translateY(-4px);
            border-color: var(--primary-color);
        }

        .card:hover::after {
            opacity: 1;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
        }

        .card-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            margin-right: 16px;
            position: relative;
        }

        .card-icon::after {
            content: '';
            position: absolute;
            inset: -2px;
            background: inherit;
            border-radius: 18px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover .card-icon::after {
            opacity: 0.3;
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.1); opacity: 0.6; }
        }

        .card-icon i {
            color: white;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Door Control */
        .door-control .card-icon {
            background: var(--gradient-success);
        }

        .door-visualization {
            width: 280px;
            height: 180px;
            margin: 24px auto;
            position: relative;
            perspective: 1200px;
        }

        .door-frame {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 12px;
            position: relative;
            border: 4px solid #2a3660;
            overflow: hidden;
        }

        .door-panel {
            width: 85%;
            height: 90%;
            background: var(--gradient-primary);
            position: absolute;
            top: 5%;
            left: 7.5%;
            border-radius: 8px;
            transition: transform 1.5s ease;
            transform-origin: left center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .door-panel::before {
            content: '';
            position: absolute;
            top: 20%;
            right: 10%;
            width: 30%;
            height: 60%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            border-radius: 8px;
        }

        .door-panel.open {
            transform: perspective(1200px) rotateY(-85deg) translateZ(30px);
            box-shadow: 8px 0 16px rgba(0, 0, 0, 0.4);
        }

        .door-handle {
            width: 14px;
            height: 40px;
            background: var(--gradient-warning);
            border-radius: 14px;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 
                0 4px 12px rgba(245, 158, 11, 0.4), 
                inset 0 2px 4px rgba(255, 255, 255, 0.3);
        }

        .door-status {
            margin: 20px 0;
            font-size: 1.35rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 16px 32px;
            border-radius: 20px;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .door-status::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.8s;
        }

        .door-status:hover::before {
            left: 100%;
        }

        .status-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-closed { 
            background: var(--gradient-danger);
            color: white;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }
        .status-closed .status-indicator { background: white; }

        .status-open { 
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        .status-open .status-indicator { background: white; }

        .status-opening, .status-closing { 
            background: var(--gradient-warning);
            color: white;
            animation: pulse-status 2s infinite;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }
        .status-opening .status-indicator, .status-closing .status-indicator { 
            background: white;
            animation: pulse 0.5s infinite; 
        }

        @keyframes pulse-status {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }

        .control-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
            position: relative;
            overflow: hidden;
            user-select: none;
            z-index: 10;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.6s;
        }

        .btn:not(:disabled):hover::before {
            left: 100%;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: var(--gradient-warning);
            color: white;
            box-shadow: 0 4px 14px rgba(245, 158, 11, 0.3);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
        }

        .btn:active:not(:disabled) {
            transform: translateY(-1px) scale(0.98);
        }

        /* Tries Remaining Indicator */
        .tries-remaining {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 16px 0;
            padding: 12px 20px;
            border-radius: 12px;
            background: var(--surface-light);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .tries-remaining.warning {
            border-color: var(--warning-color);
            background: rgba(245, 158, 11, 0.1);
        }

        .tries-remaining.danger {
            border-color: var(--danger-color);
            background: rgba(239, 68, 68, 0.1);
            animation: pulse 1s infinite;
        }

        .tries-count {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .tries-count.warning {
            color: var(--warning-color);
        }

        .tries-count.danger {
            color: var(--danger-color);
        }

        /* Access Management - RFID Only */
        .access-management .card-icon {
            background: var(--gradient-primary);
        }

        .section {
            background: var(--background);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            position: relative;
            z-index: 100;
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
        }

        .section-header strong {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .input-group {
            margin-bottom: 20px;
            position: relative;
            z-index: 1000;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .input-field {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
            pointer-events: auto !important;
            z-index: 1000;
            position: relative;
            cursor: text;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .input-field::placeholder {
            color: var(--text-secondary);
        }

        .scan-section, .detect-section {
            border: 2px dashed var(--border);
            background: rgba(30, 41, 81, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .scan-section.scanning, .detect-section.detecting {
            border-color: var(--primary-color);
            animation: scanPulse 1.5s infinite;
        }

        .scan-section.locked, .detect-section.locked {
            border-color: var(--danger-color);
            background: rgba(239, 68, 68, 0.1);
        }

        @keyframes scanPulse {
            0%, 100% { 
                border-color: var(--primary-color);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
            }
            50% { 
                border-color: #60a5fa;
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
        }

        .rfid-status {
            margin: 12px 0;
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            background: var(--surface-light);
            font-weight: 500;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .rfid-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--surface);
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .list-item {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
        }

        .list-item:hover {
            background: var(--surface-light);
        }

        .list-item:last-child {
            border-bottom: none;
        }

        .list-item-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .list-item-info i {
            color: var(--primary-color);
            font-size: 18px;
        }

        .delete-btn {
            padding: 6px 14px;
            background: var(--gradient-danger);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .delete-btn:hover {
            transform: scale(1.05);
        }

        /* Camera Section */
        .camera-section .card-icon {
            background: var(--gradient-danger);
        }

        .camera-container {
            position: relative;
            margin-bottom: 20px;
        }

        .camera-status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: var(--surface-light);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .camera-status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .camera-status-indicator.online {
            color: var(--success-color);
        }

        .camera-status-indicator.offline {
            color: var(--danger-color);
        }

        .camera-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .camera-status-dot.online {
            background: var(--success-color);
        }

        .camera-status-dot.offline {
            background: var(--danger-color);
        }

        .camera-ip-display {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 4px 8px;
            background: var(--background);
            border-radius: 6px;
        }

        .security-radar {
            width: 100%;
            height: 240px;
            position: relative;
            background: radial-gradient(circle at center, rgba(30, 41, 81, 0.9) 0%, rgba(10, 14, 39, 1) 100%);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
        }

        .security-radar:hover {
            transform: scale(1.02);
            border: 2px solid rgba(59, 130, 246, 0.5);
        }

        .security-radar::after {
            content: 'Click to test motion detection';
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .security-radar:hover::after {
            opacity: 1;
        }

        .radar-container {
            width: 200px;
            height: 200px;
            position: relative;
        }

        .radar-circle {
            position: absolute;
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .radar-circle:nth-child(1) { width: 200px; height: 200px; }
        .radar-circle:nth-child(2) { width: 150px; height: 150px; }
        .radar-circle:nth-child(3) { width: 100px; height: 100px; }
        .radar-circle:nth-child(4) { width: 50px; height: 50px; }

        .radar-sweep {
            position: absolute;
            width: 100%;
            height: 100%;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                rgba(59, 130, 246, 0.8) 10deg,
                rgba(59, 130, 246, 0.4) 30deg,
                transparent 60deg
            );
            animation: radarSweep 4s linear infinite;
            border-radius: 50%;
        }

        .radar-sweep.scanning {
            animation-duration: 1s;
            background: conic-gradient(
                from 0deg,
                transparent 0deg,
                rgba(245, 158, 11, 0.8) 10deg,
                rgba(245, 158, 11, 0.4) 30deg,
                transparent 60deg
            );
        }

        @keyframes radarSweep {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .radar-center {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 30px var(--primary-color);
            animation: center-pulse 3s ease-in-out infinite;
        }

        @keyframes center-pulse {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 30px var(--primary-color);
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.3);
                box-shadow: 0 0 50px var(--primary-color);
            }
        }

        .motion-targets {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .motion-targets.motion-active {
            opacity: 1;
        }

        .motion-dot {
            position: absolute;
            width: 12px;
            height: 12px;
            background: radial-gradient(circle, var(--danger-color) 0%, #dc2626 100%);
            border-radius: 50%;
            box-shadow: 
                0 0 25px var(--danger-color),
                inset 0 0 10px rgba(255, 255, 255, 0.3);
            animation: target-ping 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        .motion-dot:nth-child(1) { top: 25%; right: 30%; }
        .motion-dot:nth-child(2) { top: 40%; left: 20%; animation-delay: 0.4s; }
        .motion-dot:nth-child(3) { bottom: 35%; right: 25%; animation-delay: 0.8s; }

        @keyframes target-ping {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(2);
                opacity: 0.5;
            }
            100% {
                transform: scale(3);
                opacity: 0;
            }
        }

        .motion-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            border-radius: 24px;
            font-weight: 600;
            margin: 16px auto;
            width: fit-content;
            transition: all 0.3s ease;
        }

        .motion-indicator-container {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .motion-detected {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
            border: 2px solid var(--danger-color);
            animation: alertPulse 1s ease-out infinite;
        }

        @keyframes alertPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .motion-clear {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
            border: 2px solid var(--success-color);
        }

        /* FIXED Camera Feed - Always streaming */
        .camera-feed {
            width: 100%;
            height: 240px;
            background: var(--surface);
            border-radius: 16px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--success-color);
            overflow: hidden;
            position: relative;
        }

        .camera-feed.loading {
            border-color: var(--primary-color);
            animation: scanPulse 1.5s infinite;
        }

        .camera-placeholder {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
        }

        .camera-placeholder i {
            font-size: 56px;
            margin-bottom: 16px;
            color: var(--primary-color);
            opacity: 0.6;
        }

        .camera-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 14px;
        }

        .camera-stream {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 14px;
        }

        /* History Section */
        .history-section {
            grid-column: 1 / -1;
        }

        .history-section .card-icon {
            background: var(--gradient-warning);
        }

        .history-filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            flex: 1;
            min-width: 150px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* FIXED Date input styling */
        .filter-select, .filter-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--background);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-input[type="date"] {
            color-scheme: dark;
        }

        .filter-input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .history-table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--background);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            background: var(--surface-light);
            padding: 16px;
            text-align: left;
            font-weight: 700;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border);
        }

        .history-table td {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .history-table tr:hover td {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        .method-badge, .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .method-rfid {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .method-motion {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning-color);
        }

        .status-success {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
        }

        .status-failed {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger-color);
        }

        .action-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning-color);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* System locked state */
        .system-locked {
            opacity: 0.6;
            pointer-events: none;
        }

        .lockout-message {
            text-align: center;
            padding: 20px;
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--danger-color);
            border-radius: 12px;
            color: var(--danger-color);
            font-weight: 600;
            margin: 16px 0;
            animation: pulse 1s infinite;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                padding: 16px;
            }

            .dashboard-header h1 {
                font-size: 2rem;
                flex-direction: column;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .control-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            #alertContainer {
                width: calc(100vw - 40px);
            }

            .security-radar {
                height: 180px;
            }

            .radar-container {
                width: 150px;
                height: 150px;
            }

            .camera-status-bar {
                flex-direction: column;
                gap: 8px;
            }
        }

        /* Enhanced styling for user interaction elements */
        .enroll-section,
        .scan-controls,
        .user-list-section {
            position: relative;
            z-index: 100;
        }

        /* Ensure form elements are always interactive */
        .form-group {
            position: relative;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <!-- Background Particles -->
    <div class="bg-particles" id="particles"></div>

    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <!-- Connection Status -->
    <div class="connection-status disconnected" id="connectionStatus">
        <i class="fas fa-circle"></i>
        <span>Test Mode</span>
    </div>

    <!-- Security Status -->
    <div class="security-status armed" id="securityStatus">
        <i class="fas fa-shield-alt"></i>
        <span>System Armed</span>
    </div>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <h1><i class="fas fa-door-open"></i> Smart Door Security v5.0</h1>
            <p>Hệ thống cửa thông minh với RFID & Camera Streaming - RFID Only Version</p>
        </div>

        <div class="dashboard-grid">
            <!-- Door Control -->
            <div class="card door-control">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-door-open"></i></div>
                    <div class="card-title">Điều Khiển Cửa</div>
                </div>
                
                <div class="door-visualization">
                    <div class="door-frame">
                        <div class="door-panel" id="doorPanel">
                            <div class="door-handle"></div>
                        </div>
                    </div>
                </div>
                
                <div class="door-status status-closed" id="doorStatus">
                    <span class="status-indicator"></span>
                    <span id="doorStatusText">Đóng</span>
                </div>
                
                <div class="control-buttons">
                    <button class="btn btn-success" id="btn-open">
                        <i class="fas fa-unlock"></i>
                        <span>Mở Cửa</span>
                    </button>
                    <button class="btn btn-danger" id="btn-close">
                        <i class="fas fa-lock"></i>
                        <span>Đóng Cửa</span>
                    </button>
                </div>
            </div>

            <!-- Access Management - RFID Only -->
            <div class="card access-management">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-id-card"></i></div>
                    <div class="card-title">Quản Lý Thẻ RFID</div>
                </div>

                <!-- Tries Remaining Display -->
                <div class="tries-remaining" id="triesRemaining">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Còn lại <span class="tries-count" id="triesCount">3</span> lần thử</span>
                </div>

                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-plus-circle"></i>
                        <strong>Thêm thẻ RFID mới</strong>
                    </div>
                    
                    <div class="input-group">
                        <label>UID Thẻ RFID:</label>
                        <input type="text" class="input-field" id="rfid-uid" placeholder="Nhập UID thẻ (hoặc quét thẻ)">
                    </div>
                    <div class="input-group">
                        <label>Tên chủ thẻ:</label>
                        <input type="text" class="input-field" id="rfid-name" placeholder="Nhập tên">
                    </div>
                    
                    <button class="btn btn-success" id="btn-rfid-add" style="width: 100%;">
                        <i class="fas fa-plus"></i>
                        <span>Thêm Thẻ</span>
                    </button>
                </div>

                <div class="section">
                    <div class="section-header">
                        <i class="fas fa-wifi"></i>
                        <strong>Quét thẻ RFID</strong>
                    </div>
                    
                    <div class="detect-section" id="rfidDetectSection">
                        <div class="rfid-status" id="rfidDetectionStatus">
                            Nhấn nút để bắt đầu quét thẻ RFID
                        </div>
                        
                        <button class="btn btn-primary" id="btn-rfid-scan" style="width: 100%; margin-top: 12px;">
                            <i class="fas fa-id-card"></i>
                            <span>Bắt Đầu Quét</span>
                        </button>
                        <button class="btn btn-danger" id="btn-rfid-stop" style="display: none; width: 100%; margin-top: 12px;">
                            <i class="fas fa-stop"></i>
                            <span>Dừng Quét</span>
                        </button>
                    </div>

                    <div id="rfid-result" class="result-display" style="margin-top: 16px;"></div>
                </div>
                
                <!-- RFID List -->
                <div style="margin-top: 20px;">
                    <div style="margin-bottom: 12px; font-weight: 600; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center;">
                        <span><i class="fas fa-list"></i> Danh sách thẻ RFID đã lưu:</span>
                        <button class="btn btn-warning" style="padding: 6px 12px; font-size: 12px;" id="btn-rfid-clear">
                            <i class="fas fa-trash"></i> Xóa tất cả
                        </button>
                    </div>
                    
                    <div class="rfid-list" id="rfid-table">
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            <i class="fas fa-id-card" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                            <p>Chưa có thẻ RFID nào được lưu</p>
                        </div>
                    </div>
                </div>

                <!-- Lockout Message (hidden by default) -->
                <div class="lockout-message" id="lockoutMessage" style="display: none;">
                    <i class="fas fa-lock"></i>
                    <strong>Hệ thống đã bị khóa!</strong><br>
                    Quá số lần thử cho phép. Vui lòng đợi hoặc liên hệ quản trị viên.
                </div>
            </div>

            <!-- Camera Section - Always Streaming -->
            <div class="card camera-section">
                <div class="card-header">
                    <div class="card-icon"><i class="fas fa-video"></i></div>
                    <div class="card-title">Camera An Ninh (Live Stream)</div>
                </div>

                <!-- Camera Status Bar -->
                <div class="camera-status-bar">
                    <div class="camera-status-indicator offline" id="cameraStatusIndicator">
                        <div class="camera-status-dot offline"></div>
                        <span id="cameraStatusText">Camera Offline</span>
                    </div>
                    <div class="camera-ip-display" id="cameraIpDisplay">
                        Stream: Chờ kết nối...
                    </div>
                </div>

                <div class="security-radar" id="security-radar">
                    <div class="radar-container">
                        <div class="radar-circle"></div>
                        <div class="radar-circle"></div>
                        <div class="radar-circle"></div>
                        <div class="radar-circle"></div>
                        <div class="radar-sweep" id="radar-sweep"></div>
                        <div class="radar-center"></div>
                        <div class="motion-targets">
                            <div class="motion-dot"></div>
                            <div class="motion-dot"></div>
                            <div class="motion-dot"></div>
                        </div>
                    </div>
                </div>

                <div class="motion-indicator-container">
                    <div class="motion-indicator motion-clear" id="motionIndicator">
                        <i class="fas fa-shield-alt"></i>
                        <span id="motionText">Không có chuyển động</span>
                    </div>
                </div>

                <!-- Always-on Camera Stream -->
                <div class="camera-feed" id="cameraFeed">
                    <div class="camera-placeholder">
                        <i class="fas fa-video"></i>
                        <div>Live Stream sẽ hiển thị khi camera kết nối</div>
                        <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">
                            Tự động chụp ảnh và gửi email khi có chuyển động
                        </div>
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="btn btn-primary" id="btn-capture">
                        <i class="fas fa-camera"></i>
                        <span>Chụp Thủ Công</span>
                    </button>
                    <button class="btn btn-success" id="btn-refresh-stream">
                        <i class="fas fa-sync"></i>
                        <span>Làm Mới Stream</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="card history-section">
            <div class="card-header">
                <div class="card-icon"><i class="fas fa-history"></i></div>
                <div class="card-title">Lịch Sử Truy Cập</div>
            </div>

            <div class="history-filters">
                <div class="filter-group">
                    <label>Ngày:</label>
                    <input type="date" class="filter-input" id="filterDate">
                </div>
                <div class="filter-group">
                    <label>Phương thức:</label>
                    <select class="filter-select" id="filterMethod">
                        <option value="">Tất cả</option>
                        <option value="rfid">Thẻ RFID</option>
                        <option value="motion">Cảm biến</option>
                        <option value="manual">Thủ công</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Kết quả:</label>
                    <select class="filter-select" id="filterResult">
                        <option value="">Tất cả</option>
                        <option value="success">Thành công</option>
                        <option value="failed">Thất bại</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" id="btn-filter">
                        <i class="fas fa-filter"></i>
                        <span>Lọc</span>
                    </button>
                </div>
            </div>

            <div class="history-table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Thời gian</th>
                            <th>Phương thức</th>
                            <th>UID/ID</th>
                            <th>Tên</th>
                            <th>Kết quả</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td>2025-06-17 14:30:25</td>
                            <td>
                                <span class="method-badge method-rfid">
                                    <i class="fas fa-id-card"></i>
                                    RFID
                                </span>
                            </td>
                            <td><code>A1B2C3D4</code></td>
                            <td>John Doe</td>
                            <td><span class="status-badge status-success"><i class="fas fa-check"></i> Thành công</span></td>
                            <td><span class="action-badge">Mở cửa</span></td>
                        </tr>
                        <tr>
                            <td>2025-06-17 14:25:12</td>
                            <td>
                                <span class="method-badge method-rfid">
                                    <i class="fas fa-id-card"></i>
                                    RFID
                                </span>
                            </td>
                            <td><code>E5F6G7H8</code></td>
                            <td>Jane Smith</td>
                            <td><span class="status-badge status-success"><i class="fas fa-check"></i> Thành công</span></td>
                            <td><span class="action-badge">Mở cửa</span></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- E-Ra Widget Script -->
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
    
    <script>
        // Create background particles
        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Initialize particles
        createParticles();

        // Initialize EraWidget
        const eraWidget = new EraWidget();
        
        // Configuration variables - UPDATED FOR AUTO IP DETECTION
        let config = {
            doorStatus: null,        // V0
            motionStatus: null,      // V2
            rfidResult: null,        // V4
            rfidList: null,          // V5
            triesRemaining: null,    // V6
            camStatus: null,         // V7
            camIP: null              // V11 - Auto IP detection
        };
        
        let actions = {
            closeDoor: null,         // V1=0
            openDoor: null,          // V1=1
            rfidScan: null,          // V3=1
            rfidStop: null,          // V3=2
            rfidAdd: null,           // V3=3
            rfidRemove: null,        // V3=4
            cameraCapture: null,     // V8=1
            // V9 and V10 are for payload
        };

        // System State
        let systemState = {
            doorStatus: 'closed',
            motionDetected: false,
            rfidList: [],
            accessHistory: [],
            isConnected: false,
            triesRemaining: 3,
            isSystemLocked: false,
            cameraOnline: false,
            cameraStreamUrl: '',
            isStreaming: false,
            operationTimeouts: new Map()
        };

        // DOM Elements
        const elements = {
            doorPanel: document.getElementById('doorPanel'),
            doorStatus: document.getElementById('doorStatus'),
            doorStatusText: document.getElementById('doorStatusText'),
            btnOpen: document.getElementById('btn-open'),
            btnClose: document.getElementById('btn-close'),
            motionIndicator: document.getElementById('motionIndicator'),
            motionText: document.getElementById('motionText'),
            radarSweep: document.getElementById('radar-sweep'),
            securityRadar: document.getElementById('security-radar'),
            securityStatus: document.getElementById('securityStatus'),
            cameraFeed: document.getElementById('cameraFeed'),
            cameraStatusIndicator: document.getElementById('cameraStatusIndicator'),
            cameraStatusText: document.getElementById('cameraStatusText'),
            cameraIpDisplay: document.getElementById('cameraIpDisplay'),
            btnCapture: document.getElementById('btn-capture'),
            btnRefreshStream: document.getElementById('btn-refresh-stream'),
            rfidDetectionStatus: document.getElementById('rfidDetectionStatus'),
            rfidTable: document.getElementById('rfid-table'),
            btnRfidScan: document.getElementById('btn-rfid-scan'),
            btnRfidStop: document.getElementById('btn-rfid-stop'),
            btnRfidAdd: document.getElementById('btn-rfid-add'),
            rfidUidInput: document.getElementById('rfid-uid'),
            rfidNameInput: document.getElementById('rfid-name'),
            rfidResult: document.getElementById('rfid-result'),
            historyTableBody: document.getElementById('historyTableBody'),
            triesRemaining: document.getElementById('triesRemaining'),
            triesCount: document.getElementById('triesCount'),
            lockoutMessage: document.getElementById('lockoutMessage'),
            connectionStatus: document.getElementById('connectionStatus'),
            filterDate: document.getElementById('filterDate'),
            filterMethod: document.getElementById('filterMethod'),
            filterResult: document.getElementById('filterResult'),
            btnFilter: document.getElementById('btn-filter')
        };

        // FIXED Alert Manager
        const alertManager = {
            alerts: new Map(),
            nextId: 1,
            
            show(id, message, type = 'success', timeout = 5000) {
                // Use unique ID if not provided
                if (!id) {
                    id = `alert_${this.nextId++}`;
                }
                
                this.remove(id);
                
                const container = document.getElementById('alertContainer');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.id = `alert-${id}`;
                alert.innerHTML = `
                    <i class="fas fa-${this.getIcon(type)}"></i>
                    <span>${message}</span>
                    <button class="alert-close" data-alert-id="${id}">×</button>
                `;
                
                // Add click event to close button
                const closeBtn = alert.querySelector('.alert-close');
                closeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const alertId = e.target.getAttribute('data-alert-id');
                    this.remove(alertId);
                });
                
                container.appendChild(alert);
                this.alerts.set(id, alert);
                
                if (timeout > 0) {
                    setTimeout(() => this.remove(id), timeout);
                }
                
                return id;
            },
            
            getIcon(type) {
                const icons = {
                    success: 'check-circle',
                    warning: 'exclamation-triangle',
                    danger: 'exclamation-circle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            },
            
            remove(id) {
                const alert = this.alerts.get(id);
                if (alert && alert.parentElement) {
                    alert.style.animation = 'slideOutRight 0.3s ease forwards';
                    setTimeout(() => {
                        if (alert.parentElement) {
                            alert.remove();
                        }
                        this.alerts.delete(id);
                    }, 300);
                }
            },
            
            clear() {
                this.alerts.forEach((alert, id) => this.remove(id));
            }
        };

        // Initialize EraWidget with RFID ONLY CONFIG
        eraWidget.init({
            onConfiguration: (configuration) => {
                console.log('Configuration received:', configuration);
                
                // Map realtime configs - AUTO IP DETECTION VERSION
                config.doorStatus = configuration.realtime_configs[0];      // V0
                config.motionStatus = configuration.realtime_configs[1];    // V2  
                config.rfidResult = configuration.realtime_configs[2];      // V4
                config.rfidList = configuration.realtime_configs[3];        // V5
                config.triesRemaining = configuration.realtime_configs[4];  // V6
                config.camStatus = configuration.realtime_configs[5];       // V7
                config.camIP = configuration.realtime_configs[6];           // V11 - Camera IP
                
                // Map actions - RFID ONLY VERSION
                actions.closeDoor = configuration.actions[0];        // V1=0
                actions.openDoor = configuration.actions[1];         // V1=1
                actions.rfidScan = configuration.actions[2];         // V3=1
                actions.rfidStop = configuration.actions[3];         // V3=2
                actions.rfidAdd = configuration.actions[4];          // V3=3
                actions.rfidRemove = configuration.actions[5];       // V3=4
                actions.cameraCapture = configuration.actions[6];    // V8=1
                
                // Update connection status
                elements.connectionStatus.className = 'connection-status connected';
                elements.connectionStatus.innerHTML = '<i class="fas fa-circle"></i><span>E-Ra Connected</span>';
                systemState.isConnected = true;
                
                // Bind event listeners
                bindEventListeners();
                
                // Initialize UI
                initializeUI();
                
                alertManager.show('config-loaded', '🚀 E-Ra cấu hình đã tải thành công!', 'success');
            },
            
            onValues: (values) => {
                console.log('Values received:', values);
                updateUI(values);
            },
            
            onConnected: () => {
                elements.connectionStatus.className = 'connection-status connected';
                elements.connectionStatus.innerHTML = '<i class="fas fa-circle"></i><span>E-Ra Connected</span>';
                systemState.isConnected = true;
                alertManager.show('era-connected', '✅ Kết nối E-Ra thành công!', 'success');
            },
            
            onDisconnected: () => {
                elements.connectionStatus.className = 'connection-status disconnected';
                elements.connectionStatus.innerHTML = '<i class="fas fa-circle"></i><span>E-Ra Disconnected</span>';
                systemState.isConnected = false;
                alertManager.show('era-disconnected', '❌ Mất kết nối E-Ra!', 'danger');
            }
        });

        // Enhanced Operation Timeout Manager
        const operationManager = {
            timeouts: new Map(),
            
            startOperation(operationType, timeoutMs = 30000) {
                this.clearOperation(operationType);
                
                const timeoutId = setTimeout(() => {
                    this.handleTimeout(operationType);
                }, timeoutMs);
                
                this.timeouts.set(operationType, timeoutId);
            },
            
            clearOperation(operationType) {
                const timeoutId = this.timeouts.get(operationType);
                if (timeoutId) {
                    clearTimeout(timeoutId);
                    this.timeouts.delete(operationType);
                }
            },
            
            handleTimeout(operationType) {
                switch (operationType) {
                    case 'rfidScan':
                        alertManager.show('rfid-timeout', '⏰ Quét RFID timeout!', 'warning');
                        resetRfidScanButton();
                        break;
                    case 'doorOperation':
                        alertManager.show('door-timeout', '⏰ Thao tác cửa timeout!', 'warning');
                        break;
                    case 'cameraCapture':
                        alertManager.show('camera-timeout', '⏰ Chụp ảnh timeout!', 'warning');
                        resetCaptureButton();
                        break;
                }
                this.clearOperation(operationType);
            }
        };

        // Bind event listeners with RFID ONLY INTEGRATION
        function bindEventListeners() {
            // Door controls with timeout management
            elements.btnOpen.onclick = (e) => {
                e.preventDefault();
                if (systemState.isSystemLocked) return;
                
                operationManager.startOperation('doorOperation', 15000);
                
                if (actions.openDoor) {
                    eraWidget.triggerAction(actions.openDoor.action, 1);
                } else {
                    // Test mode - simulate door opening
                    updateDoorStatus(2); // Opening
                    setTimeout(() => {
                        updateDoorStatus(1); // Open
                        operationManager.clearOperation('doorOperation');
                    }, 2000);
                }
                alertManager.show(null, '🔓 Đang mở cửa...', 'info');
            };
            
            elements.btnClose.onclick = (e) => {
                e.preventDefault();
                if (systemState.isSystemLocked) return;
                
                operationManager.startOperation('doorOperation', 15000);
                
                if (actions.closeDoor) {
                    eraWidget.triggerAction(actions.closeDoor.action, 0);
                } else {
                    // Test mode - simulate door closing
                    updateDoorStatus(3); // Closing
                    setTimeout(() => {
                        updateDoorStatus(0); // Closed
                        operationManager.clearOperation('doorOperation');
                    }, 2000);
                }
                alertManager.show(null, '🔒 Đang đóng cửa...', 'info');
            };
            
            // RFID controls with PAYLOAD INTEGRATION
            elements.btnRfidScan.onclick = (e) => {
                e.preventDefault();
                if (systemState.isSystemLocked) return;
                
                operationManager.startOperation('rfidScan', 30000);
                
                if (actions.rfidScan) {
                    eraWidget.triggerAction(actions.rfidScan.action, 1);
                } else {
                    // Test mode with realistic simulation
                    elements.rfidDetectionStatus.textContent = 'Test mode - đang quét thẻ RFID...';
                    elements.rfidDetectionStatus.style.background = 'var(--primary-color)';
                    elements.rfidDetectionStatus.style.color = 'white';
                    
                    setTimeout(() => {
                        const testResults = [
                            { uid: 'A1B2C3D4', name: 'John Doe', success: true },
                            { uid: 'E5F6G7H8', name: 'Jane Smith', success: true },
                            { uid: '12345678', name: 'Unknown', success: false },
                            { uid: 'ABCD1234', name: 'Test User', success: true }
                        ];
                        const result = testResults[Math.floor(Math.random() * testResults.length)];
                        
                        if (result.success && systemState.rfidList.find(card => card.uid === result.uid)) {
                            updateRfidResult(1, result); // success
                        } else {
                            updateRfidResult(-1, result); // unknown
                        }
                        operationManager.clearOperation('rfidScan');
                    }, 3000);
                }
                
                alertManager.show(null, '🎫 Bắt đầu quét RFID!', 'success');
                elements.btnRfidScan.innerHTML = '<div class="loading"></div> Đang quét...';
                elements.btnRfidScan.disabled = true;
                elements.btnRfidStop.style.display = 'inline-flex';
                document.getElementById('rfidDetectSection').classList.add('detecting');
            };
            
            elements.btnRfidStop.onclick = (e) => {
                e.preventDefault();
                operationManager.clearOperation('rfidScan');
                
                if (actions.rfidStop) {
                    eraWidget.triggerAction(actions.rfidStop.action, 2);
                } else {
                    updateRfidResult(0); // stopped
                }
                alertManager.show(null, '⏹️ Dừng quét RFID', 'warning');
                resetRfidScanButton();
            };
            
            elements.btnRfidAdd.onclick = (e) => {
                e.preventDefault();
                if (systemState.isSystemLocked) return;
                
                const uid = elements.rfidUidInput.value.trim().toUpperCase();
                const name = elements.rfidNameInput.value.trim();
                
                if (!uid || !name) {
                    alertManager.show(null, '❌ Vui lòng nhập đầy đủ thông tin', 'danger');
                    return;
                }
                
                if (systemState.rfidList.find(c => c.uid === uid)) {
                    alertManager.show(null, '❌ UID thẻ đã tồn tại!', 'danger');
                    return;
                }
                
                if (actions.rfidAdd) {
                    // PAYLOAD INTEGRATION - Send data before adding
                    eraWidget.send(9, uid);    // V9 - payloadID (UID for RFID)
                    eraWidget.send(10, name);   // V10 - payloadName
                    
                    setTimeout(() => {
                        eraWidget.triggerAction(actions.rfidAdd.action, 3);
                    }, 100); // Small delay to ensure payload is sent
                } else {
                    // Test mode - add to table
                    const newCard = { uid: uid, name: name };
                    systemState.rfidList.push(newCard);
                    updateRfidList();
                }
                
                alertManager.show(null, `🎫 Đã thêm thẻ RFID: ${name}`, 'success');
                
                // Clear inputs
                elements.rfidUidInput.value = '';
                elements.rfidNameInput.value = '';
            };
            
            // Camera controls with ENHANCED INTEGRATION
            elements.btnCapture.onclick = (e) => {
                e.preventDefault();
                operationManager.startOperation('cameraCapture', 10000);
                
                if (actions.cameraCapture) {
                    eraWidget.triggerAction(actions.cameraCapture.action, 1);
                } else {
                    // Test mode - simulate capture
                    setTimeout(() => {
                        alertManager.show(null, '📸 Test mode - đã chụp ảnh và gửi email!', 'success');
                        operationManager.clearOperation('cameraCapture');
                        resetCaptureButton();
                    }, 3000);
                }
                
                alertManager.show(null, '📸 Đang chụp ảnh và gửi email...', 'info');
                elements.btnCapture.innerHTML = '<div class="loading"></div> Đang chụp...';
                elements.btnCapture.disabled = true;
            };
            
            // Camera stream refresh
            elements.btnRefreshStream.onclick = (e) => {
                e.preventDefault();
                refreshCameraStream();
            };
            
            // Motion detection test (click on radar)
            elements.securityRadar.onclick = () => {
                const motionTargets = document.querySelector('.motion-targets');
                const isCurrentlyDetected = motionTargets.classList.contains('motion-active');
                updateMotionStatus(!isCurrentlyDetected);
                
                if (!isCurrentlyDetected) {
                    // Auto reset after 5 seconds
                    setTimeout(() => updateMotionStatus(false), 5000);
                }
            };
            
            // Clear buttons with confirmation
            document.getElementById('btn-rfid-clear').onclick = () => {
                if (systemState.isSystemLocked) return;
                if (confirm('Xác nhận xóa tất cả thẻ RFID? Hành động này không thể hoàn tác!')) {
                    systemState.rfidList = [];
                    updateRfidList();
                    alertManager.show(null, '🗑️ Đã xóa tất cả thẻ RFID', 'warning');
                    
                    // Send clear signal to Arduino if connected
                    if (systemState.isConnected) {
                        // Could implement a clear all function in Arduino
                    }
                }
            };
            
            // FIXED Filter button
            elements.btnFilter.onclick = () => {
                const date = elements.filterDate.value;
                const method = elements.filterMethod.value;
                const result = elements.filterResult.value;
                applyHistoryFilter(date, method, result);
                alertManager.show(null, '🔍 Đã áp dụng bộ lọc', 'info');
            };
            
            // FIXED Date input change listener
            elements.filterDate.addEventListener('change', () => {
                const selectedDate = elements.filterDate.value;
                if (selectedDate) {
                    alertManager.show(null, `📅 Đã chọn ngày: ${selectedDate}`, 'info', 2000);
                    // Auto apply filter when date changes
                    const method = elements.filterMethod.value;
                    const result = elements.filterResult.value;
                    applyHistoryFilter(selectedDate, method, result);
                }
            });
        }

        // Camera stream management for always-on streaming
        function refreshCameraStream() {
            if (!systemState.cameraOnline) {
                alertManager.show(null, '❌ Camera không trực tuyến!', 'danger');
                return;
            }
            
            const streamUrl = systemState.cameraStreamUrl || 'http://192.168.1.100/stream';
            
            elements.cameraFeed.classList.add('loading');
            elements.btnRefreshStream.innerHTML = '<div class="loading"></div> Đang kết nối...';
            elements.btnRefreshStream.disabled = true;
            
            // Create new stream
            elements.cameraFeed.innerHTML = `
                <img class="camera-stream" src="${streamUrl}?t=${Date.now()}" 
                     alt="Camera Stream" 
                     onerror="handleStreamError(this)"
                     onload="handleStreamSuccess(this)">
            `;
            
            setTimeout(() => {
                elements.btnRefreshStream.innerHTML = '<i class="fas fa-sync"></i><span>Làm Mới Stream</span>';
                elements.btnRefreshStream.disabled = false;
            }, 3000);
        }
        
        // Global functions for stream handling
        window.handleStreamError = function(img) {
            console.error('Stream error');
            elements.cameraFeed.classList.remove('loading');
            elements.cameraFeed.innerHTML = `
                <div class="camera-placeholder">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div>Không thể kết nối camera stream</div>
                    <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">
                        Kiểm tra kết nối ESP32-CAM và nhấn "Làm Mới Stream"
                    </div>
                </div>
            `;
            
            alertManager.show(null, '❌ Lỗi kết nối camera stream!', 'danger');
        };
        
        window.handleStreamSuccess = function(img) {
            console.log('Stream connected successfully');
            systemState.isStreaming = true;
            elements.cameraFeed.classList.remove('loading');
            alertManager.show(null, '📺 Camera stream đã kết nối!', 'success');
        };

        // Initialize UI with COMPLETE SETUP
        function initializeUI() {
            // Initialize motion detector
            updateMotionStatus(false);
            
            // Initialize door status
            updateDoorStatus(0); // Closed by default
            
            // Initialize tries remaining
            updateTriesRemaining(3);
            
            // Initialize camera status
            updateCameraStatus(false);
            
            // Enable all controls for testing
            document.querySelectorAll('.btn').forEach(btn => {
                btn.disabled = false;
                btn.style.pointerEvents = 'auto';
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });
            
            document.querySelectorAll('.input-field').forEach(input => {
                input.disabled = false;
                input.removeAttribute('disabled');
                input.style.pointerEvents = 'auto';
                input.style.opacity = '1';
                input.style.cursor = 'text';
                input.readOnly = false;
                input.tabIndex = 0;
            });
            
            // Initialize lists with demo data
            systemState.rfidList = [
                { uid: 'A1B2C3D4', name: 'John Doe' },
                { uid: 'E5F6G7H8', name: 'Jane Smith' }
            ];
            
            updateRfidList();
            
            // Set today's date
            const today = new Date();
            const todayString = today.getFullYear() + '-' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(today.getDate()).padStart(2, '0');
            elements.filterDate.value = todayString;
            
            // 🆕 Wait for ESP32-CAM to send IP automatically (no hardcode)
            elements.cameraIpDisplay.textContent = 'Stream: Chờ ESP32-CAM kết nối...';
            updateCameraStatus(false); // Start as offline, wait for auto-detection
            
            alertManager.show(null, '🎉 Dashboard sẵn sàng! (Auto IP Detection)', 'success');
        }

        // Update UI based on received values with AUTO IP DETECTION
        function updateUI(values) {
            // Update door status
            if (config.doorStatus && values[config.doorStatus.id]) {
                const doorValue = values[config.doorStatus.id].value;
                updateDoorStatus(doorValue);
                operationManager.clearOperation('doorOperation');
            }
            
            // Update motion status
            if (config.motionStatus && values[config.motionStatus.id]) {
                const motionValue = values[config.motionStatus.id].value;
                updateMotionStatus(motionValue === 1);
            }
            
            // Update RFID result
            if (config.rfidResult && values[config.rfidResult.id]) {
                const rfidResult = values[config.rfidResult.id].value;
                updateRfidResult(rfidResult);
                operationManager.clearOperation('rfidScan');
            }
            
            // Update RFID list
            if (config.rfidList && values[config.rfidList.id]) {
                const rfidList = values[config.rfidList.id].value;
                parseRfidList(rfidList);
            }
            
            // Update tries remaining
            if (config.triesRemaining && values[config.triesRemaining.id]) {
                const triesValue = values[config.triesRemaining.id].value;
                updateTriesRemaining(triesValue);
            }
            
            // Update camera status
            if (config.camStatus && values[config.camStatus.id]) {
                const camValue = values[config.camStatus.id].value;
                updateCameraStatus(camValue === 1);
                operationManager.clearOperation('cameraCapture');
            }
            
            // 🆕 AUTO IP DETECTION - Update camera IP
            if (config.camIP && values[config.camIP.id]) {
                const cameraIP = values[config.camIP.id].value;
                if (cameraIP && cameraIP !== "0.0.0.0") {
                    updateCameraIP(cameraIP);
                }
            }
        }

        // Update tries remaining with LOCKOUT LOGIC
        function updateTriesRemaining(tries) {
            systemState.triesRemaining = tries;
            elements.triesCount.textContent = tries;
            
            // Update visual state based on tries remaining
            elements.triesRemaining.className = 'tries-remaining';
            elements.triesCount.className = 'tries-count';
            
            if (tries <= 0) {
                // System lockout
                systemState.isSystemLocked = true;
                elements.triesRemaining.classList.add('danger');
                elements.triesCount.classList.add('danger');
                elements.lockoutMessage.style.display = 'block';
                
                // Lock scan sections
                document.getElementById('rfidDetectSection').classList.add('locked');
                
                // Disable scan buttons
                elements.btnRfidScan.disabled = true;
                
                // Update security status
                elements.securityStatus.className = 'security-status alert';
                elements.securityStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>System Locked</span>';
                
                alertManager.show(null, '🔒 Hệ thống đã bị khóa do quá số lần thử!', 'danger', 0);
            } else if (tries <= 1) {
                elements.triesRemaining.classList.add('danger');
                elements.triesCount.classList.add('danger');
                alertManager.show(null, `⚠️ Chỉ còn ${tries} lần thử!`, 'warning');
            } else if (tries <= 2) {
                elements.triesRemaining.classList.add('warning');
                elements.triesCount.classList.add('warning');
            } else {
                // Normal state
                systemState.isSystemLocked = false;
                elements.lockoutMessage.style.display = 'none';
                
                // Unlock scan sections
                document.getElementById('rfidDetectSection').classList.remove('locked');
                
                // Enable scan buttons
                elements.btnRfidScan.disabled = false;
                
                // Update security status
                elements.securityStatus.className = 'security-status armed';
                elements.securityStatus.innerHTML = '<i class="fas fa-shield-alt"></i><span>System Armed</span>';
            }
        }

        // 🆕 Update camera IP from ESP32-CAM auto-detection
        function updateCameraIP(ipAddress) {
            console.log('Camera IP detected:', ipAddress);
            
            // Update system state
            systemState.cameraStreamUrl = `http://${ipAddress}/stream`;
            
            // Update display
            elements.cameraIpDisplay.textContent = `Stream: http://${ipAddress}/stream`;
            
            // Update camera status to online with new IP
            updateCameraStatus(true, ipAddress);
            
            // Auto-start streaming with new IP
            setTimeout(() => {
                refreshCameraStream();
                alertManager.show(null, `📹 Camera tự động kết nối: ${ipAddress}`, 'success');
            }, 1000);
        }

        // Update camera status with ALWAYS-ON STREAMING
        function updateCameraStatus(online, ipAddress = null) {
            systemState.cameraOnline = online;
            
            if (online) {
                elements.cameraStatusIndicator.className = 'camera-status-indicator online';
                elements.cameraStatusText.textContent = 'Camera Online (Streaming)';
                document.querySelector('.camera-status-dot').className = 'camera-status-dot online';
                
                if (ipAddress) {
                    elements.cameraIpDisplay.textContent = `Stream: http://${ipAddress}/stream`;
                    systemState.cameraStreamUrl = `http://${ipAddress}/stream`;
                }
                
                elements.btnRefreshStream.disabled = false;
            } else {
                elements.cameraStatusIndicator.className = 'camera-status-indicator offline';
                elements.cameraStatusText.textContent = 'Camera Offline';
                document.querySelector('.camera-status-dot').className = 'camera-status-dot offline';
                elements.cameraIpDisplay.textContent = 'Stream: Chờ kết nối...';
                
                elements.btnRefreshStream.disabled = true;
                
                // Show offline message
                elements.cameraFeed.innerHTML = `
                    <div class="camera-placeholder">
                        <i class="fas fa-camera-slash"></i>
                        <div>Camera không trực tuyến</div>
                        <div style="font-size: 14px; margin-top: 10px; opacity: 0.7;">
                            Kiểm tra kết nối ESP32-CAM
                        </div>
                    </div>
                `;
            }
        }

        // Reset capture button
        function resetCaptureButton() {
            elements.btnCapture.innerHTML = '<i class="fas fa-camera"></i><span>Chụp Thủ Công</span>';
            elements.btnCapture.disabled = false;
        }

        // Update door status and visual
        function updateDoorStatus(status) {
            const statusMap = {
                0: { text: 'Đóng', class: 'status-closed' },
                1: { text: 'Mở', class: 'status-open' },
                2: { text: 'Đang Mở', class: 'status-opening' },
                3: { text: 'Đang Đóng', class: 'status-closing' }
            };
            
            const statusInfo = statusMap[status] || statusMap[0];
            
            elements.doorStatusText.textContent = statusInfo.text;
            elements.doorStatus.className = `door-status ${statusInfo.class}`;
            
            // Update visual
            elements.doorPanel.classList.remove('open');
            if (status === 1) {
                elements.doorPanel.classList.add('open');
            } else if (status === 2) {
                setTimeout(() => elements.doorPanel.classList.add('open'), 500);
            }
            
            // Update button states
            elements.btnOpen.disabled = (status === 1 || status === 2);
            elements.btnClose.disabled = (status === 0 || status === 3);
            
            systemState.doorStatus = status;
            
            // Add to history for door state changes
            if (status === 1 || status === 0) {
                const action = status === 1 ? 'Mở cửa' : 'Đóng cửa';
                addToHistory('🚪 Thủ công', 'MANUAL', 'System', '✅ Thành công', action);
            }
        }

        // Update motion detection
        function updateMotionStatus(detected) {
            const motionTargets = document.querySelector('.motion-targets');
            
            if (detected) {
                elements.motionIndicator.className = 'motion-indicator motion-detected';
                elements.motionText.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Phát hiện chuyển động!';
                motionTargets.classList.add('motion-active');
                elements.radarSweep.classList.add('scanning');
                
                // Update security status
                elements.securityStatus.className = 'security-status alert';
                elements.securityStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Motion Alert</span>';
                
                alertManager.show(null, '⚠️ Phát hiện chuyển động tại cửa!', 'warning');
                
                // Auto capture if camera is online
                if (systemState.cameraOnline && actions.cameraCapture) {
                    setTimeout(() => {
                        eraWidget.triggerAction(actions.cameraCapture.action, 1);
                        alertManager.show(null, '📸 Tự động chụp ảnh do phát hiện chuyển động', 'info');
                    }, 1000);
                }
                
                // Add to history
                addToHistory('🎯 Cảm biến', 'PIR-001', 'Motion Sensor', '⚠️ Phát hiện', 'Cảnh báo gửi');
            } else {
                elements.motionIndicator.className = 'motion-indicator motion-clear';
                elements.motionText.innerHTML = '<i class="fas fa-shield-alt"></i> Không có chuyển động';
                motionTargets.classList.remove('motion-active');
                elements.radarSweep.classList.remove('scanning');
                
                // Reset security status if not locked
                if (!systemState.isSystemLocked) {
                    elements.securityStatus.className = 'security-status armed';
                    elements.securityStatus.innerHTML = '<i class="fas fa-shield-alt"></i><span>System Armed</span>';
                }
            }
            
            systemState.motionDetected = detected;
        }

        // Update RFID result with ENHANCED PROCESSING
        function updateRfidResult(resultCode, cardData = null) {
            let resultText = '';
            
            switch(resultCode) {
                case 1: // Success
                    if (cardData) {
                        resultText = `Thành công: ${cardData.name} (${cardData.uid})`;
                        addToHistory('🎫 RFID', cardData.uid, cardData.name, '✅ Thành công', 'Mở cửa');
                        alertManager.show(null, `✅ Truy cập thành công: ${cardData.name}`, 'success');
                        // Auto open door
                        if (actions.openDoor) {
                            setTimeout(() => {
                                eraWidget.triggerAction(actions.openDoor.action, 1);
                            }, 500);
                        }
                        updateTriesRemaining(3); // Reset tries
                    } else {
                        resultText = 'Quét thành công';
                    }
                    break;
                case 0: // Stopped
                    resultText = 'Đã dừng quét';
                    break;
                case -1: // Unknown
                    if (cardData) {
                        resultText = `Thẻ không được nhận dạng: ${cardData.uid}`;
                        addToHistory('🎫 RFID', cardData.uid, 'Unknown', '❌ Thất bại', 'Từ chối');
                        alertManager.show(null, '❌ Thẻ RFID không được nhận dạng', 'danger');
                        updateTriesRemaining(Math.max(0, systemState.triesRemaining - 1));
                    } else {
                        resultText = 'Thẻ không được nhận dạng';
                    }
                    break;
                case -2: // Max tries
                    resultText = 'Đã vượt quá số lần thử cho phép';
                    alertManager.show(null, '🔒 Hệ thống bị khóa do quá số lần thử!', 'danger');
                    break;
                case 2: // Added
                    resultText = 'Đã thêm thẻ thành công';
                    updateRfidList(); // Refresh list
                    break;
                case 3: // Removed
                    resultText = 'Đã xóa thẻ thành công';
                    updateRfidList(); // Refresh list
                    break;
                default:
                    resultText = `Kết quả: ${resultCode}`;
            }
            
            elements.rfidResult.innerHTML = `
                <div style="padding: 12px; border-radius: 10px; background: var(--surface-light);">
                    <strong>Kết quả RFID:</strong> ${resultText}
                </div>
            `;
            
            // Reset scan button
            resetRfidScanButton();
        }

        // Parse and update RFID list
        function parseRfidList(jsonString) {
            try {
                const parsedList = JSON.parse(jsonString);
                if (Array.isArray(parsedList)) {
                    systemState.rfidList = parsedList.map(item => ({
                        uid: item.uid,
                        name: item.name
                    }));
                    updateRfidList();
                }
            } catch (error) {
                console.error('Error parsing RFID list:', error);
                alertManager.show(null, '❌ Lỗi xử lý danh sách RFID', 'danger');
            }
        }

        // Update RFID list display
        function updateRfidList() {
            if (systemState.rfidList.length === 0) {
                elements.rfidTable.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                        <i class="fas fa-id-card" style="font-size: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                        <p>Chưa có thẻ RFID nào được lưu</p>
                    </div>
                `;
                return;
            }
            
            elements.rfidTable.innerHTML = systemState.rfidList.map(card => `
                <div class="list-item">
                    <div class="list-item-info">
                        <i class="fas fa-id-card"></i>
                        <span><strong>${card.uid}</strong> - ${card.name}</span>
                    </div>
                    <button class="delete-btn" onclick="deleteRfidCard('${card.uid}')">
                        <i class="fas fa-trash"></i>
                        <span>Xóa</span>
                    </button>
                </div>
            `).join('');
        }

        // Delete RFID card
        function deleteRfidCard(uid) {
            if (systemState.isSystemLocked) return;
            
            const card = systemState.rfidList.find(c => c.uid === uid);
            if (!card) return;
            
            if (!confirm(`Xác nhận xóa thẻ RFID "${card.name}" (UID: ${uid})?`)) return;
            
            if (actions.rfidRemove) {
                // Send payload before remove
                eraWidget.send(9, uid); // V9 - payloadID (UID for RFID)
                
                setTimeout(() => {
                    eraWidget.triggerAction(actions.rfidRemove.action, 4);
                }, 100);
            } else {
                // Test mode - remove from list
                systemState.rfidList = systemState.rfidList.filter(c => c.uid !== uid);
                updateRfidList();
                alertManager.show(null, `🗑️ Đã xóa thẻ RFID: ${card.name}`, 'success');
            }
        }

        // Reset RFID scan button
        function resetRfidScanButton() {
            elements.btnRfidScan.innerHTML = '<i class="fas fa-id-card"></i><span>Bắt Đầu Quét</span>';
            elements.btnRfidScan.disabled = systemState.isSystemLocked;
            elements.btnRfidStop.style.display = 'none';
            document.getElementById('rfidDetectSection').classList.remove('detecting');
            
            elements.rfidDetectionStatus.textContent = systemState.isSystemLocked ? 
                'Hệ thống đã bị khóa' : 'Nhấn nút để bắt đầu quét thẻ RFID';
            elements.rfidDetectionStatus.style.background = systemState.isSystemLocked ? 
                'var(--danger-color)' : 'var(--surface-light)';
            elements.rfidDetectionStatus.style.color = systemState.isSystemLocked ? 
                'white' : 'var(--text-primary)';
        }

        // Add entry to history
        function addToHistory(method, id, name, result, action) {
            const now = new Date();
            const timestamp = now.toLocaleString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const historyItem = {
                timestamp,
                method,
                id,
                name,
                result,
                action
            };
            
            systemState.accessHistory.unshift(historyItem);
            
            // Keep only last 100 entries
            if (systemState.accessHistory.length > 100) {
                systemState.accessHistory = systemState.accessHistory.slice(0, 100);
            }
            
            updateHistoryTable();
        }

        // Update history table
        function updateHistoryTable() {
            if (systemState.accessHistory.length === 0) return;
            
            const newRows = systemState.accessHistory.slice(0, 20).map(item => {
                const methodClass = item.method.includes('RFID') ? 'rfid' : 
                                   item.method.includes('Cảm biến') ? 'motion' : 'rfid';
                const methodIcon = item.method.includes('RFID') ? 'id-card' : 
                                  item.method.includes('Cảm biến') ? 'radar' :
                                  item.method.includes('Thủ công') ? 'hand-paper' : 'id-card';
                
                return `
                    <tr>
                        <td>${item.timestamp}</td>
                        <td>
                            <span class="method-badge method-${methodClass}">
                                <i class="fas fa-${methodIcon}"></i>
                                ${item.method}
                            </span>
                        </td>
                        <td><code>${item.id}</code></td>
                        <td>${item.name}</td>
                        <td>
                            <span class="status-badge status-${item.result.includes('Thành công') ? 'success' : 'failed'}">
                                <i class="fas fa-${item.result.includes('Thành công') ? 'check' : 'times'}"></i>
                                ${item.result}
                            </span>
                        </td>
                        <td><span class="action-badge">${item.action}</span></td>
                    </tr>
                `;
            }).join('');
            
            // Keep existing demo data and add new entries
            const existingRows = elements.historyTableBody.innerHTML;
            if (existingRows.includes('John Doe')) {
                elements.historyTableBody.innerHTML = newRows + existingRows;
            } else {
                elements.historyTableBody.innerHTML = newRows;
            }
        }

        // FIXED Apply history filter
        function applyHistoryFilter(date, method, result) {
            console.log('Applying filter:', { date, method, result });
            
            // Get all rows including demo data
            const allRows = Array.from(elements.historyTableBody.querySelectorAll('tr'));
            let filteredRows = [...allRows];
            
            // Apply date filter
            if (date) {
                const filterDate = new Date(date);
                const filterDateStr = filterDate.toLocaleDateString('vi-VN');
                
                filteredRows = filteredRows.filter(row => {
                    const timestampCell = row.querySelector('td:first-child');
                    if (!timestampCell) return false;
                    
                    const timestamp = timestampCell.textContent.trim();
                    // Extract date part from timestamp (YYYY-MM-DD format)
                    const rowDatePart = timestamp.split(' ')[0]; // Get date part
                    const rowDate = new Date(rowDatePart.split('-').reverse().join('-')); // Convert DD-MM-YYYY to MM-DD-YYYY
                    
                    return rowDate.toDateString() === filterDate.toDateString();
                });
            }
            
            // Apply method filter
            if (method) {
                filteredRows = filteredRows.filter(row => {
                    const methodCell = row.querySelector('.method-badge');
                    if (!methodCell) return false;
                    
                    const methodText = methodCell.textContent.toLowerCase().trim();
                    switch (method) {
                        case 'rfid':
                            return methodText.includes('rfid');
                        case 'motion':
                            return methodText.includes('cảm biến') || methodText.includes('sensor');
                        case 'manual':
                            return methodText.includes('thủ công') || methodText.includes('manual');
                        default:
                            return true;
                    }
                });
            }
            
            // Apply result filter
            if (result) {
                filteredRows = filteredRows.filter(row => {
                    const statusCell = row.querySelector('.status-badge');
                    if (!statusCell) return false;
                    
                    const statusText = statusCell.textContent.toLowerCase().trim();
                    if (result === 'success') {
                        return statusText.includes('thành công') || statusText.includes('success');
                    } else if (result === 'failed') {
                        return statusText.includes('thất bại') || statusText.includes('failed');
                    }
                    return true;
                });
            }
            
            // Clear table and show filtered results
            elements.historyTableBody.innerHTML = '';
            
            if (filteredRows.length === 0) {
                elements.historyTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            <i class="fas fa-search" style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;"></i>
                            <div>Không có dữ liệu phù hợp với bộ lọc</div>
                            <div style="font-size: 12px; margin-top: 4px;">Thử thay đổi tiêu chí lọc</div>
                        </td>
                    </tr>
                `;
            } else {
                filteredRows.forEach(row => {
                    elements.historyTableBody.appendChild(row);
                });
            }
            
            alertManager.show(null, `📊 Hiển thị ${filteredRows.length} kết quả`, 'info', 3000);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Smart Door Dashboard v5.0 - RFID Only initialized');
            
            // Initialize UI and enable controls
            initializeUI();
            
            // Bind event listeners for test mode
            bindEventListeners();
            
            // Test focus on first input
            setTimeout(() => {
                const firstInput = document.querySelector('.input-field');
                if (firstInput) {
                    firstInput.focus();
                    console.log('First input focused for testing');
                }
            }, 2000);
            
            // Periodic system health check
            setInterval(() => {
                if (systemState.isConnected) {
                    // Check camera status periodically
                    if (systemState.cameraOnline && !systemState.isStreaming) {
                        // Auto refresh stream if camera is online but not streaming
                        refreshCameraStream();
                    }
                    
                    // Auto-reset tries after 5 minutes if locked
                    if (systemState.isSystemLocked) {
                        setTimeout(() => {
                            updateTriesRemaining(3);
                            alertManager.show(null, '🔓 Hệ thống đã tự động mở khóa', 'success');
                        }, 300000); // 5 minutes
                    }
                }
            }, 30000); // Check every 30 seconds
            
            // Auto-clear old alerts every minute
            setInterval(() => {
                // Keep only recent alerts (max 5)
                if (alertManager.alerts.size > 5) {
                    const alertIds = Array.from(alertManager.alerts.keys());
                    const oldAlerts = alertIds.slice(0, alertIds.length - 5);
                    oldAlerts.forEach(id => alertManager.remove(id));
                }
            }, 60000); // Every minute
        });

        // Global functions for delete buttons
        window.deleteRfidCard = deleteRfidCard;
        
        // Global access for debugging
        window.systemState = systemState;
        window.alertManager = alertManager;
        window.operationManager = operationManager;
        window.eraWidget = eraWidget;
        
        console.log('🚀 Smart Door Dashboard v5.0 - RFID Only Version Ready!');
    </script>
</body>
</html>
